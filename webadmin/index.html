<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{WEBADMIN_TITLE}} ‚Ä¢ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0b0d;
            --bg-secondary: #141519;
            --bg-tertiary: #1c1d24;
            --bg-hover: #25262f;
            --text-primary: #e4e4e7;
            --text-secondary: #9ca3af;
            --text-tertiary: #6b7280;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: rgba(255, 255, 255, 0.08);
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-animation {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            opacity: 0.3;
            background: radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 20%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            animation: bgShift 20s ease-in-out infinite;
        }

        @keyframes bgShift {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(-20px, -20px) scale(1.05); }
            50% { transform: translate(20px, -30px) scale(1.1); }
            75% { transform: translate(-30px, 20px) scale(1.05); }
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: var(--accent-gradient);
            opacity: 0.1;
            filter: blur(100px);
        }

        .logo {
            padding: 28px 24px;
            border-bottom: 1px solid var(--border);
            position: relative;
            z-index: 1;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            background: var(--accent-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo .status {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 10px var(--success); }
            50% { box-shadow: 0 0 20px var(--success), 0 0 30px var(--success); }
            100% { box-shadow: 0 0 10px var(--success); }
        }

        .nav {
            flex: 1;
            padding: 24px 16px;
            overflow-y: auto;
            position: relative;
            z-index: 1;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-tertiary);
            padding: 0 12px;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
            margin-bottom: 4px;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: var(--accent-gradient);
            opacity: 0.1;
            transition: width 0.3s ease;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transform: translateX(4px);
        }

        .nav-item:hover::before {
            width: 100%;
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--accent-primary);
            font-weight: 500;
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 20px;
            background: var(--accent-primary);
            border-radius: 0 3px 3px 0;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--accent-primary);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 20px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .search-box {
            position: relative;
            width: 400px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            opacity: 0.5;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .header-btn:hover {
            background: var(--bg-hover);
            transform: translateY(-2px);
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 18px;
            height: 18px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-menu:hover {
            background: var(--bg-hover);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--accent-gradient);
            display: flex;
            align.items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: white;
        }

        .content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--accent-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-icon.users { background: linear-gradient(135deg, #667eea, #764ba2); }
        .stat-icon.money { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .stat-icon.servers { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .stat-icon.chart { background: linear-gradient(135deg, #43e97b, #38f9d7); }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.05);
        }

        .stat-change.positive {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .stat-change.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
            min-height: 320px;
            position: relative;
            overflow: hidden;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            background: var(--accent-gradient);
            opacity: 0.05;
            filter: blur(100px);
            border-radius: 50%;
        }

        .chart-placeholder {
            text-align: center;
            color: var(--text-tertiary);
        }

        .chart-bars {
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: flex-start;
            gap: 16px;
            height: 240px;
            padding: 24px 12px 12px;
        }

        .chart-bar {
            position: relative;
            flex: 1;
            min-width: 32px;
            border-radius: 10px 10px 0 0;
            background: linear-gradient(180deg, rgba(99, 102, 241, 0.85), rgba(139, 92, 246, 0.4));
            overflow: hidden;
        }

        .chart-bar-value {
            position: absolute;
            top: -28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chart-bar-label {
            position: absolute;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: var(--text-tertiary);
            white-space: nowrap;
        }

        .quick-actions {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .action-btn.primary {
            background: var(--accent-gradient);
            color: white;
            border: none;
        }

        .action-btn:hover {
            background: var(--bg-tertiary);
            transform: translateY(-2px);
        }

        .action-btn.primary:hover {
            opacity: 0.95;
            transform: translateY(-2px);
        }

        .servers-section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .server-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .server-card.expanded {
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: var(--shadow);
        }

        .server-card-header {
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .server-card-header:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .server-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .server-flag {
            font-size: 32px;
        }

        .server-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .server-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 12px;
            background: rgba(99, 102, 241, 0.12);
            color: var(--accent-primary);
        }

        .server-status-badge.offline {
            background: rgba(239, 68, 68, 0.12);
            color: var(--danger);
        }

        .server-stats {
            display: flex;
            gap: 32px;
            align-items: center;
        }

        .server-stat {
            text-align: center;
        }

        .server-stat-value {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .server-stat-label {
            font-size: 12px;
            color: var(--text-tertiary);
            text-transform: uppercase;
        }

        .expand-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: var(--bg-tertiary);
            transition: transform 0.3s ease;
        }

        .server-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .server-expanded-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            border-top: 1px solid var(--border);
        }

        .server-card.expanded .server-expanded-content {
            max-height: 400px;
        }

        .server-expanded-inner {
            padding: 20px 24px 24px;
        }

        .server-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .server-detail {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(99, 102, 241, 0.12);
        }

        .server-detail-title {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-tertiary);
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        .server-detail-value {
            font-size: 16px;
            font-weight: 600;
        }

        .server-description {
            margin-top: 16px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 32px;
        }

        .table-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .table-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: rgba(255, 255, 255, 0.02);
        }

        th, td {
            padding: 16px 24px;
            text-align: left;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        th {
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
        }

        tbody tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .user-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar-small {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .user-id {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
        }

        .status-badge.trial {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-badge.expired {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .table-actions-cell {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .icon-btn:hover {
            background: var(--bg-hover);
            transform: scale(1.1);
        }
        .section-block {
            margin-bottom: 48px;
        }

        .section-header {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 16px;
        }

        .section-header h2 {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .section-header p {
            color: var(--text-secondary);
            max-width: 520px;
            line-height: 1.5;
        }

        .section-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            align-items: center;
        }

        .section-controls input,
        .section-controls select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 10px 14px;
            color: var(--text-primary);
            font-size: 14px;
            min-width: 180px;
        }

        .section-controls input:focus,
        .section-controls select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .section-controls .action-btn {
            min-width: 120px;
        }

        .table-header.compact {
            padding: 16px 24px;
        }

        .pagination {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            background: var(--bg-tertiary);
            border-top: 1px solid var(--border);
        }

        .pagination-btn {
            padding: 8px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--bg-hover);
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-info {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .info-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            line-height: 1.6;
        }

        .backup-result {
            margin-top: 16px;
            font-size: 14px;
            color: var(--text-secondary);
            word-break: break-word;
        }

        .backup-result a {
            color: var(--accent-primary);
        }

        .status-badge.success {
            background: rgba(16, 185, 129, 0.12);
            color: var(--success);
        }

        .status-badge.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }
        .settings-section {
            margin-bottom: 48px;
        }

        .settings-section h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .settings-section p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .settings-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .setting-category {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }

        .setting-category summary {
            list-style: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 24px;
            font-weight: 600;
            transition: background 0.2s ease;
        }

        .setting-category summary::-webkit-details-marker {
            display: none;
        }

        .setting-category[open] summary {
            background: rgba(99, 102, 241, 0.05);
        }

        .settings-count {
            font-size: 12px;
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
            padding: 4px 10px;
            border-radius: 999px;
        }

        .setting-items {
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .setting-item {
            display: grid;
            grid-template-columns: minmax(220px, 1fr) minmax(200px, 1fr) 160px;
            gap: 16px;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .setting-key {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .setting-value {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .setting-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .setting-button {
            padding: 8px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .setting-button:hover:enabled {
            background: var(--bg-hover);
        }

        .setting-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .setting-override {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
            width: fit-content;
        }

        .settings-empty {
            padding: 20px 24px;
            color: var(--text-secondary);
        }

        .settings-empty small {
            color: var(--text-tertiary);
        }

        .bot-control {
            position: relative;
        }

        .bot-control-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .bot-control-btn:hover {
            background: var(--bg-hover);
        }

        .bot-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        .bot-status.paused {
            background: var(--warning);
            box-shadow: 0 0 10px var(--warning);
        }

        .bot-status.stopped {
            background: var(--danger);
            box-shadow: 0 0 10px var(--danger);
        }

        .bot-dropdown {
            position: absolute;
            right: 0;
            top: calc(100% + 8px);
            width: 240px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 8px;
            display: none;
            flex-direction: column;
            gap: 4px;
            box-shadow: var(--shadow);
            z-index: 10;
        }

        .bot-dropdown.open {
            display: flex;
        }

        .bot-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s ease;
            color: var(--text-primary);
        }

        .bot-dropdown-item:hover {
            background: var(--bg-tertiary);
        }

        .bot-dropdown-item.warning {
            color: var(--warning);
        }

        .bot-dropdown-item.danger {
            color: var(--danger);
        }

        .bot-dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        .auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 11, 13, 0.85);
            backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 32px;
            width: min(420px, 92%);
            box-shadow: var(--shadow);
        }

        .auth-modal h2 {
            font-size: 22px;
            margin-bottom: 8px;
            text-align: center;
        }

        .auth-modal p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            text-align: center;
        }

        .auth-modal input {
            width: 100%;
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .auth-modal button {
            margin-top: 18px;
            width: 100%;
            padding: 14px 18px;
            border-radius: 12px;
            border: none;
            background: var(--accent-gradient);
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .auth-error {
            color: var(--danger);
            margin-top: 12px;
            text-align: center;
            min-height: 20px;
        }

        .toast-container {
            position: fixed;
            right: 24px;
            bottom: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 2100;
        }

        .toast {
            min-width: 220px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 18px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .toast.success {
            border-color: rgba(16, 185, 129, 0.5);
        }

        .toast.error {
            border-color: rgba(239, 68, 68, 0.5);
        }

        .toast.warning {
            border-color: rgba(245, 158, 11, 0.5);
        }

        .maintenance-label {
            font-weight: 600;
            color: var(--accent-primary);
        }

        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                transform: translateX(-100%);
                z-index: 1000;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .search-box {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .setting-item {
                grid-template-columns: 1fr;
                gap: 12px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
<div class="bg-animation"></div>
<div id="auth-overlay" class="auth-overlay hidden">
    <div class="auth-modal">
        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
        <p>–í–≤–µ–¥–∏—Ç–µ –∞–¥–º–∏–Ω-—Ç–æ–∫–µ–Ω –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
        <form id="login-form">
            <input id="login-token" type="password" placeholder="API —Ç–æ–∫–µ–Ω" autocomplete="off" required>
            <button type="submit">–í–æ–π—Ç–∏</button>
            <div id="login-error" class="auth-error"></div>
        </form>
    </div>
</div>
<div id="toast-container" class="toast-container"></div>
<div class="container">
    <aside class="sidebar">
        <div class="logo">
            <h1>
                <span class="status"></span>
                <span id="sidebar-title">{{WEBADMIN_TITLE}}</span>
            </h1>
        </div>
        <nav class="nav">
            <div class="nav-section">
                <div class="nav-section-title">–û–±–∑–æ—Ä</div>
                <a href="#dashboard" class="nav-item active" data-section="dashboard">
                    <span class="nav-icon">üìä</span>
                    <span>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</span>
                </a>
                <a href="#transactions" class="nav-item" data-section="transactions">
                    <span class="nav-icon">üßæ</span>
                    <span>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</span>
                </a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
                <a href="#users-admin" class="nav-item" data-section="users">
                    <span class="nav-icon">üë•</span>
                    <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
                </a>
                <a href="#subscriptions" class="nav-item" data-section="subscriptions">
                    <span class="nav-icon">üí≥</span>
                    <span>–ü–æ–¥–ø–∏—Å–∫–∏</span>
                </a>
                <a href="#servers" class="nav-item" data-section="servers">
                    <span class="nav-icon">üñ•Ô∏è</span>
                    <span>–°–µ—Ä–≤–µ—Ä—ã</span>
                    <span class="nav-badge" id="nav-servers-count">‚Äî</span>
                </a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">–°–∏—Å—Ç–µ–º–∞</div>
                <a href="#settings" class="nav-item" data-section="settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞</span>
                </a>
                <a href="#backups" class="nav-item" data-section="backups">
                    <span class="nav-icon">üíæ</span>
                    <span>–ë–µ–∫–∞–ø—ã</span>
                </a>
            </div>
        </nav>
    </aside>
    <main class="main">
        <header class="header">
            <div class="header-left">
                <div class="search-box">
                    <input type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, ID, email..." id="search-input">
                </div>
            </div>
            <div class="header-right">
                <div class="bot-control">
                    <button class="bot-control-btn" id="bot-control-btn" type="button">
                        <span class="bot-status" id="bot-status-indicator"></span>
                        <span data-bot-state>–ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω</span>
                        <span class="bot-control-caret">‚ñº</span>
                    </button>
                    <div class="bot-dropdown" id="bot-dropdown">
                        <div class="bot-dropdown-item" data-action="reload-config">
                            <span>üîÑ</span>
                            <span>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é</span>
                        </div>
                        <div class="bot-dropdown-item" data-action="create-backup">
                            <span>üíæ</span>
                            <span>–°–æ–∑–¥–∞—Ç—å –±–µ–∫–∞–ø</span>
                        </div>
                        <div class="bot-dropdown-item" data-action="send-report">
                            <span>üì¨</span>
                            <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–Ω–µ–≤–Ω–æ–π –æ—Ç—á–µ—Ç</span>
                        </div>
                        <div class="bot-dropdown-divider"></div>
                        <div class="bot-dropdown-item warning" data-action="toggle-maintenance">
                            <span>üöß</span>
                            <span>–†–µ–∂–∏–º —Ç–µ—Ö—Ä–∞–±–æ—Ç: <span class="maintenance-label" data-maintenance-label>–í—ã–∫–ª</span></span>
                        </div>
                        <div class="bot-dropdown-divider"></div>
                        <div class="bot-dropdown-item danger" data-action="logout">
                            <span>üö™</span>
                            <span>–í—ã–π—Ç–∏</span>
                        </div>
                    </div>
                </div>
                <div class="user-menu" id="user-menu">
                    <div class="user-avatar" id="user-avatar">A</div>
                    <div>
                        <div style="font-size: 14px; font-weight: 500;" id="user-name">Admin</div>
                        <div style="font-size: 12px; color: var(--text-tertiary);">–°—É–ø–µ—Ä –∞–¥–º–∏–Ω</div>
                    </div>
                </div>
            </div>
        </header>
        <div class="content">
            <h1 class="page-title" id="dashboard">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
            <p class="page-subtitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è VPN –±–æ—Ç–æ–º</p>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="stat-total-users">‚Äî</div>
                            <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                        </div>
                        <div class="stat-icon users">üë•</div>
                    </div>
                    <span class="stat-change" id="stat-users-change">‚Äî</span>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="stat-revenue">‚Äî</div>
                            <div class="stat-label">–î–æ—Ö–æ–¥ –∑–∞ 30 –¥–Ω–µ–π</div>
                        </div>
                        <div class="stat-icon money">üí∞</div>
                    </div>
                    <span class="stat-change" id="stat-revenue-change">‚Äî</span>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="stat-servers">‚Äî</div>
                            <div class="stat-label">–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã</div>
                        </div>
                        <div class="stat-icon servers">üñ•Ô∏è</div>
                    </div>
                    <span class="stat-change" id="stat-servers-change">‚Äî</span>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value" id="stat-conversion">‚Äî</div>
                            <div class="stat-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è —Ç—Ä–∏–∞–ª ‚Üí –ø–ª–∞—Ç–Ω–∞—è</div>
                        </div>
                        <div class="stat-icon chart">üìà</div>
                    </div>
                    <span class="stat-change" id="stat-conversion-change">‚Äî</span>
                </div>
            </div>
            <div class="chart-container" id="revenue-chart">
                <div class="chart-placeholder">
                    <div style="font-size: 42px; margin-bottom: 12px;">üìä</div>
                    <div style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">–ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–¥–∞–∂</div>
                    <div style="font-size: 14px;">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</div>
                </div>
            </div>
            <div class="quick-actions">
                <button class="action-btn primary" data-action="refresh">
                    <span>üîÑ</span>
                    <span>–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</span>
                </button>
                <button class="action-btn" data-action="reload-config">
                    <span>‚öôÔ∏è</span>
                    <span>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é</span>
                </button>
                <button class="action-btn" data-action="create-backup">
                    <span>üíæ</span>
                    <span>–°–æ–∑–¥–∞—Ç—å –±–µ–∫–∞–ø</span>
                </button>
                <button class="action-btn" data-action="toggle-maintenance">
                    <span>üöß</span>
                    <span id="maintenance-action-label">–í–∫–ª—é—á–∏—Ç—å —Ç–µ—Ö—Ä–∞–±–æ—Ç—ã</span>
                </button>
            </div>
            <section style="margin-bottom: 32px;">
                <h2 class="servers-section-title">
                    <span>üñ•Ô∏è</span>
                    <span>–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã</span>
                    <span style="background: var(--success); color: white; font-size: 12px; padding: 4px 12px; border-radius: 20px;" id="servers-online-badge">‚Äî –æ–Ω–ª–∞–π–Ω</span>
                </h2>
                <div id="servers-list"></div>
            </section>
            <section class="table-container">
                <div class="table-header">
                    <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                    <button class="action-btn" data-action="refresh-users">
                        <span>üîÑ</span>
                        <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
                    </button>
                </div>
                <table>
                    <thead>
                    <tr>
                        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–ü–æ–¥–ø–∏—Å–∫–∞</th>
                        <th>–ë–∞–ª–∞–Ω—Å</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody id="recent-users-body">
                    <tr>
                        <td colspan="5" style="padding: 32px; text-align: center; color: var(--text-tertiary);">
                            –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                        </td>
                    </tr>
                    </tbody>
                </table>
            </section>
            <section class="section-block" id="transactions">
                <div class="section-header">
                    <div>
                        <h2>üßæ –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
                        <p>–°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø–ª–∞—Ç–µ–∂–∞–º–∏ –∏ –±–∞–ª–∞–Ω—Å–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –≤—Å–µ–º –∫–∞–Ω–∞–ª–∞–º –æ–ø–ª–∞—Ç—ã.</p>
                    </div>
                    <div class="section-controls">
                        <input id="transactions-search" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é, ID, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é">
                        <select id="transactions-type-filter">
                            <option value="all">–í—Å–µ —Ç–∏–ø—ã</option>
                            <option value="subscription_payment">–û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏</option>
                            <option value="deposit">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</option>
                            <option value="withdrawal">–°–ø–∏—Å–∞–Ω–∏–µ</option>
                            <option value="refund">–í–æ–∑–≤—Ä–∞—Ç</option>
                            <option value="referral_reward">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ</option>
                        </select>
                        <select id="transactions-status-filter">
                            <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                            <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                            <option value="pending">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                        </select>
                        <button class="action-btn" id="transactions-apply-filter">
                            <span>üîç</span>
                            <span>–ü—Ä–∏–º–µ–Ω–∏—Ç—å</span>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <div class="table-header compact">
                        <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                        <tr>
                            <th>–î–∞—Ç–∞</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–¢–∏–ø</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        </tr>
                        </thead>
                        <tbody id="transactions-body">
                        <tr>
                            <td colspan="6" style="padding: 32px; text-align: center; color: var(--text-tertiary);">
                                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <div class="pagination" id="transactions-pagination">
                        <button class="pagination-btn" id="transactions-prev">–ù–∞–∑–∞–¥</button>
                        <span class="pagination-info" id="transactions-page-info">–°—Ç—Ä. 1</span>
                        <button class="pagination-btn" id="transactions-next">–í–ø–µ—Ä–µ–¥</button>
                    </div>
                </div>
            </section>
            <section class="section-block" id="users-admin">
                <div class="section-header">
                    <div>
                        <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
                        <p>–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∏ –Ω–∞—Ö–æ–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —É–ø—Ä–∞–≤–ª—è–π—Ç–µ –±–∞–ª–∞–Ω—Å–æ–º –∏ —Å—Ç–∞—Ç—É—Å–æ–º –ø–æ–¥–ø–∏—Å–∫–∏.</p>
                    </div>
                    <div class="section-controls">
                        <input id="users-admin-search" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, username –∏–ª–∏ ID">
                        <button class="action-btn" id="users-admin-apply">
                            <span>üîç</span>
                            <span>–ù–∞–π—Ç–∏</span>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <div class="table-header compact">
                        <h3>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                        <tr>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–ü–æ–¥–ø–∏—Å–∫–∞</th>
                            <th>–ë–∞–ª–∞–Ω—Å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–°–æ–∑–¥–∞–Ω</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody id="users-admin-body">
                        <tr>
                            <td colspan="6" style="padding: 32px; text-align: center; color: var(--text-tertiary);">
                                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <div class="pagination" id="users-admin-pagination">
                        <button class="pagination-btn" id="users-admin-prev">–ù–∞–∑–∞–¥</button>
                        <span class="pagination-info" id="users-admin-page-info">–°—Ç—Ä. 1</span>
                        <button class="pagination-btn" id="users-admin-next">–í–ø–µ—Ä–µ–¥</button>
                    </div>
                </div>
            </section>
            <section class="section-block" id="subscriptions">
                <div class="section-header">
                    <div>
                        <h2>üí≥ –ü–æ–¥–ø–∏—Å–∫–∏</h2>
                        <p>–ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –∏—Å—Ç–µ–∫–∞—é—â–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏, —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ–º.</p>
                    </div>
                    <div class="section-controls">
                        <select id="subscriptions-status-filter">
                            <option value="all">–í—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏</option>
                            <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                            <option value="trial">–¢—Ä–∏–∞–ª—ã</option>
                            <option value="expired">–ò—Å—Ç–µ–∫—à–∏–µ</option>
                            <option value="disabled">–û—Ç–∫–ª—é—á–µ–Ω–Ω—ã–µ</option>
                        </select>
                    </div>
                </div>
                <div class="table-container">
                    <div class="table-header compact">
                        <h3>–¢–µ–∫—É—â–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                        <tr>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–û–∫–æ–Ω—á–∞–Ω–∏–µ</th>
                            <th>–û—Å—Ç–∞–ª–æ—Å—å</th>
                            <th>–õ–∏–º–∏—Ç—ã</th>
                            <th>–ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ</th>
                        </tr>
                        </thead>
                        <tbody id="subscriptions-body">
                        <tr>
                            <td colspan="6" style="padding: 32px; text-align: center; color: var(--text-tertiary);">
                                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                            </td>
                        </tr>
                        </tbody>
                    </table>
                    <div class="pagination" id="subscriptions-pagination">
                        <button class="pagination-btn" id="subscriptions-prev">–ù–∞–∑–∞–¥</button>
                        <span class="pagination-info" id="subscriptions-page-info">–°—Ç—Ä. 1</span>
                        <button class="pagination-btn" id="subscriptions-next">–í–ø–µ—Ä–µ–¥</button>
                    </div>
                </div>
            </section>
            <section class="section-block" id="backups">
                <div class="section-header">
                    <div>
                        <h2>üíæ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–∫–∞–ø–∞–º–∏</h2>
                        <p>–°–æ–∑–¥–∞–≤–∞–π—Ç–µ –∏ —Å–∫–∞—á–∏–≤–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç–∞.</p>
                    </div>
                    <div class="section-controls">
                        <button class="action-btn primary" id="backup-create">
                            <span>üõü</span>
                            <span>–°–æ–∑–¥–∞—Ç—å –±–µ–∫–∞–ø</span>
                        </button>
                    </div>
                </div>
                <div class="info-card" id="backup-info">
                    <p>–ù–∞–∂–º–∏—Ç–µ ¬´–°–æ–∑–¥–∞—Ç—å –±–µ–∫–∞–ø¬ª, —á—Ç–æ–±—ã –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ. –°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏.</p>
                    <div class="backup-result" id="backup-result"></div>
                </div>
            </section>
            <section class="settings-section" id="settings">
                <h2>‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞</h2>
                <p>–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∏ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞. –ó–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.</p>
                <div id="settings-container" class="settings-container">
                    <div class="settings-empty">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–∫‚Ä¶</div>
                </div>
            </section>
        </div>
    </main>
</div>
</div>
<script>
(() => {
    const state = {
        token: localStorage.getItem('webadminToken') || '',
        health: null,
        settingsCache: new Map(),
        transactions: { limit: 20, offset: 0, total: 0, type: 'all', status: 'all', search: '' },
        usersList: { limit: 20, offset: 0, total: 0, search: '' },
        subscriptions: { limit: 20, offset: 0, total: 0, status: 'all' },
        backup: { lastResult: null },
    };

    const els = {
        authOverlay: document.getElementById('auth-overlay'),
        loginForm: document.getElementById('login-form'),
        loginToken: document.getElementById('login-token'),
        loginError: document.getElementById('login-error'),
        toastContainer: document.getElementById('toast-container'),
        botControlBtn: document.getElementById('bot-control-btn'),
        botDropdown: document.getElementById('bot-dropdown'),
        botStatusIndicator: document.getElementById('bot-status-indicator'),
        maintenanceActionLabel: document.getElementById('maintenance-action-label'),
        maintenanceLabel: document.querySelector('[data-maintenance-label]'),
        statUsers: document.getElementById('stat-total-users'),
        statUsersChange: document.getElementById('stat-users-change'),
        statRevenue: document.getElementById('stat-revenue'),
        statRevenueChange: document.getElementById('stat-revenue-change'),
        statServers: document.getElementById('stat-servers'),
        statServersChange: document.getElementById('stat-servers-change'),
        statConversion: document.getElementById('stat-conversion'),
        statConversionChange: document.getElementById('stat-conversion-change'),
        revenueChart: document.getElementById('revenue-chart'),
        serversList: document.getElementById('servers-list'),
        serversBadge: document.getElementById('servers-online-badge'),
        navServersCount: document.getElementById('nav-servers-count'),
        recentUsersBody: document.getElementById('recent-users-body'),
        settingsContainer: document.getElementById('settings-container'),
        searchInput: document.getElementById('search-input'),
        transactionsBody: document.getElementById('transactions-body'),
        transactionsPageInfo: document.getElementById('transactions-page-info'),
        transactionsPrev: document.getElementById('transactions-prev'),
        transactionsNext: document.getElementById('transactions-next'),
        transactionsTypeFilter: document.getElementById('transactions-type-filter'),
        transactionsStatusFilter: document.getElementById('transactions-status-filter'),
        transactionsSearch: document.getElementById('transactions-search'),
        transactionsApply: document.getElementById('transactions-apply-filter'),
        usersAdminBody: document.getElementById('users-admin-body'),
        usersAdminPageInfo: document.getElementById('users-admin-page-info'),
        usersAdminPrev: document.getElementById('users-admin-prev'),
        usersAdminNext: document.getElementById('users-admin-next'),
        usersAdminSearch: document.getElementById('users-admin-search'),
        usersAdminApply: document.getElementById('users-admin-apply'),
        subscriptionsBody: document.getElementById('subscriptions-body'),
        subscriptionsPageInfo: document.getElementById('subscriptions-page-info'),
        subscriptionsPrev: document.getElementById('subscriptions-prev'),
        subscriptionsNext: document.getElementById('subscriptions-next'),
        subscriptionsStatusFilter: document.getElementById('subscriptions-status-filter'),
        backupButton: document.getElementById('backup-create'),
        backupResult: document.getElementById('backup-result'),
    };

    function toLocaleCurrency(value) {
        return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(value || 0);
    }

    function toPercent(value) {
        if (value === null || value === undefined || Number.isNaN(value)) {
            return '‚Äî';
        }
        return `${value.toFixed(1)}%`;
    }

    function formatDateTime(value) {
        if (!value) {
            return '‚Äî';
        }
        try {
            return new Date(value).toLocaleString('ru-RU');
        } catch (error) {
            return value;
        }
    }

    function formatDate(value) {
        if (!value) {
            return '‚Äî';
        }
        try {
            return new Date(value).toLocaleDateString('ru-RU');
        } catch (error) {
            return value;
        }
    }

    function formatDaysLeft(days) {
        if (days === null || days === undefined) {
            return '‚Äî';
        }
        if (days <= 0) {
            return '–ò—Å—Ç–µ–∫–ª–∞';
        }
        return `${days} –¥–Ω.`;
    }

    const TRANSACTION_TYPE_LABELS = {
        deposit: '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ',
        withdrawal: '–°–ø–∏—Å–∞–Ω–∏–µ',
        subscription_payment: '–û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏',
        refund: '–í–æ–∑–≤—Ä–∞—Ç',
        referral_reward: '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å',
    };

    function formatTransactionType(type) {
        if (!type) return '‚Äî';
        return TRANSACTION_TYPE_LABELS[type] || type;
    }

    const USER_STATUS_LABELS = {
        active: '–ê–∫—Ç–∏–≤–µ–Ω',
        blocked: '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω',
        deleted: '–£–¥–∞–ª–µ–Ω',
    };

    function formatUserStatus(status) {
        if (!status) return '‚Äî';
        return USER_STATUS_LABELS[status] || status;
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        els.toastContainer.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('fade');
            setTimeout(() => toast.remove(), 200);
        }, 4000);
    }

    function showLogin(message = '') {
        els.authOverlay.classList.remove('hidden');
        els.loginError.textContent = message;
        setTimeout(() => els.loginToken.focus(), 50);
    }

    function hideLogin() {
        els.authOverlay.classList.add('hidden');
        els.loginError.textContent = '';
        els.loginToken.value = '';
    }

    async function callApi(path, { method = 'GET', body, skipAuth = false } = {}) {
        const headers = {};
        if (!skipAuth && state.token) {
            headers.Authorization = `Bearer ${state.token}`;
        }
        const options = { method, headers };
        if (body !== undefined) {
            headers['Content-Type'] = 'application/json';
            options.body = JSON.stringify(body);
        }

        const response = await fetch(path, options).catch((error) => {
            throw new Error(`–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ${error.message}`);
        });

        let payload = {};
        if (response.status !== 204) {
            try {
                payload = await response.json();
            } catch (error) {
                payload = {};
            }
        }

        if (response.status === 401 && !skipAuth) {
            state.token = '';
            localStorage.removeItem('webadminToken');
            showLogin('–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥');
            throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ');
        }

        if (!response.ok || payload.status === 'error') {
            const message = payload.message || `–û—à–∏–±–∫–∞ ${response.status}`;
            throw new Error(message);
        }

        return payload.data !== undefined ? payload.data : payload;
    }

    function applyTrend(element, value) {
        element.classList.remove('positive', 'negative');
        if (value === null || value === undefined) {
            element.textContent = '‚Äî';
            return;
        }
        const formatted = value > 0 ? `‚Üë ${value.toFixed(1)}%` : value < 0 ? `‚Üì ${(Math.abs(value)).toFixed(1)}%` : '0%';
        element.textContent = formatted;
        if (value > 0) {
            element.classList.add('positive');
        } else if (value < 0) {
            element.classList.add('negative');
        }
    }

    function countryCodeToEmoji(code) {
        if (!code) return 'üåç';
        const upper = code.trim().slice(0, 2).toUpperCase();
        return upper.replace(/./g, (char) => String.fromCodePoint(char.charCodeAt(0) + 127397));
    }

    function renderHealth(data) {
        state.health = data;
        const maintenance = data?.bot?.maintenance;
        els.botStatusIndicator.classList.remove('paused', 'stopped');
        if (maintenance) {
            els.botStatusIndicator.classList.add('paused');
        }
        if (els.maintenanceLabel) {
            els.maintenanceLabel.textContent = maintenance ? '–í–∫–ª' : '–í—ã–∫–ª';
        }
        if (els.maintenanceActionLabel) {
            els.maintenanceActionLabel.textContent = maintenance ? '–í—ã–∫–ª—é—á–∏—Ç—å —Ç–µ—Ö—Ä–∞–±–æ—Ç—ã' : '–í–∫–ª—é—á–∏—Ç—å —Ç–µ—Ö—Ä–∞–±–æ—Ç—ã';
        }
        if (data?.services?.auto_backup_enabled) {
            els.navServersCount.classList.add('active');
        }
    }

    function renderSummary(summary) {
        if (!summary) return;
        els.statUsers.textContent = summary.total_users?.toLocaleString('ru-RU') ?? '‚Äî';
        applyTrend(els.statUsersChange, summary.user_growth_percent ?? 0);
        els.statRevenue.textContent = toLocaleCurrency(summary.monthly_revenue);
        applyTrend(els.statRevenueChange, summary.monthly_revenue_change_percent ?? 0);
        els.statServers.textContent = `${summary.available_servers ?? 0} / ${summary.total_servers ?? 0}`;
        applyTrend(els.statServersChange, summary.active_servers_percent ?? 0);
        els.statConversion.textContent = toPercent(summary.conversion_rate_percent ?? 0);
        applyTrend(els.statConversionChange, summary.conversion_rate_percent ?? 0);
    }

    function renderRevenue(series) {
        if (!Array.isArray(series) || !series.length) {
            return;
        }
        const chart = document.createElement('div');
        chart.className = 'chart-bars';
        const max = Math.max(...series.map((item) => item.revenue || 0));
        series.forEach((item) => {
            const bar = document.createElement('div');
            bar.className = 'chart-bar';
            const percent = max > 0 ? Math.max((item.revenue / max) * 100, 5) : 5;
            bar.style.height = `${percent}%`;
            const value = document.createElement('div');
            value.className = 'chart-bar-value';
            value.textContent = toLocaleCurrency(item.revenue);
            const label = document.createElement('div');
            label.className = 'chart-bar-label';
            label.textContent = new Date(item.date).toLocaleDateString('ru-RU', { day: '2-digit', month: 'short' });
            bar.appendChild(value);
            bar.appendChild(label);
            chart.appendChild(bar);
        });
        els.revenueChart.innerHTML = '';
        els.revenueChart.appendChild(chart);
    }

    function renderServers(servers) {
        els.serversList.innerHTML = '';
        if (!Array.isArray(servers) || !servers.length) {
            els.serversList.innerHTML = '<div class="settings-empty">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤</div>';
            els.serversBadge.textContent = '0 –æ–Ω–ª–∞–π–Ω';
            els.navServersCount.textContent = '0';
            return;
        }
        els.serversBadge.textContent = `${servers.filter((s) => s.is_available).length} –æ–Ω–ª–∞–π–Ω`;
        els.navServersCount.textContent = servers.length.toString();
        servers.forEach((server) => {
            const card = document.createElement('div');
            card.className = 'server-card';
            const header = document.createElement('div');
            header.className = 'server-card-header';
            header.innerHTML = `
                <div class="server-info">
                    <span class="server-flag">${countryCodeToEmoji(server.country_code)}</span>
                    <div>
                        <div class="server-name">${server.name}</div>
                        <div class="server-status-badge ${server.is_available ? '' : 'offline'}">${server.status_label}</div>
                    </div>
                </div>
                <div class="server-stats">
                    <div class="server-stat">
                        <div class="server-stat-value">${server.current_users}</div>
                        <div class="server-stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    </div>
                    <div class="server-stat">
                        <div class="server-stat-value">${server.max_users ?? '‚àû'}</div>
                        <div class="server-stat-label">–õ–∏–º–∏—Ç</div>
                    </div>
                    <div class="server-stat">
                        <div class="server-stat-value">${server.capacity_percent}%</div>
                        <div class="server-stat-label">–ó–∞–ø–æ–ª–Ω–µ–Ω</div>
                    </div>
                    <div class="expand-icon">‚ñº</div>
                </div>
            `;
            const expanded = document.createElement('div');
            expanded.className = 'server-expanded-content';
            expanded.innerHTML = `
                <div class="server-expanded-inner">
                    <div class="server-details-grid">
                        <div class="server-detail">
                            <div class="server-detail-title">–¶–µ–Ω–∞</div>
                            <div class="server-detail-value">${toLocaleCurrency(server.price_rub)}</div>
                        </div>
                        <div class="server-detail">
                            <div class="server-detail-title">UUID</div>
                            <div class="server-detail-value" style="font-size: 12px; color: var(--text-tertiary);">${server.squad_uuid}</div>
                        </div>
                        <div class="server-detail">
                            <div class="server-detail-title">–°—Ç–∞—Ç—É—Å</div>
                            <div class="server-detail-value">${server.status_label}</div>
                        </div>
                    </div>
                    ${server.description ? `<div class="server-description">${server.description}</div>` : ''}
                </div>
            `;
            header.addEventListener('click', () => {
                card.classList.toggle('expanded');
            });
            card.appendChild(header);
            card.appendChild(expanded);
            els.serversList.appendChild(card);
        });
    }

    function renderUsers(users) {
        if (!Array.isArray(users) || !users.length) {
            els.recentUsersBody.innerHTML = '<tr><td colspan="5" style="padding: 32px; text-align: center; color: var(--text-tertiary);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }
        const fragment = document.createDocumentFragment();
        users.forEach((user) => {
            const row = document.createElement('tr');
            const subscription = user.subscription;
            let badgeClass = 'status-badge';
            let badgeText = '‚Äî';
            if (subscription) {
                if (subscription.is_trial) {
                    badgeClass += ' trial';
                    badgeText = '–¢—Ä–∏–∞–ª';
                } else if (subscription.status === 'expired') {
                    badgeClass += ' expired';
                    badgeText = '–ò—Å—Ç–µ–∫–ª–∞';
                } else {
                    badgeText = '–ê–∫—Ç–∏–≤–Ω–∞';
                }
            }
            const balance = toLocaleCurrency(user.balance_rub ?? 0);

            const userCell = document.createElement('td');
            const userContainer = document.createElement('div');
            userContainer.className = 'user-cell';

            const avatar = document.createElement('div');
            avatar.className = 'user-avatar-small';
            const displayName = user.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
            avatar.textContent = (displayName || 'U').charAt(0).toUpperCase();

            const info = document.createElement('div');
            info.className = 'user-info';

            const name = document.createElement('div');
            name.className = 'user-name';
            name.textContent = displayName;

            const id = document.createElement('div');
            id.className = 'user-id';
            id.textContent = `ID ${user.id ?? '‚Äî'}`;

            info.appendChild(name);
            info.appendChild(id);
            userContainer.appendChild(avatar);
            userContainer.appendChild(info);
            userCell.appendChild(userContainer);

            const statusCell = document.createElement('td');
            const statusBadge = document.createElement('span');
            statusBadge.className = 'status-badge';
            statusBadge.textContent = user.status ?? '‚Äî';
            statusCell.appendChild(statusBadge);

            const subscriptionCell = document.createElement('td');
            const subscriptionBadge = document.createElement('span');
            subscriptionBadge.className = badgeClass;
            subscriptionBadge.textContent = badgeText;
            subscriptionCell.appendChild(subscriptionBadge);

            const balanceCell = document.createElement('td');
            balanceCell.textContent = balance;

            const actionsCell = document.createElement('td');
            actionsCell.className = 'table-actions-cell';
            const viewButton = document.createElement('button');
            viewButton.className = 'icon-btn';
            viewButton.dataset.action = 'view-user';
            if (user.id != null) {
                viewButton.dataset.userId = String(user.id);
            }
            viewButton.title = '–ü–æ–¥—Ä–æ–±–Ω–µ–µ';
            viewButton.textContent = '‚ÑπÔ∏è';
            actionsCell.appendChild(viewButton);

            row.appendChild(userCell);
            row.appendChild(statusCell);
            row.appendChild(subscriptionCell);
            row.appendChild(balanceCell);
            row.appendChild(actionsCell);

            fragment.appendChild(row);
        });
        els.recentUsersBody.textContent = '';
        els.recentUsersBody.appendChild(fragment);
    }

    function createUserCell(user) {
        const cell = document.createElement('td');
        const container = document.createElement('div');
        container.className = 'user-cell';

        const avatar = document.createElement('div');
        avatar.className = 'user-avatar-small';
        const displayName = (user?.full_name || user?.username || '–ë–µ–∑ –∏–º–µ–Ω–∏').trim();
        avatar.textContent = (displayName || 'U').charAt(0).toUpperCase();

        const info = document.createElement('div');
        info.className = 'user-info';

        const name = document.createElement('div');
        name.className = 'user-name';
        name.textContent = displayName || '–ë–µ–∑ –∏–º–µ–Ω–∏';

        const id = document.createElement('div');
        id.className = 'user-id';
        const idValue = user?.id ?? user?.telegram_id ?? '‚Äî';
        id.textContent = `ID ${idValue}`;

        info.appendChild(name);
        info.appendChild(id);
        container.appendChild(avatar);
        container.appendChild(info);
        cell.appendChild(container);
        return cell;
    }

    function renderTransactions(items) {
        if (!els.transactionsBody) return;
        if (!Array.isArray(items) || !items.length) {
            els.transactionsBody.innerHTML = '<tr><td colspan="6" style="padding: 32px; text-align: center; color: var(--text-tertiary);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }

        const fragment = document.createDocumentFragment();
        items.forEach((item) => {
            const row = document.createElement('tr');

            const dateCell = document.createElement('td');
            dateCell.textContent = formatDateTime(item.created_at);
            row.appendChild(dateCell);

            row.appendChild(createUserCell(item.user));

            const typeCell = document.createElement('td');
            typeCell.textContent = formatTransactionType(item.type);
            row.appendChild(typeCell);

            const statusCell = document.createElement('td');
            const statusBadge = document.createElement('span');
            statusBadge.className = `status-badge ${item.is_completed ? 'success' : 'warning'}`;
            statusBadge.textContent = item.is_completed ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ';
            statusCell.appendChild(statusBadge);
            row.appendChild(statusCell);

            const amountCell = document.createElement('td');
            amountCell.textContent = toLocaleCurrency(item.amount_rub);
            row.appendChild(amountCell);

            const descriptionCell = document.createElement('td');
            descriptionCell.textContent = item.description || '‚Äî';
            row.appendChild(descriptionCell);

            fragment.appendChild(row);
        });

        els.transactionsBody.textContent = '';
        els.transactionsBody.appendChild(fragment);
        updateTransactionsPagination();
    }

    function updateTransactionsPagination() {
        if (!els.transactionsPageInfo) return;
        const { offset, limit, total } = state.transactions;
        const currentPage = Math.floor(offset / limit) + 1;
        const totalPages = Math.max(1, Math.ceil(total / limit || 1));
        els.transactionsPageInfo.textContent = `–°—Ç—Ä. ${Math.min(currentPage, totalPages)} –∏–∑ ${totalPages}`;
        if (els.transactionsPrev) {
            els.transactionsPrev.disabled = offset <= 0;
        }
        if (els.transactionsNext) {
            els.transactionsNext.disabled = offset + limit >= total;
        }
    }

    function renderUsersAdminTable(users) {
        if (!els.usersAdminBody) return;
        if (!Array.isArray(users) || !users.length) {
            els.usersAdminBody.innerHTML = '<tr><td colspan="6" style="padding: 32px; text-align: center; color: var(--text-tertiary);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            updateUsersAdminPagination();
            return;
        }

        const fragment = document.createDocumentFragment();
        users.forEach((user) => {
            const row = document.createElement('tr');
            row.appendChild(createUserCell(user));

            const subscriptionCell = document.createElement('td');
            if (user.subscription) {
                const badge = document.createElement('span');
                badge.className = 'status-badge';
                if (user.subscription.is_trial) {
                    badge.classList.add('trial');
                }
                if (user.subscription.status === 'expired') {
                    badge.classList.add('expired');
                }
                badge.textContent = user.subscription.status_display || (user.subscription.is_trial ? '–¢—Ä–∏–∞–ª' : '–ê–∫—Ç–∏–≤–Ω–∞');
                subscriptionCell.appendChild(badge);
                const ends = document.createElement('div');
                ends.className = 'user-id';
                ends.textContent = `–î–æ ${formatDate(user.subscription.end_date)}`;
                subscriptionCell.appendChild(ends);
            } else {
                subscriptionCell.textContent = '‚Äî';
            }
            row.appendChild(subscriptionCell);

            const balanceCell = document.createElement('td');
            balanceCell.textContent = toLocaleCurrency(user.balance_rub ?? 0);
            row.appendChild(balanceCell);

            const statusCell = document.createElement('td');
            const statusBadge = document.createElement('span');
            statusBadge.className = 'status-badge';
            if (user.status === 'blocked') {
                statusBadge.classList.add('expired');
            }
            statusBadge.textContent = formatUserStatus(user.status);
            statusCell.appendChild(statusBadge);
            row.appendChild(statusCell);

            const createdCell = document.createElement('td');
            createdCell.textContent = formatDateTime(user.created_at);
            row.appendChild(createdCell);

            const actionsCell = document.createElement('td');
            actionsCell.className = 'table-actions-cell';
            const viewButton = document.createElement('button');
            viewButton.className = 'icon-btn';
            viewButton.dataset.action = 'view-user';
            if (user.id != null) {
                viewButton.dataset.userId = String(user.id);
            }
            viewButton.title = '–ü–æ–¥—Ä–æ–±–Ω–µ–µ';
            viewButton.textContent = '‚ÑπÔ∏è';
            actionsCell.appendChild(viewButton);
            row.appendChild(actionsCell);

            fragment.appendChild(row);
        });

        els.usersAdminBody.textContent = '';
        els.usersAdminBody.appendChild(fragment);
        updateUsersAdminPagination();
    }

    function updateUsersAdminPagination() {
        if (!els.usersAdminPageInfo) return;
        const { offset, limit, total } = state.usersList;
        const currentPage = Math.floor(offset / limit) + 1;
        const totalPages = Math.max(1, Math.ceil(total / limit || 1));
        els.usersAdminPageInfo.textContent = `–°—Ç—Ä. ${Math.min(currentPage, totalPages)} –∏–∑ ${totalPages}`;
        if (els.usersAdminPrev) {
            els.usersAdminPrev.disabled = offset <= 0;
        }
        if (els.usersAdminNext) {
            els.usersAdminNext.disabled = offset + limit >= total;
        }
    }

    function renderSubscriptions(items) {
        if (!els.subscriptionsBody) return;
        if (!Array.isArray(items) || !items.length) {
            els.subscriptionsBody.innerHTML = '<tr><td colspan="6" style="padding: 32px; text-align: center; color: var(--text-tertiary);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            updateSubscriptionsPagination();
            return;
        }

        const fragment = document.createDocumentFragment();
        items.forEach((subscription) => {
            const row = document.createElement('tr');
            row.appendChild(createUserCell(subscription.user));

            const statusCell = document.createElement('td');
            const statusBadge = document.createElement('span');
            statusBadge.className = 'status-badge';
            if (subscription.is_trial) {
                statusBadge.classList.add('trial');
            }
            const isExpired =
                subscription.status === 'expired' ||
                (typeof subscription.days_left === 'number' && subscription.days_left <= 0);
            if (isExpired) {
                statusBadge.classList.add('expired');
            }
            statusBadge.textContent = subscription.status_display || '‚Äî';
            statusCell.appendChild(statusBadge);
            row.appendChild(statusCell);

            const endCell = document.createElement('td');
            endCell.textContent = formatDate(subscription.end_date);
            row.appendChild(endCell);

            const remainingCell = document.createElement('td');
            remainingCell.textContent = formatDaysLeft(subscription.days_left);
            row.appendChild(remainingCell);

            const limitsCell = document.createElement('td');
            const limit = subscription.traffic_limit_gb ?? 0;
            const used = subscription.traffic_used_gb ?? 0;
            limitsCell.textContent = `${used.toFixed(1)} / ${limit} –ì–ë ‚Ä¢ ${subscription.device_limit ?? 0} —É—Å—Ç—Ä–æ–π—Å—Ç–≤`;
            row.appendChild(limitsCell);

            const autopayCell = document.createElement('td');
            const autopayBadge = document.createElement('span');
            autopayBadge.className = `status-badge ${subscription.autopay_enabled ? 'success' : 'warning'}`;
            autopayBadge.textContent = subscription.autopay_enabled ? '–í–∫–ª—é—á–µ–Ω–æ' : '–í—ã–∫–ª—é—á–µ–Ω–æ';
            autopayCell.appendChild(autopayBadge);
            row.appendChild(autopayCell);

            fragment.appendChild(row);
        });

        els.subscriptionsBody.textContent = '';
        els.subscriptionsBody.appendChild(fragment);
        updateSubscriptionsPagination();
    }

    function updateSubscriptionsPagination() {
        if (!els.subscriptionsPageInfo) return;
        const { offset, limit, total } = state.subscriptions;
        const currentPage = Math.floor(offset / limit) + 1;
        const totalPages = Math.max(1, Math.ceil(total / limit || 1));
        els.subscriptionsPageInfo.textContent = `–°—Ç—Ä. ${Math.min(currentPage, totalPages)} –∏–∑ ${totalPages}`;
        if (els.subscriptionsPrev) {
            els.subscriptionsPrev.disabled = offset <= 0;
        }
        if (els.subscriptionsNext) {
            els.subscriptionsNext.disabled = offset + limit >= total;
        }
    }

    function updateBackupResultView(result) {
        if (!els.backupResult) return;
        state.backup.lastResult = result || null;
        if (!result) {
            els.backupResult.textContent = '';
            return;
        }
        const fragment = document.createDocumentFragment();
        if (result.message) {
            const message = document.createElement('div');
            message.textContent = result.message;
            fragment.appendChild(message);
        }
        if (result.file) {
            const link = document.createElement('a');
            link.href = result.file;
            link.target = '_blank';
            link.rel = 'noopener';
            link.textContent = '–°–∫–∞—á–∞—Ç—å –±–µ–∫–∞–ø';
            fragment.appendChild(link);
        }
        const timestamp = document.createElement('div');
        timestamp.className = 'user-id';
        timestamp.textContent = `–í—Ä–µ–º—è: ${new Date().toLocaleString('ru-RU')}`;
        fragment.appendChild(timestamp);

        els.backupResult.textContent = '';
        els.backupResult.appendChild(fragment);
    }

    async function loadTransactions({ reset = false } = {}) {
        if (!els.transactionsBody) return;
        if (reset) {
            state.transactions.offset = 0;
        }
        const params = new URLSearchParams({
            limit: String(state.transactions.limit),
            offset: String(state.transactions.offset),
        });
        if (state.transactions.type && state.transactions.type !== 'all') {
            params.set('type', state.transactions.type);
        }
        if (state.transactions.status && state.transactions.status !== 'all') {
            params.set('status', state.transactions.status);
        }
        if (state.transactions.search) {
            params.set('search', state.transactions.search);
        }

        const data = await callApi(`/api/transactions?${params.toString()}`);
        state.transactions.total = data.total ?? 0;
        state.transactions.limit = data.limit ?? state.transactions.limit;
        state.transactions.offset = data.offset ?? state.transactions.offset;
        renderTransactions(data.items || []);
    }

    async function loadUsersList({ reset = false } = {}) {
        if (!els.usersAdminBody) return;
        if (reset) {
            state.usersList.offset = 0;
        }
        const params = new URLSearchParams({
            limit: String(state.usersList.limit),
            offset: String(state.usersList.offset),
        });
        if (state.usersList.search) {
            params.set('search', state.usersList.search);
        }

        const data = await callApi(`/api/users?${params.toString()}`);
        state.usersList.total = data.total ?? 0;
        state.usersList.limit = data.limit ?? state.usersList.limit;
        state.usersList.offset = data.offset ?? state.usersList.offset;
        renderUsersAdminTable(data.items || []);
    }

    async function loadSubscriptions({ reset = false } = {}) {
        if (!els.subscriptionsBody) return;
        if (reset) {
            state.subscriptions.offset = 0;
        }
        const params = new URLSearchParams({
            limit: String(state.subscriptions.limit),
            offset: String(state.subscriptions.offset),
        });
        if (state.subscriptions.status && state.subscriptions.status !== 'all') {
            params.set('status', state.subscriptions.status);
        }

        const data = await callApi(`/api/subscriptions?${params.toString()}`);
        state.subscriptions.total = data.total ?? 0;
        state.subscriptions.limit = data.limit ?? state.subscriptions.limit;
        state.subscriptions.offset = data.offset ?? state.subscriptions.offset;
        renderSubscriptions(data.items || []);
    }

    function renderSettingsCategories(categories) {
        els.settingsContainer.innerHTML = '';
        if (!Array.isArray(categories) || !categories.length) {
            els.settingsContainer.innerHTML = '<div class="settings-empty">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫</div>';
            return;
        }
        categories.forEach((category) => {
            const details = document.createElement('details');
            details.className = 'setting-category';
            details.dataset.category = category.key;
            const summary = document.createElement('summary');
            summary.innerHTML = `<span>${category.label}</span><span class="settings-count">${category.count}</span>`;
            const itemsContainer = document.createElement('div');
            itemsContainer.className = 'setting-items';
            itemsContainer.innerHTML = '<div class="settings-empty">–û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏‚Ä¶</div>';
            details.appendChild(summary);
            details.appendChild(itemsContainer);
            details.addEventListener('toggle', async () => {
                if (details.open && !state.settingsCache.has(category.key)) {
                    await loadSettingsCategory(category.key, itemsContainer);
                }
            });
            els.settingsContainer.appendChild(details);
        });
    }

    async function loadSettingsCategory(key, container) {
        container.innerHTML = '<div class="settings-empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
        try {
            const items = await callApi(`/api/settings/category/${key}`);
            state.settingsCache.set(key, items);
            renderSettingItems(key, items, container);
        } catch (error) {
            container.innerHTML = `<div class="settings-empty">${error.message}</div>`;
        }
    }

    function renderSettingItems(categoryKey, items, container) {
        if (!items.length) {
            container.innerHTML = '<div class="settings-empty">–ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>';
            return;
        }
        const fragment = document.createDocumentFragment();
        items.forEach((item) => {
            const row = document.createElement('div');
            row.className = 'setting-item';
            row.dataset.key = item.key;
            row.innerHTML = `
                <div>
                    <div class="setting-name">${item.name}</div>
                    <div class="setting-key">${item.key}</div>
                </div>
                <div class="setting-value">
                    <span>${item.value_formatted}</span>
                    ${item.has_override ? '<span class="setting-override">–ò–∑–º–µ–Ω–µ–Ω–æ</span>' : ''}
                </div>
                <div class="setting-actions">
                    <button class="setting-button" data-action="edit-setting" data-key="${item.key}" data-category="${categoryKey}">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                    <button class="setting-button" data-action="reset-setting" data-key="${item.key}" data-category="${categoryKey}" ${item.has_override ? '' : 'disabled'}>–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
            `;
            fragment.appendChild(row);
        });
        container.innerHTML = '';
        container.appendChild(fragment);
    }

    async function editSetting(key, category) {
        const items = state.settingsCache.get(category) || [];
        const item = items.find((entry) => entry.key === key);
        if (!item) return;
        const choices = item.choices || [];
        const hint = choices.length
            ? `\n–í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:\n${choices.map((choice) => `‚Ä¢ ${choice.label} (${choice.value})`).join('\n')}`
            : '';
        const currentValue = item.value ?? '';
        const input = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è ¬´${item.name}¬ª${hint}`, currentValue);
        if (input === null) {
            return;
        }
        try {
            const payload = { value: input };
            if (input.trim().toLowerCase() === 'null' || input.trim() === '') {
                payload.value = null;
            }
            const updated = await callApi(`/api/settings/${key}`, { method: 'PUT', body: payload });
            showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
            state.settingsCache.delete(category);
            const details = els.settingsContainer.querySelector(`details[data-category="${category}"]`);
            if (details) {
                const itemsContainer = details.querySelector('.setting-items');
                await loadSettingsCategory(category, itemsContainer);
            }
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    async function resetSetting(key, category) {
        if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∫ –∑–Ω–∞—á–µ–Ω–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) {
            return;
        }
        try {
            await callApi(`/api/settings/${key}`, { method: 'DELETE' });
            showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞', 'success');
            state.settingsCache.delete(category);
            const details = els.settingsContainer.querySelector(`details[data-category="${category}"]`);
            if (details) {
                const itemsContainer = details.querySelector('.setting-items');
                await loadSettingsCategory(category, itemsContainer);
            }
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    async function viewUser(userId) {
        try {
            const details = await callApi(`/api/users/${userId}`);
            const user = details.user;
            const transactions = details.transactions || [];
            const lastTransaction = transactions[0];
            const info = [
                `–ò–º—è: ${user.full_name}`,
                `–ë–∞–ª–∞–Ω—Å: ${toLocaleCurrency(user.balance_rub)}`,
                lastTransaction ? `–ü–æ—Å–ª–µ–¥–Ω—è—è –æ–ø–µ—Ä–∞—Ü–∏—è: ${toLocaleCurrency(lastTransaction.amount_rub)} (${new Date(lastTransaction.created_at).toLocaleString('ru-RU')})` : '–ü–æ—Å–ª–µ–¥–Ω—è—è –æ–ø–µ—Ä–∞—Ü–∏—è: ‚Äî',
            ].join('\n');
            alert(info);
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    async function refreshHealth() {
        const data = await callApi('/api/health');
        renderHealth(data);
    }

    async function loadAllData() {
        const [health, summary, revenue, users, servers, categories] = await Promise.all([
            callApi('/api/health'),
            callApi('/api/dashboard/summary'),
            callApi('/api/dashboard/revenue?days=14'),
            callApi('/api/users/recent?limit=8'),
            callApi('/api/servers'),
            callApi('/api/settings/categories'),
        ]);
        renderHealth(health);
        renderSummary(summary);
        renderRevenue(revenue);
        renderUsers(users);
        renderServers(servers);
        renderSettingsCategories(categories);
        if (els.transactionsTypeFilter) {
            els.transactionsTypeFilter.value = state.transactions.type;
        }
        if (els.transactionsStatusFilter) {
            els.transactionsStatusFilter.value = state.transactions.status;
        }
        if (els.transactionsSearch) {
            els.transactionsSearch.value = state.transactions.search;
        }
        if (els.usersAdminSearch) {
            els.usersAdminSearch.value = state.usersList.search;
        }
        if (els.subscriptionsStatusFilter) {
            els.subscriptionsStatusFilter.value = state.subscriptions.status;
        }
        await Promise.all([
            loadTransactions({ reset: true }),
            loadUsersList({ reset: true }),
            loadSubscriptions({ reset: true }),
        ]);
    }

    async function handleAction(action) {
        try {
            switch (action) {
                case 'refresh':
                    await loadAllData();
                    showToast('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                    break;
                case 'refresh-users':
                    renderUsers(await callApi('/api/users/recent?limit=8'));
                    await loadUsersList({ reset: true });
                    showToast('–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                    break;
                case 'reload-config':
                    await callApi('/api/bot/control', { method: 'POST', body: { action: 'reload_configuration' } });
                    showToast('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
                    break;
                case 'create-backup':
                    const backupResult = await callApi('/api/bot/control', { method: 'POST', body: { action: 'create_backup' } });
                    updateBackupResultView(backupResult);
                    showToast('–ó–∞–¥–∞—á–∞ –Ω–∞ –±–µ–∫–∞–ø —Å–æ–∑–¥–∞–Ω–∞', 'success');
                    break;
                case 'send-report':
                    await callApi('/api/bot/control', { method: 'POST', body: { action: 'send_daily_report' } });
                    showToast('–û—Ç—á–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω', 'success');
                    break;
                case 'toggle-maintenance':
                    if (state.health?.bot?.maintenance) {
                        await callApi('/api/bot/control', { method: 'POST', body: { action: 'disable_maintenance' } });
                    } else {
                        await callApi('/api/bot/control', { method: 'POST', body: { action: 'enable_maintenance' } });
                    }
                    showToast('–°—Ç–∞—Ç—É—Å —Ç–µ—Ö—Ä–∞–±–æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                    await refreshHealth();
                    break;
                default:
                    break;
            }
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    function bindEvents() {
        els.loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const token = els.loginToken.value.trim();
            if (!token) {
                els.loginError.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω';
                return;
            }
            try {
                await callApi('/api/auth/login', { method: 'POST', body: { token }, skipAuth: true });
                state.token = token;
                localStorage.setItem('webadminToken', token);
                hideLogin();
                await loadAllData();
            } catch (error) {
                els.loginError.textContent = error.message;
            }
        });

        document.addEventListener('click', (event) => {
            if (!els.botDropdown.contains(event.target) && !els.botControlBtn.contains(event.target)) {
                els.botDropdown.classList.remove('open');
            }
        });

        els.botControlBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            els.botDropdown.classList.toggle('open');
        });

        els.botDropdown.addEventListener('click', async (event) => {
            const action = event.target.closest('[data-action]')?.dataset.action;
            if (!action) return;
            els.botDropdown.classList.remove('open');
            if (action === 'logout') {
                state.token = '';
                localStorage.removeItem('webadminToken');
                showToast('–í—ã –≤—ã—à–ª–∏ –∏–∑ –ø–∞–Ω–µ–ª–∏', 'success');
                showLogin();
                return;
            }
            await handleAction(action);
        });

        document.querySelectorAll('[data-action]').forEach((button) => {
            button.addEventListener('click', async () => {
                const action = button.dataset.action;
                if (['reload-config', 'create-backup', 'toggle-maintenance', 'refresh', 'refresh-users'].includes(action)) {
                    await handleAction(action);
                }
            });
        });

        els.recentUsersBody.addEventListener('click', async (event) => {
            const button = event.target.closest('[data-action="view-user"]');
            if (!button) return;
            const userId = Number(button.dataset.userId);
            if (!Number.isFinite(userId)) return;
            await viewUser(userId);
        });

        els.settingsContainer.addEventListener('click', async (event) => {
            const target = event.target.closest('[data-action]');
            if (!target) return;
            const { action, key, category } = target.dataset;
            if (!key || !category) return;
            if (action === 'edit-setting') {
                await editSetting(key, category);
            } else if (action === 'reset-setting') {
                await resetSetting(key, category);
            }
        });

        if (els.transactionsApply) {
            els.transactionsApply.addEventListener('click', async () => {
                state.transactions.type = els.transactionsTypeFilter?.value || 'all';
                state.transactions.status = els.transactionsStatusFilter?.value || 'all';
                state.transactions.search = (els.transactionsSearch?.value || '').trim();
                await loadTransactions({ reset: true });
            });
        }

        if (els.transactionsSearch) {
            els.transactionsSearch.addEventListener('keydown', async (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    state.transactions.search = event.target.value.trim();
                    await loadTransactions({ reset: true });
                }
            });
        }

        if (els.transactionsPrev) {
            els.transactionsPrev.addEventListener('click', async () => {
                if (state.transactions.offset <= 0) return;
                state.transactions.offset = Math.max(0, state.transactions.offset - state.transactions.limit);
                await loadTransactions();
            });
        }

        if (els.transactionsNext) {
            els.transactionsNext.addEventListener('click', async () => {
                if (state.transactions.offset + state.transactions.limit >= state.transactions.total) return;
                state.transactions.offset += state.transactions.limit;
                await loadTransactions();
            });
        }

        if (els.usersAdminApply) {
            els.usersAdminApply.addEventListener('click', async () => {
                state.usersList.search = (els.usersAdminSearch?.value || '').trim();
                await loadUsersList({ reset: true });
            });
        }

        if (els.usersAdminSearch) {
            els.usersAdminSearch.addEventListener('keydown', async (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    state.usersList.search = event.target.value.trim();
                    await loadUsersList({ reset: true });
                }
            });
        }

        if (els.usersAdminPrev) {
            els.usersAdminPrev.addEventListener('click', async () => {
                if (state.usersList.offset <= 0) return;
                state.usersList.offset = Math.max(0, state.usersList.offset - state.usersList.limit);
                await loadUsersList();
            });
        }

        if (els.usersAdminNext) {
            els.usersAdminNext.addEventListener('click', async () => {
                if (state.usersList.offset + state.usersList.limit >= state.usersList.total) return;
                state.usersList.offset += state.usersList.limit;
                await loadUsersList();
            });
        }

        if (els.usersAdminBody) {
            els.usersAdminBody.addEventListener('click', async (event) => {
                const button = event.target.closest('[data-action="view-user"]');
                if (!button) return;
                const userId = Number(button.dataset.userId);
                if (!Number.isFinite(userId)) return;
                await viewUser(userId);
            });
        }

        if (els.subscriptionsStatusFilter) {
            els.subscriptionsStatusFilter.addEventListener('change', async () => {
                state.subscriptions.status = els.subscriptionsStatusFilter.value || 'all';
                await loadSubscriptions({ reset: true });
            });
        }

        if (els.subscriptionsPrev) {
            els.subscriptionsPrev.addEventListener('click', async () => {
                if (state.subscriptions.offset <= 0) return;
                state.subscriptions.offset = Math.max(0, state.subscriptions.offset - state.subscriptions.limit);
                await loadSubscriptions();
            });
        }

        if (els.subscriptionsNext) {
            els.subscriptionsNext.addEventListener('click', async () => {
                if (state.subscriptions.offset + state.subscriptions.limit >= state.subscriptions.total) return;
                state.subscriptions.offset += state.subscriptions.limit;
                await loadSubscriptions();
            });
        }

        if (els.backupButton) {
            els.backupButton.addEventListener('click', async () => {
                await handleAction('create-backup');
            });
        }
    }

    async function init() {
        bindEvents();
        if (state.token) {
            try {
                await loadAllData();
            } catch (error) {
                showToast(error.message, 'error');
                showLogin('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ö–æ–¥ –∑–∞–Ω–æ–≤–æ');
            }
        } else {
            showLogin();
        }
    }

    document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
