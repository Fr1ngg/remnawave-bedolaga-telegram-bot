<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{WEBADMIN_TITLE}} ‚Ä¢ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0b0d;
            --bg-secondary: #141519;
            --bg-tertiary: #1c1d24;
            --bg-hover: #25262f;
            --text-primary: #e4e4e7;
            --text-secondary: #9ca3af;
            --text-tertiary: #6b7280;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: rgba(255, 255, 255, 0.08);
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-animation {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            opacity: 0.3;
            background: radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 20%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            animation: bgShift 20s ease-in-out infinite;
        }

        @keyframes bgShift {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(-20px, -20px) scale(1.05); }
            50% { transform: translate(20px, -30px) scale(1.1); }
            75% { transform: translate(-30px, 20px) scale(1.05); }
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: var(--accent-gradient);
            opacity: 0.1;
            filter: blur(100px);
        }

        .logo {
            padding: 28px 24px;
            border-bottom: 1px solid var(--border);
            position: relative;
            z-index: 1;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            background: var(--accent-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo .status {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 10px var(--success); }
            50% { box-shadow: 0 0 20px var(--success), 0 0 30px var(--success); }
            100% { box-shadow: 0 0 10px var(--success); }
        }

        .nav {
            flex: 1;
            padding: 24px 16px;
            overflow-y: auto;
            position: relative;
            z-index: 1;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-tertiary);
            padding: 0 12px;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
            margin-bottom: 4px;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: var(--accent-gradient);
            opacity: 0.1;
            transition: width 0.3s ease;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transform: translateX(4px);
        }

        .nav-item:hover::before {
            width: 100%;
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--accent-primary);
            font-weight: 500;
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 20px;
            background: var(--accent-primary);
            border-radius: 0 3px 3px 0;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--accent-primary);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 20px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .search-box {
            position: relative;
            width: 400px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            opacity: 0.5;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .header-btn:hover {
            background: var(--bg-hover);
            transform: translateY(-2px);
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 18px;
            height: 18px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-menu:hover {
            background: var(--bg-hover);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--accent-gradient);
            display: flex;
            align.items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: white;
        }

        .content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        .view-section.hidden {
            display: none;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--accent-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-icon.users { background: linear-gradient(135deg, #667eea, #764ba2); }
        .stat-icon.money { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .stat-icon.servers { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .stat-icon.chart { background: linear-gradient(135deg, #43e97b, #38f9d7); }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.05);
        }

        .stat-change.positive {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .stat-change.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
            min-height: 320px;
            position: relative;
            overflow: hidden;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            background: var(--accent-gradient);
            opacity: 0.05;
            filter: blur(100px);
            border-radius: 50%;
        }

        .chart-placeholder {
            text-align: center;
            color: var(--text-tertiary);
        }

        .chart-bars {
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: flex-start;
            gap: 16px;
            height: 240px;
            padding: 24px 12px 12px;
        }

        .chart-bar {
            position: relative;
            flex: 1;
            min-width: 32px;
            border-radius: 10px 10px 0 0;
            background: linear-gradient(180deg, rgba(99, 102, 241, 0.85), rgba(139, 92, 246, 0.4));
            overflow: hidden;
        }

        .chart-bar-value {
            position: absolute;
            top: -28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chart-bar-label {
            position: absolute;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: var(--text-tertiary);
            white-space: nowrap;
        }

        .quick-actions {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .action-btn.primary {
            background: var(--accent-gradient);
            color: white;
            border: none;
        }

        .action-btn:hover {
            background: var(--bg-tertiary);
            transform: translateY(-2px);
        }

        .action-btn.primary:hover {
            opacity: 0.95;
            transform: translateY(-2px);
        }

        .servers-section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .server-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .server-card.expanded {
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: var(--shadow);
        }

        .server-card-header {
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .server-card-header:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .server-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .server-flag {
            font-size: 32px;
        }

        .server-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .server-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 12px;
            background: rgba(99, 102, 241, 0.12);
            color: var(--accent-primary);
        }

        .server-status-badge.offline {
            background: rgba(239, 68, 68, 0.12);
            color: var(--danger);
        }

        .server-stats {
            display: flex;
            gap: 32px;
            align-items: center;
        }

        .server-stat {
            text-align: center;
        }

        .server-stat-value {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .server-stat-label {
            font-size: 12px;
            color: var(--text-tertiary);
            text-transform: uppercase;
        }

        .expand-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: var(--bg-tertiary);
            transition: transform 0.3s ease;
        }

        .server-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .server-expanded-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            border-top: 1px solid var(--border);
        }

        .server-card.expanded .server-expanded-content {
            max-height: 400px;
        }

        .server-expanded-inner {
            padding: 20px 24px 24px;
        }

        .server-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .server-detail {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(99, 102, 241, 0.12);
        }

        .server-detail-title {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-tertiary);
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        .server-detail-value {
            font-size: 16px;
            font-weight: 600;
        }

        .server-description {
            margin-top: 16px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 32px;
        }

        .table-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .table-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: rgba(255, 255, 255, 0.02);
        }

        th, td {
            padding: 16px 24px;
            text-align: left;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        th {
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
        }

        tbody tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .user-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar-small {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .user-id {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
        }

        .status-badge.trial {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-badge.expired {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .table-actions-cell {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .icon-btn:hover {
            background: var(--bg-hover);
            transform: scale(1.1);
        }
        .settings-section {
            margin-bottom: 48px;
        }

        .settings-section h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .settings-section p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .settings-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .setting-category {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }

        .setting-category summary {
            list-style: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 24px;
            font-weight: 600;
            transition: background 0.2s ease;
        }

        .setting-category summary::-webkit-details-marker {
            display: none;
        }

        .setting-category[open] summary {
            background: rgba(99, 102, 241, 0.05);
        }

        .settings-count {
            font-size: 12px;
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
            padding: 4px 10px;
            border-radius: 999px;
        }

        .setting-items {
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .setting-item {
            display: grid;
            grid-template-columns: minmax(220px, 1fr) minmax(200px, 1fr) 160px;
            gap: 16px;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .setting-key {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .setting-value {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .setting-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .setting-button {
            padding: 8px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .setting-button:hover:enabled {
            background: var(--bg-hover);
        }

        .setting-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .setting-override {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
            width: fit-content;
        }

        .settings-empty {
            padding: 20px 24px;
            color: var(--text-secondary);
        }

        .settings-empty small {
            color: var(--text-tertiary);
        }

        .bot-control {
            position: relative;
        }

        .bot-control-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .bot-control-btn:hover {
            background: var(--bg-hover);
        }

        .bot-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        .bot-status.paused {
            background: var(--warning);
            box-shadow: 0 0 10px var(--warning);
        }

        .bot-status.stopped {
            background: var(--danger);
            box-shadow: 0 0 10px var(--danger);
        }

        .bot-dropdown {
            position: absolute;
            right: 0;
            top: calc(100% + 8px);
            width: 240px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 8px;
            display: none;
            flex-direction: column;
            gap: 4px;
            box-shadow: var(--shadow);
            z-index: 10;
        }

        .bot-dropdown.open {
            display: flex;
        }

        .bot-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s ease;
            color: var(--text-primary);
        }

        .bot-dropdown-item:hover {
            background: var(--bg-tertiary);
        }

        .bot-dropdown-item.warning {
            color: var(--warning);
        }

        .bot-dropdown-item.danger {
            color: var(--danger);
        }

        .bot-dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        .auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 11, 13, 0.85);
            backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 32px;
            width: min(420px, 92%);
            box-shadow: var(--shadow);
        }

        .auth-modal h2 {
            font-size: 22px;
            margin-bottom: 8px;
            text-align: center;
        }

        .auth-modal p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            text-align: center;
        }

        .auth-modal input {
            width: 100%;
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .auth-modal button {
            margin-top: 18px;
            width: 100%;
            padding: 14px 18px;
            border-radius: 12px;
            border: none;
            background: var(--accent-gradient);
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .auth-error {
            color: var(--danger);
            margin-top: 12px;
            text-align: center;
            min-height: 20px;
        }

        .toast-container {
            position: fixed;
            right: 24px;
            bottom: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 2100;
        }

        .toast {
            min-width: 220px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 18px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .toast.success {
            border-color: rgba(16, 185, 129, 0.5);
        }

        .toast.error {
            border-color: rgba(239, 68, 68, 0.5);
        }

        .toast.warning {
            border-color: rgba(245, 158, 11, 0.5);
        }

        .maintenance-label {
            font-weight: 600;
            color: var(--accent-primary);
        }

        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                transform: translateX(-100%);
                z-index: 1000;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .search-box {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .setting-item {
                grid-template-columns: 1fr;
                gap: 12px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
<div class="bg-animation"></div>
<div id="auth-overlay" class="auth-overlay hidden">
    <div class="auth-modal">
        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
        <p>–í–≤–µ–¥–∏—Ç–µ –∞–¥–º–∏–Ω-—Ç–æ–∫–µ–Ω –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
        <form id="login-form">
            <input id="login-token" type="password" placeholder="API —Ç–æ–∫–µ–Ω" autocomplete="off" required>
            <button type="submit">–í–æ–π—Ç–∏</button>
            <div id="login-error" class="auth-error"></div>
        </form>
    </div>
</div>
<div id="toast-container" class="toast-container"></div>
<div class="container">
    <aside class="sidebar">
        <div class="logo">
            <h1>
                <span class="status"></span>
                <span id="sidebar-title">{{WEBADMIN_TITLE}}</span>
            </h1>
        </div>
        <nav class="nav">
            <div class="nav-section">
                <div class="nav-section-title">–û–±–∑–æ—Ä</div>
                <a href="#" class="nav-item active" data-view="dashboard">
                    <span class="nav-icon">üìä</span>
                    <span>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</span>
                </a>
                <a href="#" class="nav-item" data-view="system">
                    <span class="nav-icon">üßæ</span>
                    <span>–°–∏—Å—Ç–µ–º–Ω—ã–π —Å—Ç–∞—Ç—É—Å</span>
                </a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
                <a href="#" class="nav-item" data-view="users">
                    <span class="nav-icon">üë•</span>
                    <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
                </a>
                <a href="#" class="nav-item" data-view="subscriptions">
                    <span class="nav-icon">üí≥</span>
                    <span>–ü–æ–¥–ø–∏—Å–∫–∏</span>
                </a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">–û–ø–µ—Ä–∞—Ü–∏–∏</div>
                <a href="#" class="nav-item" data-view="support">
                    <span class="nav-icon">üõü</span>
                    <span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
                </a>
                <a href="#" class="nav-item" data-view="promotions">
                    <span class="nav-icon">üí°</span>
                    <span>–ü—Ä–æ–º–æ –∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥</span>
                </a>
                <a href="#" class="nav-item" data-view="communications">
                    <span class="nav-icon">üì®</span>
                    <span>–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</span>
                </a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</div>
                <a href="#" class="nav-item" data-view="servers">
                    <span class="nav-icon">üñ•Ô∏è</span>
                    <span>–°–µ—Ä–≤–µ—Ä—ã</span>
                    <span class="nav-badge" id="nav-servers-count">‚Äî</span>
                </a>
                <a href="#" class="nav-item" data-view="settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞</span>
                </a>
            </div>
        </nav>
    </aside>
    <main class="main">
        <header class="header">
            <div class="header-left">
                <div class="search-box">
                    <input type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, ID, email..." id="search-input">
                </div>
            </div>
            <div class="header-right">
                <div class="bot-control">
                    <button class="bot-control-btn" id="bot-control-btn" type="button">
                        <span class="bot-status" id="bot-status-indicator"></span>
                        <span data-bot-state>–ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω</span>
                        <span class="bot-control-caret">‚ñº</span>
                    </button>
                    <div class="bot-dropdown" id="bot-dropdown">
                        <div class="bot-dropdown-item" data-action="reload-config">
                            <span>üîÑ</span>
                            <span>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é</span>
                        </div>
                        <div class="bot-dropdown-item" data-action="create-backup">
                            <span>üíæ</span>
                            <span>–°–æ–∑–¥–∞—Ç—å –±–µ–∫–∞–ø</span>
                        </div>
                        <div class="bot-dropdown-item" data-action="send-report">
                            <span>üì¨</span>
                            <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–Ω–µ–≤–Ω–æ–π –æ—Ç—á–µ—Ç</span>
                        </div>
                        <div class="bot-dropdown-divider"></div>
                        <div class="bot-dropdown-item warning" data-action="toggle-maintenance">
                            <span>üöß</span>
                            <span>–†–µ–∂–∏–º —Ç–µ—Ö—Ä–∞–±–æ—Ç: <span class="maintenance-label" data-maintenance-label>–í—ã–∫–ª</span></span>
                        </div>
                        <div class="bot-dropdown-divider"></div>
                        <div class="bot-dropdown-item danger" data-action="logout">
                            <span>üö™</span>
                            <span>–í—ã–π—Ç–∏</span>
                        </div>
                    </div>
                </div>
                <div class="user-menu" id="user-menu">
                    <div class="user-avatar" id="user-avatar">A</div>
                    <div>
                        <div style="font-size: 14px; font-weight: 500;" id="user-name">Admin</div>
                        <div style="font-size: 12px; color: var(--text-tertiary);">–°—É–ø–µ—Ä –∞–¥–º–∏–Ω</div>
                    </div>
                </div>
            </div>
        </header>
        <div class="content">
            <section id="view-dashboard" class="view-section">
                <h1 class="page-title">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
                <p class="page-subtitle">–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</p>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="stat-total-users">‚Äî</div>
                                <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                            </div>
                            <div class="stat-icon users">üë•</div>
                        </div>
                        <div class="stat-change" id="stat-users-change">‚Äî</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="stat-revenue">‚Äî</div>
                                <div class="stat-label">–î–æ—Ö–æ–¥ –∑–∞ 30 –¥–Ω–µ–π</div>
                            </div>
                            <div class="stat-icon money">üí∞</div>
                        </div>
                        <div class="stat-change" id="stat-revenue-change">‚Äî</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="stat-servers">‚Äî</div>
                                <div class="stat-label">–°–µ—Ä–≤–µ—Ä–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–æ</div>
                            </div>
                            <div class="stat-icon servers">üñ•Ô∏è</div>
                        </div>
                        <div class="stat-change" id="stat-servers-change">‚Äî</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="stat-conversion">‚Äî</div>
                                <div class="stat-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è –∏–∑ —Ç—Ä–∏–∞–ª–∞</div>
                            </div>
                            <div class="stat-icon chart">üìà</div>
                        </div>
                        <div class="stat-change" id="stat-conversion-change">‚Äî</div>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-placeholder" id="revenue-chart">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞‚Ä¶</div>
                </div>
                <div class="actions-grid">
                    <button class="action-btn" data-action="refresh">
                        <span>üîÑ</span>
                        <span>–û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</span>
                    </button>
                    <button class="action-btn" data-action="toggle-maintenance">
                        <span>üöß</span>
                        <span id="maintenance-action-label">–í–∫–ª—é—á–∏—Ç—å —Ç–µ—Ö—Ä–∞–±–æ—Ç—ã</span>
                    </button>
                </div>
                <section class="table-container">
                    <div class="table-header">
                        <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                        <button class="action-btn" data-action="refresh-users">
                            <span>üîÑ</span>
                            <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
                        </button>
                    </div>
                    <table>
                        <thead>
                        <tr>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ü–æ–¥–ø–∏—Å–∫–∞</th>
                            <th>–ë–∞–ª–∞–Ω—Å</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody id="recent-users-body">
                        <tr>
                            <td colspan="5" style="padding: 32px; text-align: center; color: var(--text-tertiary);">
                                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </section>
            </section>

            <section id="view-users" class="view-section hidden">
                <h1 class="page-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
                <p class="page-subtitle">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫</p>
                <div id="users-overview" class="stats-grid"></div>
                <div class="table-container">
                    <div class="table-header">
                        <h3>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                        <div style="display:flex; gap:12px; align-items:center;">
                            <input id="users-search" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ ID" style="padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:var(--bg-tertiary); color:var(--text-primary);">
                            <select id="users-order" style="padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:var(--bg-tertiary); color:var(--text-primary);">
                                <option value="">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
                                <option value="balance">–ü–æ –±–∞–ª–∞–Ω—Å—É</option>
                                <option value="activity">–ü–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</option>
                            </select>
                        </div>
                    </div>
                    <table>
                        <thead>
                        <tr>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ü–æ–¥–ø–∏—Å–∫–∞</th>
                            <th>–ë–∞–ª–∞–Ω—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                        </thead>
                        <tbody id="users-table-body"></tbody>
                    </table>
                    <div class="settings-empty" id="users-empty">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶</div>
                    <div class="pagination" id="users-pagination" style="display:flex; justify-content:flex-end; gap:12px; padding:16px; align-items:center;"></div>
                </div>
            </section>

            <section id="view-subscriptions" class="view-section hidden">
                <h1 class="page-title">–ü–æ–¥–ø–∏—Å–∫–∏</h1>
                <p class="page-subtitle">–ö–æ–Ω—Ç—Ä–æ–ª—å –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫</p>
                <div id="subscriptions-overview" class="stats-grid"></div>
                <div class="table-container">
                    <div class="table-header">
                        <h3>–ü–æ–¥–ø–∏—Å–∫–∏</h3>
                        <div style="display:flex; gap:12px; align-items:center;">
                            <select id="subscriptions-status" style="padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:var(--bg-tertiary); color:var(--text-primary);">
                                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                <option value="active">–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                                <option value="trial">–¢—Ä–∏–∞–ª</option>
                                <option value="expired">–ò—Å—Ç–µ–∫—à–∏–µ</option>
                            </select>
                            <button class="action-btn" id="subscriptions-expiring-btn" type="button">
                                <span>‚è∞</span>
                                <span>–ò—Å—Ç–µ–∫–∞—é—â–∏–µ</span>
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                        <tr>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–û–∫–æ–Ω—á–∞–Ω–∏–µ</th>
                            <th>–¢—Ä–∞—Ñ–∏–∫</th>
                            <th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</th>
                        </tr>
                        </thead>
                        <tbody id="subscriptions-table-body"></tbody>
                    </table>
                    <div class="settings-empty" id="subscriptions-empty">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫‚Ä¶</div>
                    <div class="pagination" id="subscriptions-pagination" style="display:flex; justify-content:flex-end; gap:12px; padding:16px; align-items:center;"></div>
                </div>
                <div class="table-container" id="subscriptions-expiring" style="display:none;">
                    <div class="table-header">
                        <h3>–ò—Å—Ç–µ–∫–∞—é—â–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏</h3>
                        <span id="subscriptions-expiring-period" style="color:var(--text-ter—Ç–∏ary);"></span>
                    </div>
                    <table>
                        <thead>
                        <tr>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–û–∫–æ–Ω—á–∞–Ω–∏–µ</th>
                            <th>–¢—Ä–∞—Ñ–∏–∫</th>
                            <th>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</th>
                        </tr>
                        </thead>
                        <tbody id="subscriptions-expiring-body"></tbody>
                    </table>
                </div>
            </section>

            <section id="view-support" class="view-section hidden">
                <h1 class="page-title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h1>
                <p class="page-subtitle">–°—Ç–∞—Ç—É—Å—ã —Ç–∏–∫–µ—Ç–æ–≤ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤</p>
                <div id="support-overview" class="stats-grid"></div>
                <div class="table-container">
                    <div class="table-header">
                        <h3>–¢–∏–∫–µ—Ç—ã</h3>
                        <select id="support-status" style="padding:8px 12px; border-radius:8px; border:1px solid var(--border); background:var(--bg-ter—Ç–∏ary); color:var(--text-primary);">
                            <option value="">–í—Å–µ</option>
                            <option value="open">–û—Ç–∫—Ä—ã—Ç—ã–µ</option>
                            <option value="answered">–° –æ—Ç–≤–µ—Ç–æ–º</option>
                            <option value="pending">–í –æ–∂–∏–¥–∞–Ω–∏–∏</option>
                            <option value="closed">–ó–∞–∫—Ä—ã—Ç—ã–µ</option>
                        </select>
                    </div>
                    <table>
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                            <th>–û–±–Ω–æ–≤–ª—ë–Ω</th>
                        </tr>
                        </thead>
                        <tbody id="support-table-body"></tbody>
                    </table>
                    <div class="settings-empty" id="support-empty">–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤‚Ä¶</div>
                </div>
                <div class="table-container hidden" id="support-detail">
                    <div class="table-header">
                        <h3 id="support-detail-title">–¢–∏–∫–µ—Ç</h3>
                        <button class="action-btn" id="support-detail-close" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                    <div id="support-detail-body" style="padding:24px; max-height:420px; overflow:auto;"></div>
                </div>
            </section>

            <section id="view-promotions" class="view-section hidden">
                <h1 class="page-title">–ü—Ä–æ–º–æ –∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥</h1>
                <p class="page-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏, –∫–∞–º–ø–∞–Ω–∏—è–º–∏ –∏ –ø—Ä–æ–º–æ-–≥—Ä—É–ø–ø–∞–º–∏</p>
                <div id="promotions-overview" class="stats-grid"></div>
                <div class="table-container">
                    <div class="table-header"><h3>–ü—Ä–æ–º–æ–∫–æ–¥—ã</h3></div>
                    <table>
                        <thead>
                        <tr>
                            <th>–ö–æ–¥</th>
                            <th>–¢–∏–ø</th>
                            <th>–ë–æ–Ω—É—Å</th>
                            <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                        </thead>
                        <tbody id="promocodes-body"></tbody>
                    </table>
                    <div class="settings-empty" id="promocodes-empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                </div>
                <div class="table-container">
                    <div class="table-header"><h3>–ö–∞–º–ø–∞–Ω–∏–∏</h3></div>
                    <table>
                        <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–ü–∞—Ä–∞–º–µ—Ç—Ä</th>
                            <th>–¢–∏–ø</th>
                            <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                        </thead>
                        <tbody id="campaigns-body"></tbody>
                    </table>
                    <div class="settings-empty" id="campaigns-empty">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π</div>
                </div>
                <div class="table-container">
                    <div class="table-header"><h3>–ü—Ä–æ–º–æ-–≥—Ä—É–ø–ø—ã</h3></div>
                    <table>
                        <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–°–∫–∏–¥–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ã</th>
                            <th>–°–∫–∏–¥–∫–∞ –Ω–∞ —Ç—Ä–∞—Ñ–∏–∫</th>
                            <th>–°–∫–∏–¥–∫–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</th>
                        </tr>
                        </thead>
                        <tbody id="promo-groups-body"></tbody>
                    </table>
                    <div class="settings-empty" id="promo-groups-empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≥—Ä—É–ø–ø–∞—Ö</div>
                </div>
            </section>

            <section id="view-communications" class="view-section hidden">
                <h1 class="page-title">–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏</h1>
                <p class="page-subtitle">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –º–µ–Ω—é</p>
                <div id="communications-overview" class="stats-grid"></div>
                <div class="table-container">
                    <div class="table-header"><h3>–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã</h3></div>
                    <div id="welcome-texts-list" style="padding:24px; display:flex; flex-direction:column; gap:16px;"></div>
                </div>
                <div class="table-container">
                    <div class="table-header"><h3>–°–æ–æ–±—â–µ–Ω–∏—è –≤ –º–µ–Ω—é</h3></div>
                    <div id="user-messages-list" style="padding:24px; display:flex; flex-direction:column; gap:16px;"></div>
                </div>
            </section>

            <section id="view-servers" class="view-section hidden">
                <h1 class="page-title">–°–µ—Ä–≤–µ—Ä—ã</h1>
                <p class="page-subtitle">–°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∏ –µ–º–∫–æ—Å—Ç—å</p>
                <div class="settings-empty" id="servers-empty">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ —Å–µ—Ä–≤–µ—Ä–∞—Ö‚Ä¶</div>
                <div id="servers-container"></div>
            </section>

            <section id="view-settings" class="view-section hidden">
                <h1 class="page-title">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞</h1>
                <p class="page-subtitle">–ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∏ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞</p>
                <div id="settings-container" class="settings-container">
                    <div class="settings-empty">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–∫‚Ä¶</div>
                </div>
            </section>

            <section id="view-system" class="view-section hidden">
                <h1 class="page-title">–°–∏—Å—Ç–µ–º–Ω—ã–π —Å—Ç–∞—Ç—É—Å</h1>
                <p class="page-subtitle">–°–æ—Å—Ç–æ—è–Ω–∏–µ –±–æ—Ç–∞, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∑–∞–¥–∞—á</p>
                <div id="system-overview" class="stats-grid"></div>
                <div class="table-container">
                    <div class="table-header"><h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3></div>
                    <div id="system-actions" style="padding:24px; display:flex; flex-direction:column; gap:12px;"></div>
                </div>
            </section>
        </div>
        </main>
</div>
</div>
<script>
(() => {
    const state = {
        token: localStorage.getItem('webadminToken') || '',
        health: null,
        settingsCache: new Map(),
        currentView: 'dashboard',
        caches: {
            users: { page: 1, search: '', order: '' },
            subscriptions: { page: 1, status: '' },
            support: { page: 1, status: '' },
        },
        servers: [],
    };

    const els = {
        authOverlay: document.getElementById('auth-overlay'),
        loginForm: document.getElementById('login-form'),
        loginToken: document.getElementById('login-token'),
        loginError: document.getElementById('login-error'),
        toastContainer: document.getElementById('toast-container'),
        botControlBtn: document.getElementById('bot-control-btn'),
        botDropdown: document.getElementById('bot-dropdown'),
        botStatusIndicator: document.getElementById('bot-status-indicator'),
        maintenanceActionLabel: document.getElementById('maintenance-action-label'),
        maintenanceLabel: document.querySelector('[data-maintenance-label]'),
        navItems: Array.from(document.querySelectorAll('.nav-item[data-view]')),
        viewSections: Array.from(document.querySelectorAll('.view-section')),
        statUsers: document.getElementById('stat-total-users'),
        statUsersChange: document.getElementById('stat-users-change'),
        statRevenue: document.getElementById('stat-revenue'),
        statRevenueChange: document.getElementById('stat-revenue-change'),
        statServers: document.getElementById('stat-servers'),
        statServersChange: document.getElementById('stat-servers-change'),
        statConversion: document.getElementById('stat-conversion'),
        statConversionChange: document.getElementById('stat-conversion-change'),
        revenueChart: document.getElementById('revenue-chart'),
        navServersCount: document.getElementById('nav-servers-count'),
        recentUsersBody: document.getElementById('recent-users-body'),
        searchInput: document.getElementById('search-input'),
        settingsContainer: document.getElementById('settings-container'),
        // Users view
        usersOverview: document.getElementById('users-overview'),
        usersTableBody: document.getElementById('users-table-body'),
        usersEmpty: document.getElementById('users-empty'),
        usersPagination: document.getElementById('users-pagination'),
        usersSearch: document.getElementById('users-search'),
        usersOrder: document.getElementById('users-order'),
        // Subscriptions view
        subscriptionsOverview: document.getElementById('subscriptions-overview'),
        subscriptionsTableBody: document.getElementById('subscriptions-table-body'),
        subscriptionsEmpty: document.getElementById('subscriptions-empty'),
        subscriptionsPagination: document.getElementById('subscriptions-pagination'),
        subscriptionsStatus: document.getElementById('subscriptions-status'),
        subscriptionsExpiringBtn: document.getElementById('subscriptions-expiring-btn'),
        subscriptionsExpiring: document.getElementById('subscriptions-expiring'),
        subscriptionsExpiringBody: document.getElementById('subscriptions-expiring-body'),
        subscriptionsExpiringPeriod: document.getElementById('subscriptions-expiring-period'),
        // Support view
        supportOverview: document.getElementById('support-overview'),
        supportTableBody: document.getElementById('support-table-body'),
        supportEmpty: document.getElementById('support-empty'),
        supportStatus: document.getElementById('support-status'),
        supportDetail: document.getElementById('support-detail'),
        supportDetailBody: document.getElementById('support-detail-body'),
        supportDetailTitle: document.getElementById('support-detail-title'),
        supportDetailClose: document.getElementById('support-detail-close'),
        // Promotions view
        promotionsOverview: document.getElementById('promotions-overview'),
        promocodesBody: document.getElementById('promocodes-body'),
        promocodesEmpty: document.getElementById('promocodes-empty'),
        campaignsBody: document.getElementById('campaigns-body'),
        campaignsEmpty: document.getElementById('campaigns-empty'),
        promoGroupsBody: document.getElementById('promo-groups-body'),
        promoGroupsEmpty: document.getElementById('promo-groups-empty'),
        // Communications view
        communicationsOverview: document.getElementById('communications-overview'),
        welcomeTextsList: document.getElementById('welcome-texts-list'),
        userMessagesList: document.getElementById('user-messages-list'),
        // Servers view
        serversContainer: document.getElementById('servers-container'),
        serversEmpty: document.getElementById('servers-empty'),
        // System view
        systemOverview: document.getElementById('system-overview'),
        systemActions: document.getElementById('system-actions'),
    };

    function toLocaleCurrency(value) {
        return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(value || 0);
    }

    function toPercent(value) {
        if (value === null || value === undefined || Number.isNaN(value)) {
            return '‚Äî';
        }
        return `${value.toFixed(1)}%`;
    }

    function showToast(message, type = 'info') {
        if (!els.toastContainer) return;
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        els.toastContainer.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('fade');
            setTimeout(() => toast.remove(), 200);
        }, 4000);
    }

    async function callApi(path, { method = 'GET', body, skipAuth = false } = {}) {
        const headers = {};
        if (!skipAuth && state.token) {
            headers.Authorization = `Bearer ${state.token}`;
        }
        const options = { method, headers };
        if (body !== undefined) {
            headers['Content-Type'] = 'application/json';
            options.body = JSON.stringify(body);
        }

        const response = await fetch(path, options).catch((error) => {
            throw new Error(`–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ${error.message}`);
        });

        let payload = {};
        if (response.status !== 204) {
            try {
                payload = await response.json();
            } catch (error) {
                payload = {};
            }
        }

        if (response.status === 401 && !skipAuth) {
            state.token = '';
            localStorage.removeItem('webadminToken');
            showLogin('–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥');
            throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ');
        }

        if (!response.ok || payload.status === 'error') {
            const message = payload.message || `–û—à–∏–±–∫–∞ ${response.status}`;
            throw new Error(message);
        }

        return payload.data !== undefined ? payload.data : payload;
    }

    function applyTrend(element, value) {
        element.classList.remove('positive', 'negative');
        if (value === null || value === undefined) {
            element.textContent = '‚Äî';
            return;
        }
        const formatted = value > 0 ? `‚Üë ${value.toFixed(1)}%` : value < 0 ? `‚Üì ${Math.abs(value).toFixed(1)}%` : '0%';
        element.textContent = formatted;
        if (value > 0) {
            element.classList.add('positive');
        } else if (value < 0) {
            element.classList.add('negative');
        }
    }

    function setActiveView(view) {
        state.currentView = view;
        els.navItems.forEach((item) => {
            const isActive = item.dataset.view === view;
            item.classList.toggle('active', isActive);
        });
        els.viewSections.forEach((section) => {
            if (!section.id) return;
            const target = `view-${view}`;
            if (section.id === target) {
                section.classList.remove('hidden');
            } else {
                section.classList.add('hidden');
            }
        });
    }

    function renderSummary(summary) {
        if (!summary) return;
        els.statUsers.textContent = summary.total_users?.toLocaleString('ru-RU') ?? '‚Äî';
        applyTrend(els.statUsersChange, summary.user_growth_percent ?? 0);
        els.statRevenue.textContent = toLocaleCurrency(summary.monthly_revenue);
        applyTrend(els.statRevenueChange, summary.monthly_revenue_change_percent ?? 0);
        els.statServers.textContent = `${summary.available_servers ?? 0} / ${summary.total_servers ?? 0}`;
        applyTrend(els.statServersChange, summary.active_servers_percent ?? 0);
        els.statConversion.textContent = toPercent(summary.conversion_rate_percent ?? 0);
        applyTrend(els.statConversionChange, summary.conversion_rate_percent ?? 0);
    }

    function renderRevenue(series) {
        if (!els.revenueChart) return;
        if (!Array.isArray(series) || !series.length) {
            els.revenueChart.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è';
            return;
        }
        const chart = document.createElement('div');
        chart.className = 'chart-bars';
        const max = Math.max(...series.map((item) => item.revenue || 0));
        series.forEach((item) => {
            const bar = document.createElement('div');
            bar.className = 'chart-bar';
            const percent = max > 0 ? Math.max((item.revenue / max) * 100, 5) : 5;
            bar.style.height = `${percent}%`;
            const value = document.createElement('div');
            value.className = 'chart-bar-value';
            value.textContent = toLocaleCurrency(item.revenue);
            const label = document.createElement('div');
            label.className = 'chart-bar-label';
            label.textContent = new Date(item.date).toLocaleDateString('ru-RU', { day: '2-digit', month: 'short' });
            bar.appendChild(value);
            bar.appendChild(label);
            chart.appendChild(bar);
        });
        els.revenueChart.innerHTML = '';
        els.revenueChart.appendChild(chart);
    }

    function renderRecentUsers(users) {
        if (!els.recentUsersBody) return;
        els.recentUsersBody.innerHTML = '';
        if (!Array.isArray(users) || !users.length) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="5" style="padding: 32px; text-align: center; color: var(--text-tertiary);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>';
            els.recentUsersBody.appendChild(row);
            return;
        }
        users.forEach((user) => {
            const row = document.createElement('tr');
            const statusBadge = user.status === 'active' ? 'success' : user.status === 'blocked' ? 'danger' : 'warning';
            const statusText = user.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : user.status === 'blocked' ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–£–¥–∞–ª–µ–Ω';
            const subscription = user.subscription || {};
            let subscriptionLabel = '‚Äî';
            if (subscription.status_display) {
                subscriptionLabel = subscription.status_display;
            } else if (subscription.status) {
                subscriptionLabel = subscription.status;
            }
            row.innerHTML = `
                <td>
                    <div class="user-cell">
                        <div class="user-avatar-small">${(user.full_name || user.username || 'U')[0] || 'U'}</div>
                        <div class="user-info">
                            <div class="user-name">${user.full_name || user.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
                            <div class="user-id">ID: ${user.telegram_id}</div>
                        </div>
                    </div>
                </td>
                <td><span class="status-badge status-${statusBadge}">${statusText}</span></td>
                <td>${subscriptionLabel}</td>
                <td>${toLocaleCurrency(user.balance_rub)}</td>
                <td><button class="action-btn" data-action="view-user" data-user-id="${user.id}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button></td>
            `;
            els.recentUsersBody.appendChild(row);
        });
    }

    function renderUsersOverview(overview) {
        if (!els.usersOverview) return;
        els.usersOverview.innerHTML = '';
        if (!overview) return;
        const cards = [
            { label: '–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', value: overview.totals?.all ?? 0, emoji: 'üë•' },
            { label: '–ê–∫—Ç–∏–≤–Ω—ã–µ', value: overview.totals?.active ?? 0, emoji: '‚úÖ' },
            { label: '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ', value: overview.totals?.blocked ?? 0, emoji: 'üö´' },
            { label: '–¢—Ä–∏–∞–ª –ø–æ–¥–ø–∏—Å–∫–∏', value: overview.subscriptions?.trials ?? 0, emoji: 'üéØ' },
        ];
        cards.forEach((card) => {
            const element = document.createElement('div');
            element.className = 'stat-card';
            element.innerHTML = `
                <div class="stat-header">
                    <div>
                        <div class="stat-value">${card.value.toLocaleString('ru-RU')}</div>
                        <div class="stat-label">${card.label}</div>
                    </div>
                    <div class="stat-icon">${card.emoji}</div>
                </div>
            `;
            els.usersOverview.appendChild(element);
        });
    }

    function renderPagination(container, pagination, onPageChange) {
        if (!container || !pagination) return;
        container.innerHTML = '';
        const totalPages = Math.max(1, Math.ceil((pagination.total || 0) / pagination.limit));
        if (totalPages <= 1) {
            container.style.display = 'none';
            return;
        }
        container.style.display = 'flex';
        const prev = document.createElement('button');
        prev.className = 'action-btn';
        prev.type = 'button';
        prev.disabled = pagination.page <= 1;
        prev.textContent = '‚¨ÖÔ∏è';
        prev.addEventListener('click', () => onPageChange(Math.max(1, pagination.page - 1)));
        const next = document.createElement('button');
        next.className = 'action-btn';
        next.type = 'button';
        next.disabled = pagination.page >= totalPages;
        next.textContent = '‚û°Ô∏è';
        next.addEventListener('click', () => onPageChange(Math.min(totalPages, pagination.page + 1)));
        const label = document.createElement('span');
        label.style.color = 'var(--text-tertiary)';
        label.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${pagination.page} –∏–∑ ${totalPages}`;
        container.append(prev, label, next);
    }

    function renderUsersTable(items, pagination) {
        if (!els.usersTableBody) return;
        els.usersTableBody.innerHTML = '';
        const hasItems = Array.isArray(items) && items.length > 0;
        els.usersEmpty.style.display = hasItems ? 'none' : 'block';
        if (!hasItems) {
            renderPagination(els.usersPagination, null, () => {});
            return;
        }
        items.forEach((user) => {
            const row = document.createElement('tr');
            const statusBadge = user.status === 'active' ? 'success' : user.status === 'blocked' ? 'danger' : 'warning';
            const statusText = user.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : user.status === 'blocked' ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–£–¥–∞–ª–µ–Ω';
            const subscription = user.subscription || {};
            let subscriptionLabel = '‚Äî';
            if (subscription.status_display) {
                subscriptionLabel = subscription.status_display;
            } else if (subscription.status) {
                subscriptionLabel = subscription.status;
            }
            row.innerHTML = `
                <td>${user.full_name || user.username || '‚Äî'}<div class="user-id">${user.telegram_id}</div></td>
                <td><span class="status-badge status-${statusBadge}">${statusText}</span></td>
                <td>${subscriptionLabel}</td>
                <td>${toLocaleCurrency(user.balance_rub)}</td>
                <td><button class="action-btn" data-action="view-user" data-user-id="${user.id}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button></td>
            `;
            els.usersTableBody.appendChild(row);
        });
        renderPagination(els.usersPagination, pagination, (page) => {
            state.caches.users.page = page;
            loadUsers({ force: true });
        });
    }

    async function viewUser(userId) {
        try {
            const details = await callApi(`/api/users/${userId}`);
            const user = details.user || {};
            const transactions = details.transactions || [];
            const lastTransaction = transactions[0];
            const info = [
                `–ò–º—è: ${user.full_name || user.username || user.telegram_id}`,
                `–ë–∞–ª–∞–Ω—Å: ${toLocaleCurrency(user.balance_rub)}`,
                lastTransaction ? `–ü–æ—Å–ª–µ–¥–Ω—è—è –æ–ø–µ—Ä–∞—Ü–∏—è: ${toLocaleCurrency(lastTransaction.amount_rub)} (${new Date(lastTransaction.created_at).toLocaleString('ru-RU')})` : '–ü–æ—Å–ª–µ–¥–Ω—è—è –æ–ø–µ—Ä–∞—Ü–∏—è: ‚Äî',
            ].join('\n');
            alert(info);
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    function renderSubscriptionsOverview(overview) {
        if (!els.subscriptionsOverview) return;
        els.subscriptionsOverview.innerHTML = '';
        if (!overview) return;
        const cards = [
            { label: '–í—Å–µ–≥–æ –ø–æ–¥–ø–∏—Å–æ–∫', value: overview.total ?? 0, emoji: 'üì¶' },
            { label: '–ê–∫—Ç–∏–≤–Ω—ã–µ', value: overview.active ?? 0, emoji: 'üü¢' },
            { label: '–¢—Ä–∏–∞–ª', value: overview.trials ?? 0, emoji: 'üéØ' },
            { label: '–ò—Å—Ç–µ–∫–∞—é—Ç 7 –¥–Ω–µ–π', value: overview.expiring_soon ?? 0, emoji: '‚è∞' },
        ];
        cards.forEach((card) => {
            const element = document.createElement('div');
            element.className = 'stat-card';
            element.innerHTML = `
                <div class="stat-header">
                    <div>
                        <div class="stat-value">${card.value.toLocaleString('ru-RU')}</div>
                        <div class="stat-label">${card.label}</div>
                    </div>
                    <div class="stat-icon">${card.emoji}</div>
                </div>
            `;
            els.subscriptionsOverview.appendChild(element);
        });
    }

    function renderSubscriptionsTable(items, pagination) {
        if (!els.subscriptionsTableBody) return;
        els.subscriptionsTableBody.innerHTML = '';
        const hasItems = Array.isArray(items) && items.length > 0;
        els.subscriptionsEmpty.style.display = hasItems ? 'none' : 'block';
        if (!hasItems) {
            renderPagination(els.subscriptionsPagination, null, () => {});
            return;
        }
        items.forEach((subscription) => {
            const row = document.createElement('tr');
            const user = subscription.user || {};
            const endDate = subscription.end_date ? new Date(subscription.end_date).toLocaleString('ru-RU') : '‚Äî';
            row.innerHTML = `
                <td>${user.full_name || user.username || '‚Äî'}<div class="user-id">${user.telegram_id ?? ''}</div></td>
                <td>${subscription.status_display || subscription.status}</td>
                <td>${endDate}</td>
                <td>${subscription.traffic_used_gb ?? 0}/${subscription.traffic_limit_gb ?? 0} –ì–ë</td>
                <td>${subscription.device_limit ?? 0}</td>
            `;
            els.subscriptionsTableBody.appendChild(row);
        });
        renderPagination(els.subscriptionsPagination, pagination, (page) => {
            state.caches.subscriptions.page = page;
            loadSubscriptions({ force: true });
        });
    }

    function renderExpiringSubscriptions(expiring) {
        if (!els.subscriptionsExpiring) return;
        const items = expiring?.items || [];
        els.subscriptionsExpiringBody.innerHTML = '';
        if (!items.length) {
            els.subscriptionsExpiringBody.innerHTML = '<tr><td colspan="5" style="padding: 24px; text-align: center; color: var(--text-tertiary);">–ù–µ—Ç –∏—Å—Ç–µ–∫–∞—é—â–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫</td></tr>';
        } else {
            items.forEach((subscription) => {
                const user = subscription.user || {};
                const endDate = subscription.end_date ? new Date(subscription.end_date).toLocaleString('ru-RU') : '‚Äî';
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.full_name || user.username || '‚Äî'}<div class="user-id">${user.telegram_id ?? ''}</div></td>
                    <td>${subscription.status_display || subscription.status}</td>
                    <td>${endDate}</td>
                    <td>${subscription.traffic_used_gb ?? 0}/${subscription.traffic_limit_gb ?? 0} –ì–ë</td>
                    <td>${subscription.device_limit ?? 0}</td>
                `;
                els.subscriptionsExpiringBody.appendChild(row);
            });
        }
        if (expiring?.period) {
            const from = new Date(expiring.period.from).toLocaleDateString('ru-RU');
            const to = new Date(expiring.period.to).toLocaleDateString('ru-RU');
            els.subscriptionsExpiringPeriod.textContent = `–ü–µ—Ä–∏–æ–¥: ${from} ‚Äî ${to}`;
        }
        els.subscriptionsExpiring.style.display = 'block';
    }

    function renderSupportOverview(overview) {
        if (!els.supportOverview) return;
        els.supportOverview.innerHTML = '';
        if (!overview) return;
        const cards = [
            { label: '–û—Ç–∫—Ä—ã—Ç—ã–µ', value: overview.open ?? 0, emoji: 'üî¥' },
            { label: '–° –æ—Ç–≤–µ—Ç–æ–º', value: overview.answered ?? 0, emoji: 'üü°' },
            { label: '–û–∂–∏–¥–∞—é—Ç', value: overview.pending ?? 0, emoji: '‚è≥' },
            { label: '–ó–∞–∫—Ä—ã—Ç—ã–µ', value: overview.closed ?? 0, emoji: 'üü¢' },
        ];
        cards.forEach((card) => {
            const element = document.createElement('div');
            element.className = 'stat-card';
            element.innerHTML = `
                <div class="stat-header">
                    <div>
                        <div class="stat-value">${card.value.toLocaleString('ru-RU')}</div>
                        <div class="stat-label">${card.label}</div>
                    </div>
                    <div class="stat-icon">${card.emoji}</div>
                </div>
            `;
            els.supportOverview.appendChild(element);
        });
    }

    function renderSupportTable(items) {
        if (!els.supportTableBody) return;
        els.supportTableBody.innerHTML = '';
        const hasItems = Array.isArray(items) && items.length > 0;
        els.supportEmpty.style.display = hasItems ? 'none' : 'block';
        if (!hasItems) return;
        items.forEach((ticket) => {
            const row = document.createElement('tr');
            const user = ticket.user || {};
            const updated = ticket.updated_at ? new Date(ticket.updated_at).toLocaleString('ru-RU') : '‚Äî';
            row.dataset.ticketId = ticket.id;
            row.innerHTML = `
                <td>${ticket.id}</td>
                <td>${user.full_name || user.username || user.telegram_id || '‚Äî'}</td>
                <td>${ticket.status_emoji || ''} ${ticket.status}</td>
                <td>${ticket.priority}</td>
                <td>${updated}</td>
            `;
            els.supportTableBody.appendChild(row);
        });
    }

    function renderSupportDetail(ticket) {
        if (!els.supportDetail) return;
        if (!ticket) {
            els.supportDetail.classList.add('hidden');
            return;
        }
        els.supportDetailTitle.textContent = `–¢–∏–∫–µ—Ç #${ticket.id} ‚Ä¢ ${ticket.title}`;
        els.supportDetailBody.innerHTML = '';
        (ticket.messages || []).forEach((message) => {
            const block = document.createElement('div');
            block.style.padding = '12px 0';
            block.innerHTML = `
                <div style="font-weight:600; color: var(--text-primary);">${message.is_admin ? '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
                <div style="color: var(--text-secondary); white-space: pre-wrap;">${message.text}</div>
                <div style="font-size:12px; color: var(--text-tertiary);">${message.created_at ? new Date(message.created_at).toLocaleString('ru-RU') : ''}</div>
            `;
            els.supportDetailBody.appendChild(block);
        });
        els.supportDetail.classList.remove('hidden');
    }

    function renderPromotionsOverview(overview) {
        if (!els.promotionsOverview) return;
        els.promotionsOverview.innerHTML = '';
        if (!overview) return;
        const cards = [
            { label: '–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤', value: overview.promocodes?.active ?? 0, emoji: 'üé´' },
            { label: '–í—Å–µ–≥–æ –∫–∞–º–ø–∞–Ω–∏–π', value: overview.campaigns?.total ?? 0, emoji: 'üì£' },
            { label: '–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π', value: overview.campaigns?.active ?? 0, emoji: 'üî•' },
            { label: '–ü—Ä–æ–º–æ-–≥—Ä—É–ø–ø—ã', value: overview.groups?.total ?? 0, emoji: 'üë•' },
        ];
        cards.forEach((card) => {
            const element = document.createElement('div');
            element.className = 'stat-card';
            element.innerHTML = `
                <div class="stat-header">
                    <div>
                        <div class="stat-value">${card.value.toLocaleString('ru-RU')}</div>
                        <div class="stat-label">${card.label}</div>
                    </div>
                    <div class="stat-icon">${card.emoji}</div>
                </div>
            `;
            els.promotionsOverview.appendChild(element);
        });
    }

    function renderPromocodes(codes) {
        if (!els.promocodesBody) return;
        els.promocodesBody.innerHTML = '';
        const hasItems = Array.isArray(codes) && codes.length > 0;
        els.promocodesEmpty.style.display = hasItems ? 'none' : 'block';
        if (!hasItems) return;
        codes.forEach((code) => {
            const row = document.createElement('tr');
            const bonus = code.balance_bonus_kopeks ? `${toLocaleCurrency(code.balance_bonus_kopeks / 100)} –Ω–∞ –±–∞–ª–∞–Ω—Å` : code.subscription_days ? `${code.subscription_days} –¥–Ω–µ–π` : '‚Äî';
            const usage = `${code.current_uses ?? 0} / ${code.max_uses ?? 0}`;
            const status = code.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–û—Ç–∫–ª—é—á–µ–Ω';
            row.innerHTML = `
                <td>${code.code}</td>
                <td>${code.type}</td>
                <td>${bonus}</td>
                <td>${usage}</td>
                <td>${status}</td>
            `;
            els.promocodesBody.appendChild(row);
        });
    }

    function renderCampaigns(campaigns) {
        if (!els.campaignsBody) return;
        els.campaignsBody.innerHTML = '';
        const hasItems = Array.isArray(campaigns) && campaigns.length > 0;
        els.campaignsEmpty.style.display = hasItems ? 'none' : 'block';
        if (!hasItems) return;
        campaigns.forEach((campaign) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${campaign.name}</td>
                <td>${campaign.start_parameter}</td>
                <td>${campaign.bonus_type}</td>
                <td>${campaign.registrations_count ?? 0}</td>
                <td>${campaign.is_active ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–û—Ç–∫–ª—é—á–µ–Ω–∞'}</td>
            `;
            els.campaignsBody.appendChild(row);
        });
    }

    function renderPromoGroups(groups) {
        if (!els.promoGroupsBody) return;
        els.promoGroupsBody.innerHTML = '';
        const hasItems = Array.isArray(groups) && groups.length > 0;
        els.promoGroupsEmpty.style.display = hasItems ? 'none' : 'block';
        if (!hasItems) return;
        groups.forEach((group) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${group.name}${group.is_default ? ' (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)' : ''}</td>
                <td>${group.server_discount_percent ?? 0}%</td>
                <td>${group.traffic_discount_percent ?? 0}%</td>
                <td>${group.device_discount_percent ?? 0}%</td>
                <td>${group.users_count ?? 0}</td>
            `;
            els.promoGroupsBody.appendChild(row);
        });
    }

    function renderCommunicationsOverview(overview) {
        if (!els.communicationsOverview) return;
        els.communicationsOverview.innerHTML = '';
        if (!overview) return;
        const cards = [
            { label: '–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π', value: overview.welcome?.active ?? 0, emoji: 'üëã' },
            { label: '–°–æ–æ–±—â–µ–Ω–∏–π –≤ –º–µ–Ω—é', value: overview.user_messages?.active ?? 0, emoji: 'üì®' },
        ];
        cards.forEach((card) => {
            const element = document.createElement('div');
            element.className = 'stat-card';
            element.innerHTML = `
                <div class="stat-header">
                    <div>
                        <div class="stat-value">${card.value.toLocaleString('ru-RU')}</div>
                        <div class="stat-label">${card.label}</div>
                    </div>
                    <div class="stat-icon">${card.emoji}</div>
                </div>
            `;
            els.communicationsOverview.appendChild(element);
        });
    }

    function renderWelcomeTexts(items) {
        if (!els.welcomeTextsList) return;
        els.welcomeTextsList.innerHTML = '';
        if (!Array.isArray(items) || !items.length) {
            els.welcomeTextsList.innerHTML = '<div class="settings-empty">–ù–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤</div>';
            return;
        }
        items.forEach((item) => {
            const block = document.createElement('div');
            block.className = 'setting-item';
            block.innerHTML = `
                <div>
                    <div class="setting-name">${item.is_enabled ? '–ê–∫—Ç–∏–≤–Ω–æ' : '–í—ã–∫–ª—é—á–µ–Ω–æ'}</div>
                    <div class="setting-key">ID ${item.id}</div>
                </div>
                <div class="setting-value">${item.text_content}</div>
                <div class="setting-actions">${item.is_active ? 'üü¢ –ê–∫—Ç–∏–≤–Ω–æ' : '‚ö™Ô∏è –ù–µ –∞–∫—Ç–∏–≤–Ω–æ'}</div>
            `;
            els.welcomeTextsList.appendChild(block);
        });
    }

    function renderUserMessages(items) {
        if (!els.userMessagesList) return;
        els.userMessagesList.innerHTML = '';
        if (!Array.isArray(items) || !items.length) {
            els.userMessagesList.innerHTML = '<div class="settings-empty">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
            return;
        }
        items.forEach((item) => {
            const block = document.createElement('div');
            block.className = 'setting-item';
            block.innerHTML = `
                <div>
                    <div class="setting-name">–°–æ–æ–±—â–µ–Ω–∏–µ #${item.id}</div>
                    <div class="setting-key">–ü–æ—Ä—è–¥–æ–∫: ${item.sort_order}</div>
                </div>
                <div class="setting-value">${item.message_text}</div>
                <div class="setting-actions">${item.is_active ? 'üü¢ –ê–∫—Ç–∏–≤–Ω–æ' : '‚ö™Ô∏è –í—ã–∫–ª—é—á–µ–Ω–æ'}</div>
            `;
            els.userMessagesList.appendChild(block);
        });
    }

    function countryCodeToEmoji(code) {
        if (!code) return 'üåç';
        const upper = code.trim().slice(0, 2).toUpperCase();
        return upper.replace(/./g, (char) => String.fromCodePoint(char.charCodeAt(0) + 127397));
    }

    function renderServers(servers) {
        state.servers = Array.isArray(servers) ? servers : [];
        if (els.navServersCount) {
            els.navServersCount.textContent = state.servers.length.toString();
        }
        if (!els.serversContainer || !els.serversEmpty) return;
        els.serversContainer.innerHTML = '';
        if (!state.servers.length) {
            els.serversEmpty.style.display = 'block';
            return;
        }
        els.serversEmpty.style.display = 'none';
        state.servers.forEach((server) => {
            const card = document.createElement('div');
            card.className = 'server-card';
            const capacity = server.capacity_percent ?? 0;
            const statusClass = server.is_available ? '' : 'offline';
            card.innerHTML = `
                <div class="server-card-header">
                    <div class="server-info">
                        <div class="server-flag">${countryCodeToEmoji(server.country_code)}</div>
                        <div>
                            <div class="server-name">${server.name}</div>
                            <div class="server-status-badge ${statusClass}">${server.status_label || (server.is_available ? '–î–æ—Å—Ç—É–ø–µ–Ω' : '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω')}</div>
                        </div>
                    </div>
                    <div class="server-stats">
                        <div class="server-capacity">
                            <div class="server-capacity-bar" style="width: ${capacity}%;"></div>
                            <div class="server-capacity-legend">${server.current_users ?? 0} / ${server.max_users ?? '‚àû'}</div>
                        </div>
                        <div class="server-price">${toLocaleCurrency(server.price_rub)}</div>
                    </div>
                </div>
            `;
            els.serversContainer.appendChild(card);
        });
    }

    function renderSettingsCategories(categories) {
        if (!els.settingsContainer) return;
        els.settingsContainer.innerHTML = '';
        if (!Array.isArray(categories) || !categories.length) {
            els.settingsContainer.innerHTML = '<div class="settings-empty">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</div>';
            return;
        }
        categories.sort((a, b) => (a.label || '').localeCompare(b.label || ''));
        categories.forEach((category) => {
            const details = document.createElement('details');
            details.className = 'setting-category';
            details.dataset.category = category.key;
            const summary = document.createElement('summary');
            summary.innerHTML = `<span>${category.label}</span><span class="settings-count">${category.count}</span>`;
            const itemsContainer = document.createElement('div');
            itemsContainer.className = 'setting-items';
            itemsContainer.innerHTML = '<div class="settings-empty">–û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏‚Ä¶</div>';
            details.appendChild(summary);
            details.appendChild(itemsContainer);
            details.addEventListener('toggle', async () => {
                if (details.open && !state.settingsCache.has(category.key)) {
                    await loadSettingsCategory(category.key, itemsContainer);
                }
            });
            els.settingsContainer.appendChild(details);
        });
    }

    async function loadSettingsCategory(key, container) {
        container.innerHTML = '<div class="settings-empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
        try {
            const items = await callApi(`/api/settings/category/${key}`);
            state.settingsCache.set(key, items);
            renderSettingItems(key, items, container);
        } catch (error) {
            container.innerHTML = `<div class="settings-empty">${error.message}</div>`;
        }
    }

    function renderSettingItems(categoryKey, items, container) {
        if (!items.length) {
            container.innerHTML = '<div class="settings-empty">–ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>';
            return;
        }
        const fragment = document.createDocumentFragment();
        items.forEach((item) => {
            const row = document.createElement('div');
            row.className = 'setting-item';
            row.dataset.key = item.key;
            row.innerHTML = `
                <div>
                    <div class="setting-name">${item.name}</div>
                    <div class="setting-key">${item.key}</div>
                </div>
                <div class="setting-value">
                    <span>${item.value_formatted}</span>
                    ${item.has_override ? '<span class="setting-override">–ò–∑–º–µ–Ω–µ–Ω–æ</span>' : ''}
                </div>
                <div class="setting-actions">
                    <button class="setting-button" data-action="edit-setting" data-key="${item.key}" data-category="${categoryKey}">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                    <button class="setting-button" data-action="reset-setting" data-key="${item.key}" data-category="${categoryKey}" ${item.has_override ? '' : 'disabled'}>–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
            `;
            fragment.appendChild(row);
        });
        container.innerHTML = '';
        container.appendChild(fragment);
    }

    async function editSetting(key, category) {
        const items = state.settingsCache.get(category) || [];
        const item = items.find((entry) => entry.key === key);
        if (!item) return;
        const choices = item.choices || [];
        const hint = choices.length ? `\n–í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:\n${choices.map((choice) => `‚Ä¢ ${choice.label} (${choice.value})`).join('\n')}` : '';
        const currentValue = item.value ?? '';
        const input = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è ¬´${item.name}¬ª${hint}`, currentValue);
        if (input === null) {
            return;
        }
        try {
            const payload = { value: input };
            if (input.trim().toLowerCase() === 'null' || input.trim() === '') {
                payload.value = null;
            }
            await callApi(`/api/settings/${key}`, { method: 'PUT', body: payload });
            showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
            state.settingsCache.delete(category);
            const details = els.settingsContainer.querySelector(`details[data-category="${category}"]`);
            if (details) {
                const itemsContainer = details.querySelector('.setting-items');
                await loadSettingsCategory(category, itemsContainer);
            }
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    async function resetSetting(key, category) {
        if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∫ –∑–Ω–∞—á–µ–Ω–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) {
            return;
        }
        try {
            await callApi(`/api/settings/${key}`, { method: 'DELETE' });
            showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞', 'success');
            state.settingsCache.delete(category);
            const details = els.settingsContainer.querySelector(`details[data-category="${category}"]`);
            if (details) {
                const itemsContainer = details.querySelector('.setting-items');
                await loadSettingsCategory(category, itemsContainer);
            }
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    function renderHealth(data) {
        state.health = data;
        const maintenance = data?.bot?.maintenance;
        if (els.botStatusIndicator) {
            els.botStatusIndicator.classList.remove('paused', 'stopped');
            if (maintenance) {
                els.botStatusIndicator.classList.add('paused');
            }
        }
        if (els.maintenanceLabel) {
            els.maintenanceLabel.textContent = maintenance ? '–í–∫–ª' : '–í—ã–∫–ª';
        }
        if (els.maintenanceActionLabel) {
            els.maintenanceActionLabel.textContent = maintenance ? '–í—ã–∫–ª—é—á–∏—Ç—å —Ç–µ—Ö—Ä–∞–±–æ—Ç—ã' : '–í–∫–ª—é—á–∏—Ç—å —Ç–µ—Ö—Ä–∞–±–æ—Ç—ã';
        }
    }

    function renderSystemOverview(health) {
        if (!els.systemOverview) return;
        els.systemOverview.innerHTML = '';
        if (!health) return;
        const cards = [
            { label: '–ë–æ—Ç', value: health.bot?.running ? '–†–∞–±–æ—Ç–∞–µ—Ç' : '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', emoji: health.bot?.running ? '‚úÖ' : '‚õî' },
            { label: '–¢–µ—Ö—Ä–∞–±–æ—Ç—ã', value: health.bot?.maintenance ? '–í–∫–ª—é—á–µ–Ω—ã' : '–í—ã–∫–ª—é—á–µ–Ω—ã', emoji: health.bot?.maintenance ? 'üöß' : 'üü¢' },
            { label: '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥', value: health.services?.monitoring_running ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–í—ã–∫–ª—é—á–µ–Ω', emoji: health.services?.monitoring_running ? 'üìà' : 'üõë' },
            { label: '–ê–≤—Ç–æ–±—ç–∫–∞–ø', value: health.services?.auto_backup_enabled ? '–í–∫–ª—é—á–µ–Ω' : '–í—ã–∫–ª—é—á–µ–Ω', emoji: 'üíæ' },
        ];
        cards.forEach((card) => {
            const element = document.createElement('div');
            element.className = 'stat-card';
            element.innerHTML = `
                <div class="stat-header">
                    <div>
                        <div class="stat-value">${card.value}</div>
                        <div class="stat-label">${card.label}</div>
                    </div>
                    <div class="stat-icon">${card.emoji}</div>
                </div>
            `;
            els.systemOverview.appendChild(element);
        });
        if (els.systemActions) {
            els.systemActions.innerHTML = '';
            const actions = [
                { label: '–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é', action: 'reload-config', emoji: 'üîÑ' },
                { label: '–°–æ–∑–¥–∞—Ç—å –±–µ–∫–∞–ø', action: 'create-backup', emoji: 'üíæ' },
                { label: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–Ω–µ–≤–Ω–æ–π –æ—Ç—á–µ—Ç', action: 'send-report', emoji: 'üì¨' },
                { label: health.bot?.maintenance ? '–í—ã–∫–ª—é—á–∏—Ç—å —Ç–µ—Ö—Ä–∞–±–æ—Ç—ã' : '–í–∫–ª—é—á–∏—Ç—å —Ç–µ—Ö—Ä–∞–±–æ—Ç—ã', action: 'toggle-maintenance', emoji: 'üöß' },
            ];
            actions.forEach((item) => {
                const btn = document.createElement('button');
                btn.className = 'action-btn';
                btn.type = 'button';
                btn.dataset.action = item.action;
                btn.innerHTML = `<span>${item.emoji}</span><span>${item.label}</span>`;
                els.systemActions.appendChild(btn);
            });
        }
    }

    function showLogin(message = '') {
        els.authOverlay.classList.remove('hidden');
        els.loginError.textContent = message;
        setTimeout(() => els.loginToken.focus(), 50);
    }

    function hideLogin() {
        els.authOverlay.classList.add('hidden');
        els.loginError.textContent = '';
        els.loginToken.value = '';
    }

    async function loadDashboard({ force = false } = {}) {
        const [summary, revenue, users, health] = await Promise.all([
            callApi('/api/dashboard/summary'),
            callApi('/api/dashboard/revenue?days=14'),
            callApi('/api/users/recent?limit=8'),
            callApi('/api/health'),
        ]);
        renderSummary(summary);
        renderRevenue(revenue);
        renderRecentUsers(users);
        renderHealth(health);
        await loadServers({ force, silent: true });
    }

    async function loadUsers({ force = false } = {}) {
        const cache = state.caches.users;
        if (!force && state.lastUsersPage === cache.page && state.lastUsersSearch === cache.search && state.lastUsersOrder === cache.order) {
            return;
        }
        const overview = await callApi('/api/users/overview');
        const params = new URLSearchParams({
            page: cache.page.toString(),
            limit: '20',
        });
        if (cache.search) params.set('search', cache.search);
        if (cache.order) params.set('order', cache.order);
        const list = await callApi(`/api/users?${params.toString()}`);
        renderUsersOverview(overview);
        renderUsersTable(list.items || [], list.pagination || {});
        state.lastUsersPage = cache.page;
        state.lastUsersSearch = cache.search;
        state.lastUsersOrder = cache.order;
    }

    async function loadSubscriptions({ force = false } = {}) {
        const cache = state.caches.subscriptions;
        if (!force && state.lastSubscriptionsPage === cache.page && state.lastSubscriptionsStatus === cache.status) {
            return;
        }
        const overview = await callApi('/api/subscriptions/overview');
        const params = new URLSearchParams({ page: cache.page.toString(), limit: '20' });
        if (cache.status) params.set('status', cache.status);
        const list = await callApi(`/api/subscriptions?${params.toString()}`);
        renderSubscriptionsOverview(overview);
        renderSubscriptionsTable(list.items || [], list.pagination || {});
        if (els.subscriptionsExpiring) {
            els.subscriptionsExpiring.style.display = 'none';
        }
        state.lastSubscriptionsPage = cache.page;
        state.lastSubscriptionsStatus = cache.status;
    }

    async function loadExpiringSubscriptions() {
        const expiring = await callApi('/api/subscriptions/expiring?days=7');
        renderExpiringSubscriptions(expiring);
    }

    async function loadSupport({ force = false } = {}) {
        const cache = state.caches.support;
        if (!force && state.lastSupportPage === cache.page && state.lastSupportStatus === cache.status) {
            return;
        }
        const overview = await callApi('/api/support/overview');
        const params = new URLSearchParams({ page: cache.page.toString(), limit: '20' });
        if (cache.status) params.set('status', cache.status);
        const list = await callApi(`/api/support/tickets?${params.toString()}`);
        renderSupportOverview(overview);
        renderSupportTable(list.items || []);
        renderSupportDetail(null);
        state.lastSupportPage = cache.page;
        state.lastSupportStatus = cache.status;
    }

    async function loadSupportDetail(ticketId) {
        const ticket = await callApi(`/api/support/tickets/${ticketId}`);
        renderSupportDetail(ticket);
    }

    async function loadPromotions() {
        const [overview, codes, campaigns, groups] = await Promise.all([
            callApi('/api/promotions/overview'),
            callApi('/api/promotions/promocodes'),
            callApi('/api/promotions/campaigns'),
            callApi('/api/promotions/groups'),
        ]);
        renderPromotionsOverview(overview);
        renderPromocodes(codes.items || []);
        renderCampaigns(campaigns.items || []);
        renderPromoGroups(groups.items || []);
    }

    async function loadCommunications() {
        const [overview, welcome, messages] = await Promise.all([
            callApi('/api/communications/overview'),
            callApi('/api/communications/welcome-texts'),
            callApi('/api/communications/user-messages'),
        ]);
        renderCommunicationsOverview(overview);
        renderWelcomeTexts(welcome.items || []);
        renderUserMessages(messages.items || []);
    }

    async function loadServers({ force = false, silent = false } = {}) {
        if (!force && state.servers.length) return;
        const data = await callApi('/api/servers');
        renderServers(data || []);
        if (!silent && state.currentView === 'servers') {
            // nothing extra
        }
    }

    async function ensureSettingsLoaded() {
        if (state.settingsLoaded) return;
        const categories = await callApi('/api/settings/categories');
        renderSettingsCategories(categories);
        state.settingsLoaded = true;
    }

    async function loadSystem() {
        if (!state.health) {
            const health = await callApi('/api/health');
            renderHealth(health);
        }
        renderSystemOverview(state.health);
    }

    async function switchView(view, { force = false } = {}) {
        if (!view) return;
        setActiveView(view);
        try {
            switch (view) {
                case 'dashboard':
                    await loadDashboard({ force });
                    break;
                case 'users':
                    await loadUsers({ force });
                    break;
                case 'subscriptions':
                    await loadSubscriptions({ force });
                    break;
                case 'support':
                    await loadSupport({ force });
                    break;
                case 'promotions':
                    await loadPromotions();
                    break;
                case 'communications':
                    await loadCommunications();
                    break;
                case 'servers':
                    await loadServers({ force: true });
                    break;
                case 'settings':
                    await ensureSettingsLoaded();
                    break;
                case 'system':
                    await loadSystem();
                    break;
                default:
                    break;
            }
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    async function handleAction(action) {
        try {
            switch (action) {
                case 'refresh':
                    await switchView(state.currentView, { force: true });
                    showToast('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                    break;
                case 'refresh-users':
                    await loadUsers({ force: true });
                    showToast('–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                    break;
                case 'reload-config':
                    await callApi('/api/bot/control', { method: 'POST', body: { action: 'reload_configuration' } });
                    showToast('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
                    break;
                case 'create-backup':
                    await callApi('/api/bot/control', { method: 'POST', body: { action: 'create_backup' } });
                    showToast('–ó–∞–¥–∞—á–∞ –Ω–∞ –±–µ–∫–∞–ø —Å–æ–∑–¥–∞–Ω–∞', 'success');
                    break;
                case 'send-report':
                    await callApi('/api/bot/control', { method: 'POST', body: { action: 'send_daily_report' } });
                    showToast('–û—Ç—á–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω', 'success');
                    break;
                case 'toggle-maintenance':
                    if (state.health?.bot?.maintenance) {
                        await callApi('/api/bot/control', { method: 'POST', body: { action: 'disable_maintenance' } });
                    } else {
                        await callApi('/api/bot/control', { method: 'POST', body: { action: 'enable_maintenance' } });
                    }
                    showToast('–°—Ç–∞—Ç—É—Å —Ç–µ—Ö—Ä–∞–±–æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                    state.health = await callApi('/api/health');
                    renderHealth(state.health);
                    renderSystemOverview(state.health);
                    break;
                default:
                    break;
            }
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    function bindEvents() {
        els.loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const token = els.loginToken.value.trim();
            if (!token) {
                els.loginError.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω';
                return;
            }
            try {
                await callApi('/api/auth/login', { method: 'POST', body: { token }, skipAuth: true });
                state.token = token;
                localStorage.setItem('webadminToken', token);
                hideLogin();
                await switchView('dashboard', { force: true });
            } catch (error) {
                els.loginError.textContent = error.message;
            }
        });

        document.addEventListener('click', (event) => {
            if (!els.botDropdown.contains(event.target) && !els.botControlBtn.contains(event.target)) {
                els.botDropdown.classList.remove('open');
            }
        });

        els.botControlBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            els.botDropdown.classList.toggle('open');
        });

        els.botDropdown.addEventListener('click', async (event) => {
            const action = event.target.closest('[data-action]')?.dataset.action;
            if (!action) return;
            els.botDropdown.classList.remove('open');
            if (action === 'logout') {
                state.token = '';
                localStorage.removeItem('webadminToken');
                showToast('–í—ã –≤—ã—à–ª–∏ –∏–∑ –ø–∞–Ω–µ–ª–∏', 'success');
                showLogin();
                return;
            }
            await handleAction(action);
        });

        els.navItems.forEach((item) => {
            item.addEventListener('click', (event) => {
                event.preventDefault();
                const view = item.dataset.view;
                if (view) {
                    switchView(view);
                }
            });
        });

        if (els.usersSearch) {
            els.usersSearch.addEventListener('input', (event) => {
                state.caches.users.search = event.target.value.trim();
                state.caches.users.page = 1;
                loadUsers({ force: true });
            });
        }

        if (els.usersOrder) {
            els.usersOrder.addEventListener('change', (event) => {
                state.caches.users.order = event.target.value;
                state.caches.users.page = 1;
                loadUsers({ force: true });
            });
        }

        if (els.subscriptionsStatus) {
            els.subscriptionsStatus.addEventListener('change', (event) => {
                state.caches.subscriptions.status = event.target.value;
                state.caches.subscriptions.page = 1;
                loadSubscriptions({ force: true });
            });
        }

        if (els.subscriptionsExpiringBtn) {
            els.subscriptionsExpiringBtn.addEventListener('click', async () => {
                await loadExpiringSubscriptions();
            });
        }

        if (els.supportStatus) {
            els.supportStatus.addEventListener('change', (event) => {
                state.caches.support.status = event.target.value;
                state.caches.support.page = 1;
                loadSupport({ force: true });
            });
        }

        if (els.supportTableBody) {
            els.supportTableBody.addEventListener('click', async (event) => {
                const row = event.target.closest('tr[data-ticket-id]');
                if (!row) return;
                const ticketId = Number(row.dataset.ticketId);
                if (Number.isNaN(ticketId)) return;
                const detail = await callApi(`/api/support/tickets/${ticketId}`);
                renderSupportDetail(detail);
            });
        }

        if (els.supportDetailClose) {
            els.supportDetailClose.addEventListener('click', () => renderSupportDetail(null));
        }

        if (els.systemActions) {
            els.systemActions.addEventListener('click', async (event) => {
                const btn = event.target.closest('[data-action]');
                if (!btn) return;
                await handleAction(btn.dataset.action);
            });
        }

        if (els.searchInput) {
            els.searchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    const query = event.target.value.trim();
                    state.caches.users.search = query;
                    state.caches.users.page = 1;
                    switchView('users', { force: true });
                }
            });
        }

        if (els.settingsContainer) {
            els.settingsContainer.addEventListener('click', async (event) => {
                const target = event.target.closest('[data-action]');
                if (!target) return;
                const { action, key, category } = target.dataset;
                if (!key || !category) return;
                if (action === 'edit-setting') {
                    await editSetting(key, category);
                } else if (action === 'reset-setting') {
                    await resetSetting(key, category);
                }
            });
        }

        [els.recentUsersBody, els.usersTableBody].forEach((table) => {
            if (!table) return;
            table.addEventListener('click', (event) => {
                const button = event.target.closest('[data-action="view-user"]');
                if (!button) return;
                const userId = Number(button.dataset.userId);
                if (Number.isNaN(userId)) return;
                viewUser(userId);
            });
        });
    }

    async function init() {
        bindEvents();
        if (state.token) {
            try {
                await switchView('dashboard', { force: true });
            } catch (error) {
                showToast(error.message, 'error');
                showLogin('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ö–æ–¥ –∑–∞–Ω–æ–≤–æ');
            }
        } else {
            showLogin();
        }
    }

    document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
