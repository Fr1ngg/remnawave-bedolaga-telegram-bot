<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{WEBADMIN_TITLE}} ‚Ä¢ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0b0d;
            --bg-secondary: #141519;
            --bg-tertiary: #1c1d24;
            --bg-hover: #25262f;
            --text-primary: #e4e4e7;
            --text-secondary: #9ca3af;
            --text-tertiary: #6b7280;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: rgba(255, 255, 255, 0.08);
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .bg-animation {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: -1;
            opacity: 0.3;
            background: radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 20%, rgba(16, 185, 129, 0.05) 0%, transparent 50%);
            animation: bgShift 20s ease-in-out infinite;
        }

        @keyframes bgShift {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(-20px, -20px) scale(1.05); }
            50% { transform: translate(20px, -30px) scale(1.1); }
            75% { transform: translate(-30px, 20px) scale(1.05); }
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: var(--accent-gradient);
            opacity: 0.1;
            filter: blur(100px);
        }

        .logo {
            padding: 28px 24px;
            border-bottom: 1px solid var(--border);
            position: relative;
            z-index: 1;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            background: var(--accent-gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo .status {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 10px var(--success); }
            50% { box-shadow: 0 0 20px var(--success), 0 0 30px var(--success); }
            100% { box-shadow: 0 0 10px var(--success); }
        }

        .nav {
            flex: 1;
            padding: 24px 16px;
            overflow-y: auto;
            position: relative;
            z-index: 1;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-tertiary);
            padding: 0 12px;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
            margin-bottom: 4px;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: var(--accent-gradient);
            opacity: 0.1;
            transition: width 0.3s ease;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transform: translateX(4px);
        }

        .nav-item:hover::before {
            width: 100%;
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--accent-primary);
            font-weight: 500;
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 3px;
            height: 20px;
            background: var(--accent-primary);
            border-radius: 0 3px 3px 0;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--accent-primary);
            color: white;
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 24px;
        }

        .section-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-search {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            min-width: 240px;
        }

        .section-search:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .table-caption {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .card-list {
            display: grid;
            gap: 16px;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        }

        .simple-list {
            list-style: none;
            margin: 8px 0 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
            color: var(--text-secondary);
        }

        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 20px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .search-box {
            position: relative;
            width: 400px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
            opacity: 0.5;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .header-btn:hover {
            background: var(--bg-hover);
            transform: translateY(-2px);
        }

        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 18px;
            height: 18px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-menu:hover {
            background: var(--bg-hover);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--accent-gradient);
            display: flex;
            align.items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: white;
        }

        .content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .page-subtitle {
            color: var(--text-secondary);
            margin-bottom: 32px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--accent-gradient);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-icon.users { background: linear-gradient(135deg, #667eea, #764ba2); }
        .stat-icon.money { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .stat-icon.servers { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        .stat-icon.chart { background: linear-gradient(135deg, #43e97b, #38f9d7); }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.05);
        }

        .stat-change.positive {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .stat-change.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
            min-height: 320px;
            position: relative;
            overflow: hidden;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            background: var(--accent-gradient);
            opacity: 0.05;
            filter: blur(100px);
            border-radius: 50%;
        }

        .chart-placeholder {
            text-align: center;
            color: var(--text-tertiary);
        }

        .chart-bars {
            position: relative;
            display: flex;
            align-items: flex-end;
            justify-content: flex-start;
            gap: 16px;
            height: 240px;
            padding: 24px 12px 12px;
        }

        .chart-bar {
            position: relative;
            flex: 1;
            min-width: 32px;
            border-radius: 10px 10px 0 0;
            background: linear-gradient(180deg, rgba(99, 102, 241, 0.85), rgba(139, 92, 246, 0.4));
            overflow: hidden;
        }

        .chart-bar-value {
            position: absolute;
            top: -28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chart-bar-label {
            position: absolute;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: var(--text-tertiary);
            white-space: nowrap;
        }

        .quick-actions {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 24px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .action-btn.primary {
            background: var(--accent-gradient);
            color: white;
            border: none;
        }

        .action-btn:hover {
            background: var(--bg-tertiary);
            transform: translateY(-2px);
        }

        .action-btn.primary:hover {
            opacity: 0.95;
            transform: translateY(-2px);
        }

        .servers-section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .server-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .server-card.expanded {
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: var(--shadow);
        }

        .server-card-header {
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .server-card-header:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .server-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .server-flag {
            font-size: 32px;
        }

        .server-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .server-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 12px;
            background: rgba(99, 102, 241, 0.12);
            color: var(--accent-primary);
        }

        .server-status-badge.offline {
            background: rgba(239, 68, 68, 0.12);
            color: var(--danger);
        }

        .server-stats {
            display: flex;
            gap: 32px;
            align-items: center;
        }

        .server-stat {
            text-align: center;
        }

        .server-stat-value {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .server-stat-label {
            font-size: 12px;
            color: var(--text-tertiary);
            text-transform: uppercase;
        }

        .expand-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: var(--bg-tertiary);
            transition: transform 0.3s ease;
        }

        .server-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .server-expanded-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            border-top: 1px solid var(--border);
        }

        .server-card.expanded .server-expanded-content {
            max-height: 400px;
        }

        .server-expanded-inner {
            padding: 20px 24px 24px;
        }

        .server-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .server-detail {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(99, 102, 241, 0.12);
        }

        .server-detail-title {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-tertiary);
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        .server-detail-value {
            font-size: 16px;
            font-weight: 600;
        }

        .server-description {
            margin-top: 16px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .table-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 32px;
        }

        .table-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .table-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: rgba(255, 255, 255, 0.02);
        }

        th, td {
            padding: 16px 24px;
            text-align: left;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        th {
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
        }

        tbody tr:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .user-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar-small {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--accent-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .user-id {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
        }

        .status-badge.trial {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .status-badge.expired {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .status-badge.completed {
            background: rgba(16, 185, 129, 0.12);
            color: var(--success);
        }

        .status-badge.pending {
            background: rgba(245, 158, 11, 0.12);
            color: var(--warning);
        }

        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 24px;
        }

        .filter-select {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            min-width: 180px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .transactions-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 18px 22px;
        }

        .summary-subtitle {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-tertiary);
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .summary-caption {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .summary-caption strong {
            color: var(--text-primary);
        }

        .table-pagination {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            margin-top: -12px;
            margin-bottom: 24px;
        }

        .transaction-meta {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .transaction-id {
            font-weight: 600;
        }

        .transaction-date {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .transaction-type {
            font-weight: 500;
        }

        .transaction-description,
        .transaction-external-id {
            margin-top: 6px;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .transaction-amount {
            font-weight: 600;
        }

        .transaction-amount.positive {
            color: var(--success);
        }

        .transaction-amount.negative {
            color: var(--danger);
        }

        .table-actions-cell {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .icon-btn:hover {
            background: var(--bg-hover);
            transform: scale(1.1);
        }
        .settings-section {
            margin-bottom: 48px;
        }

        .settings-section h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .settings-section p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .settings-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .setting-category {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }

        .setting-category summary {
            list-style: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 24px;
            font-weight: 600;
            transition: background 0.2s ease;
        }

        .setting-category summary::-webkit-details-marker {
            display: none;
        }

        .setting-category[open] summary {
            background: rgba(99, 102, 241, 0.05);
        }

        .settings-count {
            font-size: 12px;
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
            padding: 4px 10px;
            border-radius: 999px;
        }

        .setting-items {
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .setting-item {
            display: grid;
            grid-template-columns: minmax(220px, 1fr) minmax(200px, 1fr) 160px;
            gap: 16px;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .setting-key {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .setting-value {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .setting-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .setting-button {
            padding: 8px 14px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .setting-button:hover:enabled {
            background: var(--bg-hover);
        }

        .setting-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .setting-override {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
            width: fit-content;
        }

        .settings-empty {
            padding: 20px 24px;
            color: var(--text-secondary);
        }

        .settings-empty small {
            color: var(--text-tertiary);
        }

        .bot-control {
            position: relative;
        }

        .bot-control-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .bot-control-btn:hover {
            background: var(--bg-hover);
        }

        .bot-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        .bot-status.paused {
            background: var(--warning);
            box-shadow: 0 0 10px var(--warning);
        }

        .bot-status.stopped {
            background: var(--danger);
            box-shadow: 0 0 10px var(--danger);
        }

        .bot-dropdown {
            position: absolute;
            right: 0;
            top: calc(100% + 8px);
            width: 240px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 8px;
            display: none;
            flex-direction: column;
            gap: 4px;
            box-shadow: var(--shadow);
            z-index: 10;
        }

        .bot-dropdown.open {
            display: flex;
        }

        .bot-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s ease;
            color: var(--text-primary);
        }

        .bot-dropdown-item:hover {
            background: var(--bg-tertiary);
        }

        .bot-dropdown-item.warning {
            color: var(--warning);
        }

        .bot-dropdown-item.danger {
            color: var(--danger);
        }

        .bot-dropdown-divider {
            height: 1px;
            background: var(--border);
            margin: 4px 0;
        }

        .auth-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 11, 13, 0.85);
            backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 32px;
            width: min(420px, 92%);
            box-shadow: var(--shadow);
        }

        .auth-modal h2 {
            font-size: 22px;
            margin-bottom: 8px;
            text-align: center;
        }

        .auth-modal p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            text-align: center;
        }

        .auth-modal input {
            width: 100%;
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .auth-modal button {
            margin-top: 18px;
            width: 100%;
            padding: 14px 18px;
            border-radius: 12px;
            border: none;
            background: var(--accent-gradient);
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
        }

        .auth-error {
            color: var(--danger);
            margin-top: 12px;
            text-align: center;
            min-height: 20px;
        }

        .toast-container {
            position: fixed;
            right: 24px;
            bottom: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 2100;
        }

        .toast {
            min-width: 220px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px 18px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .toast.success {
            border-color: rgba(16, 185, 129, 0.5);
        }

        .toast.error {
            border-color: rgba(239, 68, 68, 0.5);
        }

        .toast.warning {
            border-color: rgba(245, 158, 11, 0.5);
        }

        .maintenance-label {
            font-weight: 600;
            color: var(--accent-primary);
        }

        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                transform: translateX(-100%);
                z-index: 1000;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .search-box {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .setting-item {
                grid-template-columns: 1fr;
                gap: 12px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
<div class="bg-animation"></div>
<div id="auth-overlay" class="auth-overlay hidden">
    <div class="auth-modal">
        <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h2>
        <p>–í–≤–µ–¥–∏—Ç–µ –∞–¥–º–∏–Ω-—Ç–æ–∫–µ–Ω –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</p>
        <form id="login-form">
            <input id="login-token" type="password" placeholder="API —Ç–æ–∫–µ–Ω" autocomplete="off" required>
            <button type="submit">–í–æ–π—Ç–∏</button>
            <div id="login-error" class="auth-error"></div>
        </form>
    </div>
</div>
<div id="toast-container" class="toast-container"></div>
<div class="container">
    <aside class="sidebar">
        <div class="logo">
            <h1>
                <span class="status"></span>
                <span id="sidebar-title">{{WEBADMIN_TITLE}}</span>
            </h1>
        </div>
        <nav class="nav">
            <div class="nav-section">
                <div class="nav-section-title">–û–±–∑–æ—Ä</div>
                <a href="#" class="nav-item active" data-section-target="dashboard">
                    <span class="nav-icon">üìä</span>
                    <span>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</span>
                </a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">Remnawave</div>
                <a href="#" class="nav-item" data-section-target="remnawave-overview">
                    <span class="nav-icon">üõ∞Ô∏è</span>
                    <span>–û–±–∑–æ—Ä</span>
                </a>
                <a href="#" class="nav-item" data-section-target="remnawave-nodes">
                    <span class="nav-icon">üåê</span>
                    <span>–ù–æ–¥—ã</span>
                </a>
                <a href="#" class="nav-item" data-section-target="remnawave-squads">
                    <span class="nav-icon">üë•</span>
                    <span>–°–∫–≤–∞–¥—ã</span>
                </a>
                <a href="#" class="nav-item" data-section-target="remnawave-sync">
                    <span class="nav-icon">üîÑ</span>
                    <span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</span>
                </a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
                <a href="#" class="nav-item" data-section-target="users">
                    <span class="nav-icon">üë•</span>
                    <span>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
                </a>
                <a href="#" class="nav-item" data-section-target="transactions">
                    <span class="nav-icon">üí≥</span>
                    <span>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</span>
                </a>
                <a href="#" class="nav-item" data-section-target="servers">
                    <span class="nav-icon">üñ•Ô∏è</span>
                    <span>–°–µ—Ä–≤–µ—Ä—ã</span>
                    <span class="nav-badge" id="nav-servers-count">‚Äî</span>
                </a>
                <a href="#" class="nav-item" data-section-target="promocodes">
                    <span class="nav-icon">üé´</span>
                    <span>–ü—Ä–æ–º–æ–∫–æ–¥—ã</span>
                </a>
            </div>
            <div class="nav-section">
                <div class="nav-section-title">–°–∏—Å—Ç–µ–º–∞</div>
                <a href="#" class="nav-item" data-section-target="support">
                    <span class="nav-icon">üõü</span>
                    <span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
                </a>
                <a href="#" class="nav-item" data-section-target="updates">
                    <span class="nav-icon">‚¨ÜÔ∏è</span>
                    <span>–û–±–Ω–æ–≤–ª–µ–Ω–∏—è</span>
                </a>
                <a href="#" class="nav-item" data-section-target="settings">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞</span>
                </a>
            </div>
        </nav>
    </aside>
    <main class="main">
        <header class="header">
            <div class="header-left">
                <div class="search-box">
                    <input type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, ID, email..." id="search-input">
                </div>
            </div>
            <div class="header-right">
                <div class="bot-control">
                    <button class="bot-control-btn" id="bot-control-btn" type="button">
                        <span class="bot-status" id="bot-status-indicator"></span>
                        <span data-bot-state>–ë–æ—Ç –∞–∫—Ç–∏–≤–µ–Ω</span>
                        <span class="bot-control-caret">‚ñº</span>
                    </button>
                    <div class="bot-dropdown" id="bot-dropdown">
                        <div class="bot-dropdown-item" data-action="reload-config">
                            <span>üîÑ</span>
                            <span>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é</span>
                        </div>
                        <div class="bot-dropdown-item" data-action="create-backup">
                            <span>üíæ</span>
                            <span>–°–æ–∑–¥–∞—Ç—å –±–µ–∫–∞–ø</span>
                        </div>
                        <div class="bot-dropdown-item" data-action="send-report">
                            <span>üì¨</span>
                            <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–Ω–µ–≤–Ω–æ–π –æ—Ç—á–µ—Ç</span>
                        </div>
                        <div class="bot-dropdown-divider"></div>
                        <div class="bot-dropdown-item warning" data-action="toggle-maintenance">
                            <span>üöß</span>
                            <span>–†–µ–∂–∏–º —Ç–µ—Ö—Ä–∞–±–æ—Ç: <span class="maintenance-label" data-maintenance-label>–í—ã–∫–ª</span></span>
                        </div>
                        <div class="bot-dropdown-divider"></div>
                        <div class="bot-dropdown-item danger" data-action="logout">
                            <span>üö™</span>
                            <span>–í—ã–π—Ç–∏</span>
                        </div>
                    </div>
                </div>
                <div class="user-menu" id="user-menu">
                    <div class="user-avatar" id="user-avatar">A</div>
                    <div>
                        <div style="font-size: 14px; font-weight: 500;" id="user-name">Admin</div>
                        <div style="font-size: 12px; color: var(--text-tertiary);">–°—É–ø–µ—Ä –∞–¥–º–∏–Ω</div>
                    </div>
                </div>
            </div>
        </header>
        <div class="content">
            <section class="content-section active" data-section="dashboard">
                <h1 class="page-title">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h1>
                <p class="page-subtitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è VPN –±–æ—Ç–æ–º</p>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="stat-total-users">‚Äî</div>
                                <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                            </div>
                            <div class="stat-icon users">üë•</div>
                        </div>
                        <span class="stat-change" id="stat-users-change">‚Äî</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="stat-revenue">‚Äî</div>
                                <div class="stat-label">–î–æ—Ö–æ–¥ –∑–∞ 30 –¥–Ω–µ–π</div>
                            </div>
                            <div class="stat-icon money">üí∞</div>
                        </div>
                        <span class="stat-change" id="stat-revenue-change">‚Äî</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="stat-servers">‚Äî</div>
                                <div class="stat-label">–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã</div>
                            </div>
                            <div class="stat-icon servers">üñ•Ô∏è</div>
                        </div>
                        <span class="stat-change" id="stat-servers-change">‚Äî</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-header">
                            <div>
                                <div class="stat-value" id="stat-conversion">‚Äî</div>
                                <div class="stat-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è —Ç—Ä–∏–∞–ª ‚Üí –ø–ª–∞—Ç–Ω–∞—è</div>
                            </div>
                            <div class="stat-icon chart">üìà</div>
                        </div>
                        <span class="stat-change" id="stat-conversion-change">‚Äî</span>
                    </div>
                </div>
                <div class="chart-container" id="revenue-chart">
                    <div class="chart-placeholder">
                        <div style="font-size: 42px; margin-bottom: 12px;">üìä</div>
                        <div style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">–ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ–¥–∞–∂</div>
                        <div style="font-size: 14px;">–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</div>
                    </div>
                </div>
                <div class="quick-actions">
                    <button class="action-btn primary" data-action="refresh">
                        <span>üîÑ</span>
                        <span>–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</span>
                    </button>
                    <button class="action-btn" data-action="reload-config">
                        <span>‚öôÔ∏è</span>
                        <span>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é</span>
                    </button>
                    <button class="action-btn" data-action="create-backup">
                        <span>üíæ</span>
                        <span>–°–æ–∑–¥–∞—Ç—å –±–µ–∫–∞–ø</span>
                    </button>
                    <button class="action-btn" data-action="toggle-maintenance">
                        <span>üöß</span>
                        <span id="maintenance-action-label">–í–∫–ª—é—á–∏—Ç—å —Ç–µ—Ö—Ä–∞–±–æ—Ç—ã</span>
                    </button>
                </div>
                <section style="margin-bottom: 32px;">
                    <h2 class="servers-section-title">
                        <span>üñ•Ô∏è</span>
                        <span>–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä—ã</span>
                        <span style="background: var(--success); color: white; font-size: 12px; padding: 4px 12px; border-radius: 20px;" id="servers-online-badge">‚Äî –æ–Ω–ª–∞–π–Ω</span>
                    </h2>
                    <div id="servers-list"></div>
                </section>
                <section class="table-container">
                    <div class="table-header">
                        <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
                        <button class="action-btn" data-action="refresh-users">
                            <span>üîÑ</span>
                            <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
                        </button>
                    </div>
                    <table>
                        <thead>
                        <tr>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ü–æ–¥–ø–∏—Å–∫–∞</th>
                            <th>–ë–∞–ª–∞–Ω—Å</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody id="recent-users-body">
                        <tr>
                            <td colspan="5" style="padding: 32px; text-align: center; color: var(--text-tertiary);">
                                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </section>
            </section>

            <section class="content-section" data-section="users">
                <div class="section-header">
                    <div>
                        <h1 class="page-title">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
                        <p class="page-subtitle">–ü–æ–∏—Å–∫, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö</p>
                    </div>
                    <div class="section-actions">
                        <input type="text" id="users-search-input" class="section-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, ID –∏–ª–∏ username">
                        <button class="action-btn" data-action="users-refresh">
                            <span>üîÑ</span>
                            <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <div class="table-header">
                        <h3>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                        <span id="users-total-label" class="table-caption">‚Äî</span>
                    </div>
                    <table>
                        <thead>
                        <tr>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–ü–æ–¥–ø–∏—Å–∫–∞</th>
                            <th>–ë–∞–ª–∞–Ω—Å</th>
                            <th>–°–æ–∑–¥–∞–Ω</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody id="users-table-body">
                        <tr><td colspan="5" style="padding: 32px; text-align: center; color: var(--text-ter—Ç–∏ary);">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∏—Å–∫–∞</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="users-pagination"></div>
            </section>

            <section class="content-section" data-section="transactions">
                <div class="section-header">
                    <div>
                        <h1 class="page-title">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</h1>
                        <p class="page-subtitle">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π, –æ–ø–ª–∞—Ç –∏ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤ –ø–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</p>
                    </div>
                    <div class="section-actions">
                        <button class="action-btn" data-action="transactions-refresh">
                            <span>üîÑ</span>
                            <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
                        </button>
                        <button class="action-btn" data-action="transactions-reset">
                            <span>üßπ</span>
                            <span>–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</span>
                        </button>
                    </div>
                </div>
                <div class="filters-row">
                    <input type="search" id="transactions-search-input" class="section-search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–ª–∏ ID">
                    <select id="transactions-type-filter" class="filter-select">
                        <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                        <option value="deposit">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</option>
                        <option value="subscription_payment">–û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏</option>
                        <option value="withdrawal">–°–ø–∏—Å–∞–Ω–∏–µ</option>
                        <option value="refund">–í–æ–∑–≤—Ä–∞—Ç</option>
                        <option value="referral_reward">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞</option>
                    </select>
                    <select id="transactions-status-filter" class="filter-select">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                        <option value="pending">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                    </select>
                    <select id="transactions-payment-filter" class="filter-select">
                        <option value="">–í—Å–µ –º–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã</option>
                        <option value="telegram_stars">Telegram Stars</option>
                        <option value="tribute">Tribute</option>
                        <option value="yookassa">YooKassa</option>
                        <option value="cryptobot">CryptoBot</option>
                        <option value="mulenpay">MulenPay</option>
                        <option value="pal24">PAL24</option>
                        <option value="manual">–í—Ä—É—á–Ω—É—é</option>
                    </select>
                </div>
                <div class="transactions-summary">
                    <div class="summary-card">
                        <div class="summary-subtitle">–û–±–æ—Ä–æ—Ç</div>
                        <div class="summary-value" id="transactions-summary-income">‚Äî</div>
                        <div class="summary-caption">–†–∞—Å—Ö–æ–¥—ã: <strong id="transactions-summary-expense">‚Äî</strong></div>
                        <div class="summary-caption">–ß–∏—Å—Ç—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <strong id="transactions-summary-net">‚Äî</strong></div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-subtitle">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</div>
                        <div class="summary-value" id="transactions-summary-total-count">‚Äî</div>
                        <div class="summary-caption">–ó–∞–≤–µ—Ä—à–µ–Ω–æ: <strong id="transactions-summary-completed">‚Äî</strong></div>
                        <div class="summary-caption">–í –æ–±—Ä–∞–±–æ—Ç–∫–µ: <strong id="transactions-summary-pending">‚Äî</strong></div>
                    </div>
                </div>
                <div class="table-container">
                    <div class="table-header">
                        <h3>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h3>
                        <span id="transactions-total-label" class="table-caption">‚Äî</span>
                    </div>
                    <table>
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–¢–∏–ø</th>
                            <th>–°—É–º–º–∞</th>
                            <th>–ú–µ—Ç–æ–¥</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                        </tr>
                        </thead>
                        <tbody id="transactions-table-body">
                        <tr><td colspan="6" style="padding: 32px; text-align: center; color: var(--text-tertiary);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="table-pagination" id="transactions-pagination"></div>
            </section>

            <section class="content-section" data-section="remnawave-overview">
                <div class="section-header">
                    <div>
                        <h1 class="page-title">Remnawave ‚Ä¢ –û–±–∑–æ—Ä</h1>
                        <p class="page-subtitle">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–∞–Ω–µ–ª–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã</p>
                    </div>
                    <div class="section-actions">
                        <button class="action-btn" data-action="rw-refresh-overview">
                            <span>üîÑ</span>
                            <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
                        </button>
                    </div>
                </div>
                <div id="rw-overview-cards" class="stats-grid" style="margin-bottom: 24px;"></div>
                <div class="table-container">
                    <div class="table-header">
                        <h3>–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã</h3>
                        <span id="rw-overview-updated" class="table-caption">‚Äî</span>
                    </div>
                    <div id="rw-overview-details" class="settings-container"></div>
                </div>
            </section>

            <section class="content-section" data-section="remnawave-nodes">
                <div class="section-header">
                    <div>
                        <h1 class="page-title">Remnawave ‚Ä¢ –ù–æ–¥—ã</h1>
                        <p class="page-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º –Ω–æ–¥ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞–≥—Ä—É–∑–∫–∏</p>
                    </div>
                    <div class="section-actions">
                        <button class="action-btn" data-action="rw-restart-all-nodes">
                            <span>‚ö°</span>
                            <span>–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ</span>
                        </button>
                        <button class="action-btn" data-action="rw-refresh-nodes">
                            <span>üîÑ</span>
                            <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
                        </button>
                    </div>
                </div>
                <div id="rw-nodes-container" class="card-list"></div>
            </section>

            <section class="content-section" data-section="remnawave-squads">
                <div class="section-header">
                    <div>
                        <h1 class="page-title">Remnawave ‚Ä¢ –°–∫–≤–∞–¥—ã</h1>
                        <p class="page-subtitle">–°–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ —Å–∫–≤–∞–¥–∞–º–∏</p>
                    </div>
                    <div class="section-actions">
                        <button class="action-btn" data-action="rw-create-squad">
                            <span>‚ûï</span>
                            <span>–°–æ–∑–¥–∞—Ç—å —Å–∫–≤–∞–¥</span>
                        </button>
                        <button class="action-btn" data-action="rw-refresh-squads">
                            <span>üîÑ</span>
                            <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
                        </button>
                    </div>
                </div>
                <div id="rw-squads-container" class="card-list"></div>
            </section>

            <section class="content-section" data-section="remnawave-sync">
                <div class="section-header">
                    <div>
                        <h1 class="page-title">Remnawave ‚Ä¢ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è</h1>
                        <p class="page-subtitle">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –ø–æ–¥–ø–∏—Å–æ–∫ –º–µ–∂–¥—É –±–æ—Ç–æ–º –∏ –ø–∞–Ω–µ–ª—å—é</p>
                    </div>
                    <div class="section-actions">
                        <button class="action-btn" data-action="rw-refresh-sync">
                            <span>üîÑ</span>
                            <span>–û–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</span>
                        </button>
                    </div>
                </div>
                <div id="rw-sync-recommendations" class="settings-container" style="margin-bottom: 24px;"></div>
                <div class="quick-actions" id="rw-sync-actions"></div>
                <div class="table-container" style="margin-top: 24px;">
                    <div class="table-header">
                        <h3>–ñ—É—Ä–Ω–∞–ª –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
                    </div>
                    <div id="rw-sync-log" class="settings-empty">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏‚Ä¶</div>
                </div>
            </section>

            <section class="content-section" data-section="servers">
                <div class="section-header">
                    <div>
                        <h1 class="page-title">–°–µ—Ä–≤–µ—Ä—ã</h1>
                        <p class="page-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ—á–∫–∞–º–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Remnawave</p>
                    </div>
                    <div class="section-actions">
                        <button class="action-btn" data-action="servers-sync">
                            <span>üîÑ</span>
                            <span>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å –ø–∞–Ω–µ–ª—å—é</span>
                        </button>
                        <button class="action-btn" data-action="servers-refresh">
                            <span>üîÅ</span>
                            <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
                        </button>
                    </div>
                </div>
                <div id="servers-management-list" class="card-list"></div>
            </section>

            <section class="content-section" data-section="promocodes">
                <div class="section-header">
                    <div>
                        <h1 class="page-title">–ü—Ä–æ–º–æ–∫–æ–¥—ã</h1>
                        <p class="page-subtitle">–°–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</p>
                    </div>
                    <div class="section-actions">
                        <button class="action-btn" data-action="promocode-create">
                            <span>‚ûï</span>
                            <span>–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥</span>
                        </button>
                        <button class="action-btn" data-action="promocodes-refresh">
                            <span>üîÑ</span>
                            <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <div class="table-header">
                        <h3>–°–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</h3>
                        <span id="promocodes-total" class="table-caption">‚Äî</span>
                    </div>
                    <table>
                        <thead>
                        <tr>
                            <th>–ö–æ–¥</th>
                            <th>–¢–∏–ø</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody id="promocodes-table-body">
                        <tr><td colspan="5" style="padding: 32px; text-align: center; color: var(--text-ter–∏—Ç–∏ary);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination" id="promocodes-pagination"></div>
            </section>

            <section class="content-section" data-section="support">
                <div class="section-header">
                    <div>
                        <h1 class="page-title">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</h1>
                        <p class="page-subtitle">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã —Ç–∏–∫–µ—Ç–æ–≤ –∏ —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–≤</p>
                    </div>
                    <div class="section-actions">
                        <button class="action-btn" data-action="support-refresh">
                            <span>üîÑ</span>
                            <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
                        </button>
                    </div>
                </div>
                <div class="settings-container" id="support-settings-container">
                    <div class="settings-empty">–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫‚Ä¶</div>
                </div>
                <div class="table-container" style="margin-top: 24px;">
                    <div class="table-header">
                        <h3>–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã</h3>
                        <button class="action-btn" data-action="support-add-moderator">
                            <span>‚ûï</span>
                            <span>–î–æ–±–∞–≤–∏—Ç—å</span>
                        </button>
                    </div>
                    <div id="support-moderators" class="settings-empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>
                </div>
            </section>

            <section class="content-section" data-section="updates">
                <div class="section-header">
                    <div>
                        <h1 class="page-title">–û–±–Ω–æ–≤–ª–µ–Ω–∏—è</h1>
                        <p class="page-subtitle">–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –Ω–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ –±–æ—Ç–∞ –∏ –∏–∑—É—á–∞–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</p>
                    </div>
                    <div class="section-actions">
                        <button class="action-btn" data-action="updates-refresh">
                            <span>üîÑ</span>
                            <span>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</span>
                        </button>
                    </div>
                </div>
                <div class="settings-container" id="updates-info"></div>
                <div class="table-container" style="margin-top: 24px;">
                    <div class="table-header">
                        <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–ª–∏–∑—ã</h3>
                    </div>
                    <div id="updates-releases" class="settings-empty">–ï—â–µ –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ</div>
                </div>
            </section>

            <section class="content-section" data-section="settings">
                <div class="section-header">
                    <div>
                        <h1 class="page-title">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞</h1>
                        <p class="page-subtitle">–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ–±—Ä–∞–Ω—ã –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
                    </div>
                    <div class="section-actions">
                        <button class="action-btn" data-action="settings-reload">
                            <span>üîÑ</span>
                            <span>–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</span>
                        </button>
                    </div>
                </div>
                <div id="settings-container" class="settings-container">
                    <div class="settings-empty">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–∞—Å—Ç—Ä–æ–µ–∫‚Ä¶</div>
                </div>
            </section>
        </div>
    </main>
</div>
</div>
<script>
(() => {
    const state = {
        token: localStorage.getItem('webadminToken') || '',
        health: null,
        settingsCache: new Map(),
        activeSection: 'dashboard',
        loadedSections: new Set(),
        users: { search: '', offset: 0, limit: 20, total: 0 },
        transactions: { search: '', type: '', status: '', payment: '', offset: 0, limit: 20, total: 0, summary: null },
        promocodes: { offset: 0, limit: 20, total: 0 },
        remnawave: { inbounds: [] },
        syncLog: [],
    };

    const els = {
        authOverlay: document.getElementById('auth-overlay'),
        loginForm: document.getElementById('login-form'),
        loginToken: document.getElementById('login-token'),
        loginError: document.getElementById('login-error'),
        toastContainer: document.getElementById('toast-container'),
        botControlBtn: document.getElementById('bot-control-btn'),
        botDropdown: document.getElementById('bot-dropdown'),
        botStatusIndicator: document.getElementById('bot-status-indicator'),
        maintenanceActionLabel: document.getElementById('maintenance-action-label'),
        maintenanceLabel: document.querySelector('[data-maintenance-label]'),
        navItems: Array.from(document.querySelectorAll('.nav-item')),
        sections: Array.from(document.querySelectorAll('.content-section')),
        statUsers: document.getElementById('stat-total-users'),
        statUsersChange: document.getElementById('stat-users-change'),
        statRevenue: document.getElementById('stat-revenue'),
        statRevenueChange: document.getElementById('stat-revenue-change'),
        statServers: document.getElementById('stat-servers'),
        statServersChange: document.getElementById('stat-servers-change'),
        statConversion: document.getElementById('stat-conversion'),
        statConversionChange: document.getElementById('stat-conversion-change'),
        revenueChart: document.getElementById('revenue-chart'),
        serversList: document.getElementById('servers-list'),
        serversBadge: document.getElementById('servers-online-badge'),
        navServersCount: document.getElementById('nav-servers-count'),
        recentUsersBody: document.getElementById('recent-users-body'),
        settingsContainer: document.getElementById('settings-container'),
        searchInput: document.getElementById('search-input'),
        usersTableBody: document.getElementById('users-table-body'),
        usersTotalLabel: document.getElementById('users-total-label'),
        usersPagination: document.getElementById('users-pagination'),
        usersSearchInput: document.getElementById('users-search-input'),
        transactionsTableBody: document.getElementById('transactions-table-body'),
        transactionsPagination: document.getElementById('transactions-pagination'),
        transactionsTotalLabel: document.getElementById('transactions-total-label'),
        transactionsSearchInput: document.getElementById('transactions-search-input'),
        transactionsTypeFilter: document.getElementById('transactions-type-filter'),
        transactionsStatusFilter: document.getElementById('transactions-status-filter'),
        transactionsPaymentFilter: document.getElementById('transactions-payment-filter'),
        transactionsSummaryIncome: document.getElementById('transactions-summary-income'),
        transactionsSummaryExpense: document.getElementById('transactions-summary-expense'),
        transactionsSummaryNet: document.getElementById('transactions-summary-net'),
        transactionsSummaryTotalCount: document.getElementById('transactions-summary-total-count'),
        transactionsSummaryCompleted: document.getElementById('transactions-summary-completed'),
        transactionsSummaryPending: document.getElementById('transactions-summary-pending'),
        rwOverviewCards: document.getElementById('rw-overview-cards'),
        rwOverviewDetails: document.getElementById('rw-overview-details'),
        rwOverviewUpdated: document.getElementById('rw-overview-updated'),
        rwNodesContainer: document.getElementById('rw-nodes-container'),
        rwSquadsContainer: document.getElementById('rw-squads-container'),
        rwSyncRecommendations: document.getElementById('rw-sync-recommendations'),
        rwSyncActions: document.getElementById('rw-sync-actions'),
        rwSyncLog: document.getElementById('rw-sync-log'),
        serversManagementList: document.getElementById('servers-management-list'),
        promocodesTableBody: document.getElementById('promocodes-table-body'),
        promocodesTotal: document.getElementById('promocodes-total'),
        promocodesPagination: document.getElementById('promocodes-pagination'),
        supportSettingsContainer: document.getElementById('support-settings-container'),
        supportModerators: document.getElementById('support-moderators'),
        updatesInfo: document.getElementById('updates-info'),
        updatesReleases: document.getElementById('updates-releases'),
    };

    const sectionLoaders = {
        dashboard: loadDashboard,
        users: loadUsersSection,
        transactions: loadTransactionsSection,
        'remnawave-overview': loadRemnawaveOverview,
        'remnawave-nodes': loadRemnawaveNodes,
        'remnawave-squads': loadRemnawaveSquads,
        'remnawave-sync': loadRemnawaveSync,
        servers: loadServersSection,
        promocodes: loadPromocodesSection,
        support: loadSupportSection,
        updates: loadUpdatesSection,
        settings: loadSettingsSection,
    };

    let usersSearchTimeout = null;
    let transactionsSearchTimeout = null;

    async function activateSection(sectionKey, { force = false } = {}) {
        if (!sectionKey) {
            return;
        }
        if (state.activeSection !== sectionKey) {
            state.activeSection = sectionKey;
            els.navItems.forEach((item) => {
                item.classList.toggle('active', item.dataset.sectionTarget === sectionKey);
            });
            els.sections.forEach((section) => {
                section.classList.toggle('active', section.dataset.section === sectionKey);
            });
        }
        const loader = sectionLoaders[sectionKey];
        if (typeof loader === 'function') {
            await loader(force);
        }
    }

    function toLocaleCurrency(value) {
        return new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0 }).format(value || 0);
    }

    function toPercent(value) {
        if (value === null || value === undefined || Number.isNaN(value)) {
            return '‚Äî';
        }
        return `${value.toFixed(1)}%`;
    }

    const transactionTypeLabels = {
        deposit: '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞',
        withdrawal: '–°–ø–∏—Å–∞–Ω–∏–µ',
        subscription_payment: '–û–ø–ª–∞—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏',
        refund: '–í–æ–∑–≤—Ä–∞—Ç',
        referral_reward: '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞',
    };

    const paymentMethodLabels = {
        telegram_stars: 'Telegram Stars',
        tribute: 'Tribute',
        yookassa: 'YooKassa',
        cryptobot: 'CryptoBot',
        mulenpay: 'MulenPay',
        pal24: 'PAL24',
        manual: '–í—Ä—É—á–Ω—É—é',
    };

    function formatTransactionType(value) {
        if (!value) {
            return '‚Äî';
        }
        return transactionTypeLabels[value] || value.replace(/_/g, ' ');
    }

    function formatPaymentMethod(value) {
        if (!value) {
            return '‚Äî';
        }
        return paymentMethodLabels[value] || value;
    }

    function formatBytes(bytes) {
        if (!bytes || Number.isNaN(bytes)) {
            return '0 –ë';
        }
        const units = ['–ë', '–ö–ë', '–ú–ë', '–ì–ë', '–¢–ë'];
        const exponent = Math.min(Math.floor(Math.log(bytes) / Math.log(1024)), units.length - 1);
        const value = bytes / 1024 ** exponent;
        return `${value >= 10 ? value.toFixed(0) : value.toFixed(1)} ${units[exponent]}`;
    }

    function formatDateTime(value) {
        if (!value) return '‚Äî';
        const date = value instanceof Date ? value : new Date(value);
        if (Number.isNaN(date.getTime())) return '‚Äî';
        return date.toLocaleString('ru-RU');
    }

    function parseBoolean(value) {
        if (typeof value === 'boolean') {
            return value;
        }
        if (typeof value === 'string') {
            const normalized = value.trim().toLowerCase();
            if (['true', '1', 'yes', 'y', '–¥–∞', 'on', 'enable', 'enabled'].includes(normalized)) {
                return true;
            }
            if (['false', '0', 'no', 'n', '–Ω–µ—Ç', 'off', 'disable', 'disabled'].includes(normalized)) {
                return false;
            }
        }
        return Boolean(value);
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        els.toastContainer.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('fade');
            setTimeout(() => toast.remove(), 200);
        }, 4000);
    }

    function showLogin(message = '') {
        els.authOverlay.classList.remove('hidden');
        els.loginError.textContent = message;
        setTimeout(() => els.loginToken.focus(), 50);
    }

    function hideLogin() {
        els.authOverlay.classList.add('hidden');
        els.loginError.textContent = '';
        els.loginToken.value = '';
    }

    async function callApi(path, { method = 'GET', body, skipAuth = false } = {}) {
        const headers = {};
        if (!skipAuth && state.token) {
            headers.Authorization = `Bearer ${state.token}`;
        }
        const options = { method, headers };
        if (body !== undefined) {
            headers['Content-Type'] = 'application/json';
            options.body = JSON.stringify(body);
        }

        const response = await fetch(path, options).catch((error) => {
            throw new Error(`–°–µ—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞: ${error.message}`);
        });

        let payload = {};
        if (response.status !== 204) {
            try {
                payload = await response.json();
            } catch (error) {
                payload = {};
            }
        }

        if (response.status === 401 && !skipAuth) {
            state.token = '';
            localStorage.removeItem('webadminToken');
            showLogin('–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—Ö–æ–¥');
            throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ');
        }

        if (!response.ok || payload.status === 'error') {
            const message = payload.message || `–û—à–∏–±–∫–∞ ${response.status}`;
            throw new Error(message);
        }

        return payload.data !== undefined ? payload.data : payload;
    }

    function applyTrend(element, value) {
        element.classList.remove('positive', 'negative');
        if (value === null || value === undefined) {
            element.textContent = '‚Äî';
            return;
        }
        const formatted = value > 0 ? `‚Üë ${value.toFixed(1)}%` : value < 0 ? `‚Üì ${(Math.abs(value)).toFixed(1)}%` : '0%';
        element.textContent = formatted;
        if (value > 0) {
            element.classList.add('positive');
        } else if (value < 0) {
            element.classList.add('negative');
        }
    }

    function countryCodeToEmoji(code) {
        if (!code) return 'üåç';
        const upper = code.trim().slice(0, 2).toUpperCase();
        return upper.replace(/./g, (char) => String.fromCodePoint(char.charCodeAt(0) + 127397));
    }

    function renderHealth(data) {
        state.health = data;
        const maintenance = data?.bot?.maintenance;
        els.botStatusIndicator.classList.remove('paused', 'stopped');
        if (maintenance) {
            els.botStatusIndicator.classList.add('paused');
        }
        if (els.maintenanceLabel) {
            els.maintenanceLabel.textContent = maintenance ? '–í–∫–ª' : '–í—ã–∫–ª';
        }
        if (els.maintenanceActionLabel) {
            els.maintenanceActionLabel.textContent = maintenance ? '–í—ã–∫–ª—é—á–∏—Ç—å —Ç–µ—Ö—Ä–∞–±–æ—Ç—ã' : '–í–∫–ª—é—á–∏—Ç—å —Ç–µ—Ö—Ä–∞–±–æ—Ç—ã';
        }
        if (data?.services?.auto_backup_enabled) {
            els.navServersCount.classList.add('active');
        }
    }

    function renderSummary(summary) {
        if (!summary) return;
        els.statUsers.textContent = summary.total_users?.toLocaleString('ru-RU') ?? '‚Äî';
        applyTrend(els.statUsersChange, summary.user_growth_percent ?? 0);
        els.statRevenue.textContent = toLocaleCurrency(summary.monthly_revenue);
        applyTrend(els.statRevenueChange, summary.monthly_revenue_change_percent ?? 0);
        els.statServers.textContent = `${summary.available_servers ?? 0} / ${summary.total_servers ?? 0}`;
        applyTrend(els.statServersChange, summary.active_servers_percent ?? 0);
        els.statConversion.textContent = toPercent(summary.conversion_rate_percent ?? 0);
        applyTrend(els.statConversionChange, summary.conversion_rate_percent ?? 0);
    }

    function renderRevenue(series) {
        if (!Array.isArray(series) || !series.length) {
            return;
        }
        const chart = document.createElement('div');
        chart.className = 'chart-bars';
        const max = Math.max(...series.map((item) => item.revenue || 0));
        series.forEach((item) => {
            const bar = document.createElement('div');
            bar.className = 'chart-bar';
            const percent = max > 0 ? Math.max((item.revenue / max) * 100, 5) : 5;
            bar.style.height = `${percent}%`;
            const value = document.createElement('div');
            value.className = 'chart-bar-value';
            value.textContent = toLocaleCurrency(item.revenue);
            const label = document.createElement('div');
            label.className = 'chart-bar-label';
            label.textContent = new Date(item.date).toLocaleDateString('ru-RU', { day: '2-digit', month: 'short' });
            bar.appendChild(value);
            bar.appendChild(label);
            chart.appendChild(bar);
        });
        els.revenueChart.innerHTML = '';
        els.revenueChart.appendChild(chart);
    }

    function renderDashboardServers(servers) {
        els.serversList.innerHTML = '';
        if (!Array.isArray(servers) || !servers.length) {
            els.serversList.innerHTML = '<div class="settings-empty">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤</div>';
            els.serversBadge.textContent = '0 –æ–Ω–ª–∞–π–Ω';
            els.navServersCount.textContent = '0';
            return;
        }
        els.serversBadge.textContent = `${servers.filter((s) => s.is_available).length} –æ–Ω–ª–∞–π–Ω`;
        els.navServersCount.textContent = servers.length.toString();
        servers.forEach((server) => {
            const card = document.createElement('div');
            card.className = 'server-card';
            const header = document.createElement('div');
            header.className = 'server-card-header';
            header.innerHTML = `
                <div class="server-info">
                    <span class="server-flag">${countryCodeToEmoji(server.country_code)}</span>
                    <div>
                        <div class="server-name">${server.name}</div>
                        <div class="server-status-badge ${server.is_available ? '' : 'offline'}">${server.status_label}</div>
                    </div>
                </div>
                <div class="server-stats">
                    <div class="server-stat">
                        <div class="server-stat-value">${server.current_users}</div>
                        <div class="server-stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    </div>
                    <div class="server-stat">
                        <div class="server-stat-value">${server.max_users ?? '‚àû'}</div>
                        <div class="server-stat-label">–õ–∏–º–∏—Ç</div>
                    </div>
                    <div class="server-stat">
                        <div class="server-stat-value">${server.capacity_percent}%</div>
                        <div class="server-stat-label">–ó–∞–ø–æ–ª–Ω–µ–Ω</div>
                    </div>
                    <div class="expand-icon">‚ñº</div>
                </div>
            `;
            const expanded = document.createElement('div');
            expanded.className = 'server-expanded-content';
            expanded.innerHTML = `
                <div class="server-expanded-inner">
                    <div class="server-details-grid">
                        <div class="server-detail">
                            <div class="server-detail-title">–¶–µ–Ω–∞</div>
                            <div class="server-detail-value">${toLocaleCurrency(server.price_rub)}</div>
                        </div>
                        <div class="server-detail">
                            <div class="server-detail-title">UUID</div>
                            <div class="server-detail-value" style="font-size: 12px; color: var(--text-tertiary);">${server.squad_uuid}</div>
                        </div>
                        <div class="server-detail">
                            <div class="server-detail-title">–°—Ç–∞—Ç—É—Å</div>
                            <div class="server-detail-value">${server.status_label}</div>
                        </div>
                    </div>
                    ${server.description ? `<div class="server-description">${server.description}</div>` : ''}
                </div>
            `;
            header.addEventListener('click', () => {
                card.classList.toggle('expanded');
            });
            card.appendChild(header);
            card.appendChild(expanded);
            els.serversList.appendChild(card);
        });
    }

    async function loadDashboard(force = false) {
        if (!force && state.loadedSections.has('dashboard')) {
            return;
        }
        try {
            const [health, summary, revenue, users, servers] = await Promise.all([
                callApi('/api/health'),
                callApi('/api/dashboard/summary'),
                callApi('/api/dashboard/revenue?days=14'),
                callApi('/api/users/recent?limit=8'),
                callApi('/api/servers'),
            ]);
            renderHealth(health);
            renderSummary(summary);
            renderRevenue(revenue);
            renderRecentUsers(users);
            renderDashboardServers(servers);
            state.loadedSections.add('dashboard');
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    function renderRecentUsers(users) {
        if (!Array.isArray(users) || !users.length) {
            els.recentUsersBody.innerHTML = '<tr><td colspan="5" style="padding: 32px; text-align: center; color: var(--text-tertiary);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
            return;
        }
        const fragment = document.createDocumentFragment();
        users.forEach((user) => {
            const row = document.createElement('tr');
            const subscription = user.subscription;
            let badgeClass = 'status-badge';
            let badgeText = '‚Äî';
            if (subscription) {
                if (subscription.is_trial) {
                    badgeClass += ' trial';
                    badgeText = '–¢—Ä–∏–∞–ª';
                } else if (subscription.status === 'expired') {
                    badgeClass += ' expired';
                    badgeText = '–ò—Å—Ç–µ–∫–ª–∞';
                } else {
                    badgeText = '–ê–∫—Ç–∏–≤–Ω–∞';
                }
            }
            const balance = toLocaleCurrency(user.balance_rub ?? 0);

            const userCell = document.createElement('td');
            const userContainer = document.createElement('div');
            userContainer.className = 'user-cell';

            const avatar = document.createElement('div');
            avatar.className = 'user-avatar-small';
            const displayName = user.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
            avatar.textContent = (displayName || 'U').charAt(0).toUpperCase();

            const info = document.createElement('div');
            info.className = 'user-info';

            const name = document.createElement('div');
            name.className = 'user-name';
            name.textContent = displayName;

            const id = document.createElement('div');
            id.className = 'user-id';
            id.textContent = `ID ${user.id ?? '‚Äî'}`;

            info.appendChild(name);
            info.appendChild(id);
            userContainer.appendChild(avatar);
            userContainer.appendChild(info);
            userCell.appendChild(userContainer);

            const statusCell = document.createElement('td');
            const statusBadge = document.createElement('span');
            statusBadge.className = 'status-badge';
            statusBadge.textContent = user.status ?? '‚Äî';
            statusCell.appendChild(statusBadge);

            const subscriptionCell = document.createElement('td');
            const subscriptionBadge = document.createElement('span');
            subscriptionBadge.className = badgeClass;
            subscriptionBadge.textContent = badgeText;
            subscriptionCell.appendChild(subscriptionBadge);

            const balanceCell = document.createElement('td');
            balanceCell.textContent = balance;

            const actionsCell = document.createElement('td');
            actionsCell.className = 'table-actions-cell';
            const viewButton = document.createElement('button');
            viewButton.className = 'icon-btn';
            viewButton.dataset.action = 'view-user';
            if (user.id != null) {
                viewButton.dataset.userId = String(user.id);
            }
            viewButton.title = '–ü–æ–¥—Ä–æ–±–Ω–µ–µ';
            viewButton.textContent = '‚ÑπÔ∏è';
            actionsCell.appendChild(viewButton);

            row.appendChild(userCell);
            row.appendChild(statusCell);
            row.appendChild(subscriptionCell);
            row.appendChild(balanceCell);
            row.appendChild(actionsCell);

            fragment.appendChild(row);
        });
        els.recentUsersBody.textContent = '';
        els.recentUsersBody.appendChild(fragment);
    }

    function renderUsersTable(response) {
        const items = Array.isArray(response?.items) ? response.items : [];
        const total = Number(response?.total) || items.length;
        const offset = Number(response?.offset) || 0;
        const limit = Number(response?.limit) || state.users.limit;
        state.users.limit = limit;
        state.users.offset = offset;
        state.users.total = total;

        els.usersTotalLabel.textContent = `–í—Å–µ–≥–æ: ${total.toLocaleString('ru-RU')}`;
        const body = els.usersTableBody;

        if (!items.length) {
            body.innerHTML = '<tr><td colspan="5" style="padding: 32px; text-align: center; color: var(--text-tertiary);">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td></tr>';
            updateUsersPagination(total, offset, limit);
            return;
        }

        const fragment = document.createDocumentFragment();
        items.forEach((user) => {
            const row = document.createElement('tr');
            const subscription = user.subscription;
            const statusCell = document.createElement('td');
            statusCell.innerHTML = subscription
                ? `<span class="status-badge ${subscription.status === 'expired' ? 'expired' : subscription.is_trial ? 'trial' : ''}">`
                    + `${subscription.is_trial ? '–¢—Ä–∏–∞–ª' : subscription.status_display || '–ê–∫—Ç–∏–≤–Ω–∞'}</span>`
                : '<span class="status-badge">‚Äî</span>';

            const balanceCell = document.createElement('td');
            balanceCell.textContent = toLocaleCurrency(user.balance_rub ?? 0);

            const createdAt = user.created_at ? new Date(user.created_at) : null;

            row.innerHTML = `
                <td>
                    <div class="user-cell">
                        <div class="user-avatar-small">${(user.full_name || 'U').charAt(0).toUpperCase()}</div>
                        <div class="user-info">
                            <div class="user-name">${user.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</div>
                            <div class="user-id">ID: ${user.id}</div>
                        </div>
                    </div>
                </td>
            `;

            row.appendChild(statusCell);
            row.appendChild(balanceCell);

            const createdCell = document.createElement('td');
            createdCell.textContent = createdAt
                ? createdAt.toLocaleDateString('ru-RU', { day: '2-digit', month: 'short', year: 'numeric' })
                : '‚Äî';
            row.appendChild(createdCell);

            const actionCell = document.createElement('td');
            actionCell.innerHTML = `<button class="setting-button" data-action="view-user" data-user-id="${user.id}">–î–µ—Ç–∞–ª–∏</button>`;
            row.appendChild(actionCell);

            fragment.appendChild(row);
        });

        body.innerHTML = '';
        body.appendChild(fragment);
        updateUsersPagination(total, offset, limit);
    }

    function updateUsersPagination(total, offset, limit) {
        const container = els.usersPagination;
        if (!container) return;
        if (total <= limit) {
            container.innerHTML = '';
            return;
        }

        const currentPage = Math.floor(offset / limit) + 1;
        const totalPages = Math.max(1, Math.ceil(total / limit));

        container.innerHTML = '';

        const info = document.createElement('span');
        info.className = 'table-caption';
        info.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage}/${totalPages}`;

        const prev = document.createElement('button');
        prev.className = 'action-btn';
        prev.textContent = '‚Üê';
        prev.disabled = currentPage <= 1;
        prev.dataset.action = 'users-page';
        prev.dataset.page = String(currentPage - 1);

        const next = document.createElement('button');
        next.className = 'action-btn';
        next.textContent = '‚Üí';
        next.disabled = currentPage >= totalPages;
        next.dataset.action = 'users-page';
        next.dataset.page = String(currentPage + 1);

        container.append(prev, info, next);
    }

    async function loadUsersSection(force = false) {
        if (!force && state.loadedSections.has('users')) {
            return;
        }
        const { search, offset, limit } = state.users;
        const params = new URLSearchParams({ limit: String(limit), offset: String(offset) });
        if (search) {
            params.append('search', search);
        }
        els.usersTableBody.innerHTML = '<tr><td colspan="5" style="padding: 32px; text-align: center; color: var(--text-tertiary);">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>';
        try {
            const data = await callApi(`/api/users?${params.toString()}`);
            renderUsersTable(data);
            state.loadedSections.add('users');
        } catch (error) {
            els.usersTableBody.innerHTML = `<tr><td colspan="5" style="padding: 32px; text-align: center; color: var(--danger);">${error.message}</td></tr>`;
        }
    }

    function renderTransactionsSummary(summary) {
        if (!els.transactionsSummaryIncome) {
            return;
        }
        if (!summary) {
            els.transactionsSummaryIncome.textContent = '‚Äî';
            els.transactionsSummaryExpense.textContent = '‚Äî';
            els.transactionsSummaryNet.textContent = '‚Äî';
            els.transactionsSummaryTotalCount.textContent = '‚Äî';
            els.transactionsSummaryCompleted.textContent = '‚Äî';
            els.transactionsSummaryPending.textContent = '‚Äî';
            return;
        }
        const income = Number.isFinite(summary.income_rub) ? summary.income_rub : (Number(summary.income_kopeks) || 0) / 100;
        const expense = Number.isFinite(summary.expense_rub) ? summary.expense_rub : (Number(summary.expense_kopeks) || 0) / 100;
        const net = Number.isFinite(summary.net_rub) ? summary.net_rub : (Number(summary.net_kopeks) || 0) / 100;
        const totalCount = Number(summary.total_count) || 0;
        const completed = Number(summary.completed_count) || 0;
        const pending = Number(summary.pending_count) || 0;

        els.transactionsSummaryIncome.textContent = toLocaleCurrency(income);
        els.transactionsSummaryExpense.textContent = expense > 0 ? `-${toLocaleCurrency(expense)}` : toLocaleCurrency(0);
        if (net === 0) {
            els.transactionsSummaryNet.textContent = toLocaleCurrency(0);
        } else {
            const netSign = net > 0 ? '+' : '-';
            els.transactionsSummaryNet.textContent = `${netSign}${toLocaleCurrency(Math.abs(net))}`;
        }
        els.transactionsSummaryTotalCount.textContent = totalCount.toLocaleString('ru-RU');
        els.transactionsSummaryCompleted.textContent = completed.toLocaleString('ru-RU');
        els.transactionsSummaryPending.textContent = pending.toLocaleString('ru-RU');
    }

    function renderTransactionsTable(response) {
        if (!els.transactionsTableBody) {
            return;
        }
        const items = Array.isArray(response?.items) ? response.items : [];
        const total = Number(response?.total) || items.length;
        const offset = Number(response?.offset) || 0;
        const limit = Number(response?.limit) || state.transactions.limit;
        state.transactions.limit = limit;
        state.transactions.offset = offset;
        state.transactions.total = total;
        state.transactions.summary = response?.summary || null;

        if (els.transactionsTotalLabel) {
            els.transactionsTotalLabel.textContent = `–í—Å–µ–≥–æ: ${total.toLocaleString('ru-RU')}`;
        }

        if (!items.length) {
            els.transactionsTableBody.innerHTML = '<tr><td colspan="6" style="padding: 32px; text-align: center; color: var(--text-tertiary);">–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
            renderTransactionsSummary(response?.summary || null);
            updateTransactionsPagination(total, offset, limit);
            return;
        }

        const fragment = document.createDocumentFragment();
        items.forEach((transaction) => {
            const row = document.createElement('tr');

            const createdAt = transaction.created_at ? new Date(transaction.created_at) : null;
            const createdText = createdAt
                ? createdAt.toLocaleString('ru-RU', {
                      day: '2-digit',
                      month: 'short',
                      year: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit',
                  })
                : '‚Äî';

            const idCell = document.createElement('td');
            idCell.innerHTML = `
                <div class="transaction-meta">
                    <div class="transaction-id">#${transaction.id}</div>
                    <div class="transaction-date">${createdText}</div>
                </div>
            `;

            const userCell = document.createElement('td');
            const user = transaction.user || {};
            const userName = user.full_name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
            const userAvatar = (userName || 'U').charAt(0).toUpperCase();
            const userId = user.id ?? transaction.user_id;
            userCell.innerHTML = `
                <div class="user-cell">
                    <div class="user-avatar-small">${userAvatar}</div>
                    <div class="user-info">
                        <div class="user-name">${userName}</div>
                        <div class="user-id">ID: ${userId}</div>
                    </div>
                </div>
            `;

            const typeCell = document.createElement('td');
            const typeLabel = document.createElement('div');
            typeLabel.className = 'transaction-type';
            typeLabel.textContent = formatTransactionType(transaction.type);
            typeCell.appendChild(typeLabel);
            if (transaction.description) {
                const description = document.createElement('div');
                description.className = 'transaction-description';
                description.textContent = transaction.description;
                typeCell.appendChild(description);
            }

            const amountCell = document.createElement('td');
            const amountSpan = document.createElement('span');
            amountSpan.classList.add('transaction-amount');
            const amountRub = Number.isFinite(transaction.amount_rub)
                ? transaction.amount_rub
                : (Number(transaction.amount_kopeks) || 0) / 100;
            if (amountRub > 0) {
                amountSpan.classList.add('positive');
                amountSpan.textContent = `+${toLocaleCurrency(Math.abs(amountRub))}`;
            } else if (amountRub < 0) {
                amountSpan.classList.add('negative');
                amountSpan.textContent = `-${toLocaleCurrency(Math.abs(amountRub))}`;
            } else {
                amountSpan.textContent = toLocaleCurrency(0);
            }
            amountCell.appendChild(amountSpan);

            const methodCell = document.createElement('td');
            const methodLabel = document.createElement('div');
            methodLabel.textContent = formatPaymentMethod(transaction.payment_method);
            methodCell.appendChild(methodLabel);
            if (transaction.external_id) {
                const external = document.createElement('div');
                external.className = 'transaction-external-id';
                external.textContent = `ID: ${transaction.external_id}`;
                methodCell.appendChild(external);
            }

            const statusCell = document.createElement('td');
            const statusBadge = document.createElement('span');
            statusBadge.className = `status-badge ${transaction.is_completed ? 'completed' : 'pending'}`;
            statusBadge.textContent = transaction.is_completed ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ';
            statusCell.appendChild(statusBadge);
            const completedAt = transaction.completed_at ? new Date(transaction.completed_at) : null;
            if (completedAt) {
                const completedLabel = document.createElement('div');
                completedLabel.className = 'transaction-date';
                const labelPrefix = transaction.is_completed ? '–ó–∞–≤–µ—Ä—à–µ–Ω–æ' : '–û–±–Ω–æ–≤–ª–µ–Ω–æ';
                completedLabel.textContent = `${labelPrefix}: ${completedAt.toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                })}`;
                statusCell.appendChild(completedLabel);
            }

            row.append(idCell, userCell, typeCell, amountCell, methodCell, statusCell);
            fragment.appendChild(row);
        });

        els.transactionsTableBody.innerHTML = '';
        els.transactionsTableBody.appendChild(fragment);
        renderTransactionsSummary(response?.summary || null);
        updateTransactionsPagination(total, offset, limit);
    }

    function updateTransactionsPagination(total, offset, limit) {
        const container = els.transactionsPagination;
        if (!container) {
            return;
        }
        if (total <= limit) {
            container.innerHTML = '';
            return;
        }
        const currentPage = Math.floor(offset / limit) + 1;
        const totalPages = Math.max(1, Math.ceil(total / limit));
        container.innerHTML = '';

        const prev = document.createElement('button');
        prev.className = 'action-btn';
        prev.textContent = '‚Üê';
        prev.disabled = currentPage <= 1;
        prev.dataset.action = 'transactions-page';
        prev.dataset.page = String(currentPage - 1);

        const info = document.createElement('span');
        info.className = 'table-caption';
        info.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage}/${totalPages}`;

        const next = document.createElement('button');
        next.className = 'action-btn';
        next.textContent = '‚Üí';
        next.disabled = currentPage >= totalPages;
        next.dataset.action = 'transactions-page';
        next.dataset.page = String(currentPage + 1);

        container.append(prev, info, next);
    }

    async function loadTransactionsSection(force = false) {
        if (!els.transactionsTableBody) {
            return;
        }
        if (!force && state.loadedSections.has('transactions')) {
            renderTransactionsSummary(state.transactions.summary);
            return;
        }
        const { limit, offset, search, type, status, payment } = state.transactions;
        const params = new URLSearchParams({ limit: String(limit), offset: String(offset) });
        if (search) {
            params.append('search', search);
        }
        if (type) {
            params.append('type', type);
        }
        if (status) {
            params.append('status', status);
        }
        if (payment) {
            params.append('payment', payment);
        }
        els.transactionsTableBody.innerHTML = '<tr><td colspan="6" style="padding: 32px; text-align: center; color: var(--text-tertiary);">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>';
        if (els.transactionsTotalLabel) {
            els.transactionsTotalLabel.textContent = '‚Äî';
        }
        try {
            const data = await callApi(`/api/transactions?${params.toString()}`);
            renderTransactionsTable(data);
            state.loadedSections.add('transactions');
        } catch (error) {
            els.transactionsTableBody.innerHTML = `<tr><td colspan="6" style=\"padding: 32px; text-align: center; color: var(--danger);\">${error.message}</td></tr>`;
            state.transactions.summary = null;
            renderTransactionsSummary(null);
        }
    }

    function renderRemnawaveOverview(data) {
        if (!data) {
            els.rwOverviewCards.innerHTML = '<div class="settings-empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            els.rwOverviewDetails.innerHTML = '';
            els.rwOverviewUpdated.textContent = '';
            return;
        }
        state.remnawave.overview = data;
        const system = data.system || {};
        const cards = [
            { icon: 'üë•', label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', value: system.total_users?.toLocaleString('ru-RU') ?? '0' },
            { icon: 'üü¢', label: '–û–Ω–ª–∞–π–Ω —Å–µ–π—á–∞—Å', value: system.users_online ?? 0 },
            { icon: 'üåê', label: '–ù–æ–¥—ã –æ–Ω–ª–∞–π–Ω', value: system.nodes_online ?? 0 },
            { icon: '‚ö°', label: '–†–µ–∞–ª—Ç–∞–π–º —Ç—Ä–∞—Ñ–∏–∫', value: formatBytes(data.bandwidth?.realtime_total ?? 0) },
        ];
        els.rwOverviewCards.innerHTML = cards
            .map((card) => `
                <div class="stat-card">
                    <div class="stat-header">
                        <div>
                            <div class="stat-value">${card.value}</div>
                            <div class="stat-label">${card.label}</div>
                        </div>
                        <div class="stat-icon">${card.icon}</div>
                    </div>
                </div>
            `)
            .join('');

        const server = data.server_info || {};
        const usersByStatus = data.users_by_status || {};
        const statusList = Object.entries(usersByStatus)
            .map(([status, count]) => `<li>${status}: ${count}</li>`)
            .join('');

        const trafficPeriods = data.traffic_periods || {};
        const trafficRows = ['last_2_days', 'last_7_days', 'last_30_days', 'current_month', 'current_year']
            .map((key) => {
                const entry = trafficPeriods[key] || {};
                const labelMap = {
                    last_2_days: '2 –¥–Ω—è',
                    last_7_days: '7 –¥–Ω–µ–π',
                    last_30_days: '30 –¥–Ω–µ–π',
                    current_month: '–ú–µ—Å—è—Ü',
                    current_year: '–ì–æ–¥',
                };
                const label = labelMap[key] || key;
                const difference = entry.difference ? ` (${entry.difference})` : '';
                return `<li>${label}: ${formatBytes(entry.current || 0)}${difference}</li>`;
            })
            .join('');

        els.rwOverviewDetails.innerHTML = `
            <div class="settings-group">
                <h4>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h4>
                <p>–í—Å–µ–≥–æ: ${system.total_users ?? 0}</p>
                <ul class="simple-list">${statusList || '<li>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</li>'}</ul>
            </div>
            <div class="settings-group">
                <h4>–°–µ—Ä–≤–µ—Ä</h4>
                <ul class="simple-list">
                    <li>CPU: ${server.cpu_cores ?? 0} (${server.cpu_physical_cores ?? 0} —Ñ–∏–∑.)</li>
                    <li>–ü–∞–º—è—Ç—å: ${formatBytes(server.memory_used ?? 0)} / ${formatBytes(server.memory_total ?? 0)}</li>
                    <li>–°–≤–æ–±–æ–¥–Ω–æ: ${formatBytes(server.memory_free ?? 0)}</li>
                    <li>Uptime: ${Math.floor((server.uptime_seconds || 0) / 3600)} —á</li>
                </ul>
            </div>
            <div class="settings-group">
                <h4>–¢—Ä–∞—Ñ–∏–∫</h4>
                <p>–†–µ–∞–ª—Ç–∞–π–º: ${formatBytes(data.bandwidth?.realtime_total ?? 0)}</p>
                <ul class="simple-list">${trafficRows}</ul>
            </div>
        `;

        els.rwOverviewUpdated.textContent = data.last_updated
            ? `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${formatDateTime(data.last_updated)}`
            : '';
    }

    function renderRemnawaveNodes(nodes) {
        if (!els.rwNodesContainer) return;
        if (!Array.isArray(nodes) || !nodes.length) {
            els.rwNodesContainer.innerHTML = '<div class="settings-empty">–ù–æ–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            return;
        }
        const fragment = document.createDocumentFragment();
        nodes.forEach((node) => {
            const card = document.createElement('div');
            card.className = 'server-card';
            const statusLabel = node.is_disabled
                ? '–û—Ç–∫–ª—é—á–µ–Ω–∞'
                : node.is_node_online
                    ? '–û–Ω–ª–∞–π–Ω'
                    : '–û—Ñ—Ñ–ª–∞–π–Ω';
            card.innerHTML = `
                <div class="server-card-header">
                    <div class="server-info">
                        <span class="server-flag">${countryCodeToEmoji(node.country_code)}</span>
                        <div>
                            <div class="server-name">${node.name || node.uuid}</div>
                            <div class="server-status-badge ${node.is_node_online && !node.is_disabled ? '' : 'offline'}">${statusLabel}</div>
                        </div>
                    </div>
                    <div class="server-stats">
                        <div class="server-stat">
                            <div class="server-stat-value">${node.users_online ?? 0}</div>
                            <div class="server-stat-label">–û–Ω–ª–∞–π–Ω</div>
                        </div>
                        <div class="server-stat">
                            <div class="server-stat-value">${formatBytes(node.traffic_used_bytes ?? 0)}</div>
                            <div class="server-stat-label">–¢—Ä–∞—Ñ–∏–∫</div>
                        </div>
                    </div>
                </div>
                <div class="server-expanded-content" style="max-height: none; border-top: 1px solid var(--border);">
                    <div class="server-expanded-inner">
                        <div class="setting-actions" style="justify-content: flex-start; gap: 12px;">
                            <button class="setting-button" data-action="rw-node-action" data-command="restart" data-node="${node.uuid}">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
                            <button class="setting-button" data-action="rw-node-action" data-command="${node.is_disabled ? 'enable' : 'disable'}" data-node="${node.uuid}">${node.is_disabled ? '–í–∫–ª—é—á–∏—Ç—å' : '–û—Ç–∫–ª—é—á–∏—Ç—å'}</button>
                            <button class="setting-button" data-action="rw-node-details" data-node="${node.uuid}">–î–µ—Ç–∞–ª–∏</button>
                        </div>
                    </div>
                </div>
            `;
            fragment.appendChild(card);
        });
        els.rwNodesContainer.innerHTML = '';
        els.rwNodesContainer.appendChild(fragment);
    }

    function renderRemnawaveSquads(squads) {
        if (!els.rwSquadsContainer) return;
        if (!Array.isArray(squads) || !squads.length) {
            els.rwSquadsContainer.innerHTML = '<div class="settings-empty">–°–∫–≤–∞–¥—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            return;
        }
        const fragment = document.createDocumentFragment();
        squads.forEach((squad) => {
            const card = document.createElement('div');
            card.className = 'server-card';
            card.innerHTML = `
                <div class="server-card-header">
                    <div>
                        <div class="server-name">${squad.name}</div>
                        <div class="server-status-badge">${squad.members_count} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                    </div>
                    <div class="server-stat">
                        <div class="server-stat-value">${squad.inbounds_count}</div>
                        <div class="server-stat-label">–ò–Ω–±–∞—É–Ω–¥—ã</div>
                    </div>
                </div>
                <div class="server-expanded-content" style="max-height: none; border-top: 1px solid var(--border);">
                    <div class="server-expanded-inner">
                        <div class="setting-key">UUID: ${squad.uuid}</div>
                        <div class="setting-value">–ò–Ω–±–∞—É–Ω–¥—ã: ${Array.isArray(squad.inbounds) && squad.inbounds.length ? squad.inbounds.join(', ') : '‚Äî'}</div>
                        <div class="setting-actions" style="justify-content: flex-start; gap: 12px; margin-top: 12px;">
                            <button class="setting-button" data-action="rw-squad-rename" data-squad="${squad.uuid}" data-name="${squad.name}">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
                            <button class="setting-button" data-action="rw-squad-inbounds" data-squad="${squad.uuid}">–ò–Ω–±–∞—É–Ω–¥—ã</button>
                            <button class="setting-button" data-action="rw-squad-add-users" data-squad="${squad.uuid}">–î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ—Ö</button>
                            <button class="setting-button" data-action="rw-squad-remove-users" data-squad="${squad.uuid}">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö</button>
                            <button class="setting-button" data-action="rw-squad-delete" data-squad="${squad.uuid}">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            `;
            fragment.appendChild(card);
        });
        els.rwSquadsContainer.innerHTML = '';
        els.rwSquadsContainer.appendChild(fragment);
    }

    function renderRemnawaveSync(recommendations) {
        if (!els.rwSyncRecommendations) return;
        const { sync_type: recommendedType, should_sync: shouldSync, reason } = recommendations || {};
        els.rwSyncRecommendations.innerHTML = `
            <div class="settings-group">
                <h4>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</h4>
                <p>${shouldSync ? '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é.' : '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.'}</p>
                <p>–¢–∏–ø: <strong>${recommendedType || '‚Äî'}</strong></p>
                ${reason ? `<p>${reason}</p>` : ''}
            </div>
        `;

        const actions = [
            { action: 'from_panel_all', label: '–ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è', icon: 'üîÅ' },
            { action: 'from_panel_new', label: '–¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ', icon: 'üÜï' },
            { action: 'from_panel_update', label: '–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ', icon: '‚ôªÔ∏è' },
            { action: 'to_panel', label: '–í—ã–≥—Ä—É–∑–∏—Ç—å –≤ –ø–∞–Ω–µ–ª—å', icon: '‚¨ÜÔ∏è' },
            { action: 'validate', label: '–í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–æ–∫', icon: 'üîç' },
            { action: 'cleanup', label: '–û—á–∏—Å—Ç–∏—Ç—å –Ω–µ–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ', icon: 'üßπ' },
            { action: 'sync_statuses', label: '–°—Ç–∞—Ç—É—Å—ã –ø–æ–¥–ø–∏—Å–æ–∫', icon: 'üìä' },
        ];
        els.rwSyncActions.innerHTML = actions
            .map((item) => `
                <button class="action-btn" data-action="rw-sync-run" data-sync-action="${item.action}">
                    <span>${item.icon}</span>
                    <span>${item.label}</span>
                </button>
            `)
            .join('');

        renderSyncLog();
    }

    function appendSyncLog(message, type = 'info') {
        state.syncLog.unshift({ message, type, time: new Date() });
        if (state.syncLog.length > 20) {
            state.syncLog.length = 20;
        }
        renderSyncLog();
    }

    function renderSyncLog() {
        if (!els.rwSyncLog) return;
        if (!state.syncLog.length) {
            els.rwSyncLog.textContent = '–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç';
            return;
        }
        els.rwSyncLog.innerHTML = state.syncLog
            .map((entry) => `<div style="margin-bottom: 6px;">${formatDateTime(entry.time)} ‚Ä¢ ${entry.message}</div>`)
            .join('');
    }

    async function loadRemnawaveOverview(force = false) {
        if (!force && state.loadedSections.has('remnawave-overview')) {
            return;
        }
        els.rwOverviewCards.innerHTML = '<div class="settings-empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
        try {
            const data = await callApi('/api/remnawave/overview');
            renderRemnawaveOverview(data);
            state.loadedSections.add('remnawave-overview');
        } catch (error) {
            els.rwOverviewCards.innerHTML = `<div class="settings-empty">${error.message}</div>`;
        }
    }

    async function loadRemnawaveNodes(force = false) {
        if (!force && state.loadedSections.has('remnawave-nodes')) {
            return;
        }
        els.rwNodesContainer.innerHTML = '<div class="settings-empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
        try {
            const nodes = await callApi('/api/remnawave/nodes');
            renderRemnawaveNodes(nodes);
            state.loadedSections.add('remnawave-nodes');
        } catch (error) {
            els.rwNodesContainer.innerHTML = `<div class="settings-empty">${error.message}</div>`;
        }
    }

    async function loadRemnawaveSquads(force = false) {
        if (!force && state.loadedSections.has('remnawave-squads')) {
            return;
        }
        els.rwSquadsContainer.innerHTML = '<div class="settings-empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
        try {
            const [inbounds, squads] = await Promise.all([
                callApi('/api/remnawave/inbounds'),
                callApi('/api/remnawave/squads'),
            ]);
            state.remnawave.inbounds = Array.isArray(inbounds) ? inbounds : [];
            renderRemnawaveSquads(squads);
            state.loadedSections.add('remnawave-squads');
        } catch (error) {
            els.rwSquadsContainer.innerHTML = `<div class="settings-empty">${error.message}</div>`;
        }
    }

    async function loadRemnawaveSync(force = false) {
        if (!force && state.loadedSections.has('remnawave-sync')) {
            return;
        }
        els.rwSyncRecommendations.innerHTML = '<div class="settings-empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
        try {
            const recommendations = await callApi('/api/remnawave/sync/recommendations');
            renderRemnawaveSync(recommendations);
            state.loadedSections.add('remnawave-sync');
        } catch (error) {
            els.rwSyncRecommendations.innerHTML = `<div class="settings-empty">${error.message}</div>`;
        }
    }

    function renderServersManagement(servers) {
        if (!els.serversManagementList) return;
        if (!Array.isArray(servers) || !servers.length) {
            els.serversManagementList.innerHTML = '<div class="settings-empty">–°–µ—Ä–≤–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            return;
        }
        const fragment = document.createDocumentFragment();
        servers.forEach((server) => {
            const card = document.createElement('div');
            card.className = 'server-card';
            card.innerHTML = `
                <div class="server-card-header">
                    <div class="server-info">
                        <span class="server-flag">${countryCodeToEmoji(server.country_code)}</span>
                        <div>
                            <div class="server-name">${server.name}</div>
                            <div class="server-status-badge ${server.is_available ? '' : 'offline'}">${server.status_label}</div>
                        </div>
                    </div>
                    <div class="server-stats">
                        <div class="server-stat">
                            <div class="server-stat-value">${server.current_users}</div>
                            <div class="server-stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
                        </div>
                        <div class="server-stat">
                            <div class="server-stat-value">${server.max_users ?? '‚àû'}</div>
                            <div class="server-stat-label">–õ–∏–º–∏—Ç</div>
                        </div>
                        <div class="server-stat">
                            <div class="server-stat-value">${toLocaleCurrency(server.price_rub)}</div>
                            <div class="server-stat-label">–¶–µ–Ω–∞</div>
                        </div>
                    </div>
                </div>
                <div class="server-expanded-content" style="max-height: none; border-top: 1px solid var(--border);">
                    <div class="server-expanded-inner">
                        <div class="setting-key">UUID: ${server.squad_uuid}</div>
                        <div class="setting-value">–û–ø–∏—Å–∞–Ω–∏–µ: ${server.description || '‚Äî'}</div>
                        <div class="setting-actions" style="justify-content: flex-start; gap: 12px; margin-top: 12px; flex-wrap: wrap;">
                            <button class="setting-button" data-action="server-toggle" data-server="${server.id}" data-available="${server.is_available}">${server.is_available ? '–û—Ç–∫–ª—é—á–∏—Ç—å' : '–í–∫–ª—é—á–∏—Ç—å'}</button>
                            <button class="setting-button" data-action="server-edit" data-server="${server.id}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="setting-button" data-action="server-promo" data-server="${server.id}">–ü—Ä–æ–º–æ–≥—Ä—É–ø–ø—ã</button>
                            <button class="setting-button" data-action="server-delete" data-server="${server.id}">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            `;
            fragment.appendChild(card);
        });
        els.serversManagementList.innerHTML = '';
        els.serversManagementList.appendChild(fragment);
    }

    async function loadServersSection(force = false) {
        if (!force && state.loadedSections.has('servers')) {
            return;
        }
        els.serversManagementList.innerHTML = '<div class="settings-empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
        try {
            const servers = await callApi('/api/servers');
            renderServersManagement(servers);
            state.loadedSections.add('servers');
        } catch (error) {
            els.serversManagementList.innerHTML = `<div class="settings-empty">${error.message}</div>`;
        }
    }

    function renderPromocodes(data) {
        const body = els.promocodesTableBody;
        if (!body) return;
        const items = Array.isArray(data?.items) ? data.items : [];
        const total = Number(data?.total) || items.length;
        const offset = Number(data?.offset) || 0;
        const limit = Number(data?.limit) || state.promocodes.limit;
        state.promocodes.total = total;
        state.promocodes.offset = offset;
        state.promocodes.limit = limit;
        els.promocodesTotal.textContent = `–í—Å–µ–≥–æ: ${total.toLocaleString('ru-RU')}`;

        if (!items.length) {
            body.innerHTML = '<tr><td colspan="5" style="padding: 32px; text-align: center; color: var(--text-tertiary);">–ù–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤</td></tr>';
            els.promocodesPagination.innerHTML = '';
            return;
        }

        const fragment = document.createDocumentFragment();
        items.forEach((promo) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><code>${promo.code}</code></td>
                <td>${promo.type}</td>
                <td>${promo.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–í—ã–∫–ª—é—á–µ–Ω'}</td>
                <td>${promo.current_uses}/${promo.max_uses}</td>
                <td>
                    <div class="setting-actions">
                        <button class="setting-button" data-action="promocode-toggle" data-id="${promo.id}">${promo.is_active ? '–í—ã–∫–ª—é—á–∏—Ç—å' : '–í–∫–ª—é—á–∏—Ç—å'}</button>
                        <button class="setting-button" data-action="promocode-edit" data-id="${promo.id}">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                        <button class="setting-button" data-action="promocode-delete" data-id="${promo.id}">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </td>
            `;
            fragment.appendChild(row);
        });
        body.innerHTML = '';
        body.appendChild(fragment);

        const totalPages = Math.max(1, Math.ceil(total / limit));
        const currentPage = Math.floor(offset / limit) + 1;
        if (totalPages <= 1) {
            els.promocodesPagination.innerHTML = '';
        } else {
            els.promocodesPagination.innerHTML = `
                <button class="action-btn" data-action="promocodes-page" data-page="${currentPage - 1}" ${currentPage <= 1 ? 'disabled' : ''}>‚Üê</button>
                <span class="table-caption">–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage}/${totalPages}</span>
                <button class="action-btn" data-action="promocodes-page" data-page="${currentPage + 1}" ${currentPage >= totalPages ? 'disabled' : ''}>‚Üí</button>
            `;
        }
    }

    async function loadPromocodesSection(force = false) {
        if (!force && state.loadedSections.has('promocodes')) {
            return;
        }
        els.promocodesTableBody.innerHTML = '<tr><td colspan="5" style="padding: 32px; text-align: center; color: var(--text-ter—Ç–∏ary);">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr>';
        const { offset, limit } = state.promocodes;
        const params = new URLSearchParams({ offset: String(offset), limit: String(limit) });
        try {
            const data = await callApi(`/api/promocodes?${params.toString()}`);
            renderPromocodes(data);
            state.loadedSections.add('promocodes');
        } catch (error) {
            els.promocodesTableBody.innerHTML = `<tr><td colspan="5" style="padding: 32px; text-align: center; color: var(--danger);">${error.message}</td></tr>`;
        }
    }

    function renderSupportSettings(settings) {
        if (!els.supportSettingsContainer) return;
        if (!settings) {
            els.supportSettingsContainer.innerHTML = '<div class="settings-empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            return;
        }
        els.supportSettingsContainer.innerHTML = `
            <div class="setting-item">
                <div>
                    <div class="setting-name">–ú–µ–Ω—é –ø–æ–¥–¥–µ—Ä–∂–∫–∏</div>
                    <div class="setting-key">menu_enabled</div>
                </div>
                <div class="setting-value">${settings.menu_enabled ? '–í–∫–ª—é—á–µ–Ω–æ' : '–í—ã–∫–ª—é—á–µ–Ω–æ'}</div>
                <div class="setting-actions">
                    <button class="setting-button" data-action="support-toggle" data-key="menu_enabled" data-value="${!settings.menu_enabled}">${settings.menu_enabled ? '–í—ã–∫–ª—é—á–∏—Ç—å' : '–í–∫–ª—é—á–∏—Ç—å'}</button>
                </div>
            </div>
            <div class="setting-item">
                <div>
                    <div class="setting-name">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞–º</div>
                    <div class="setting-key">admin_ticket_notifications</div>
                </div>
                <div class="setting-value">${settings.admin_ticket_notifications ? '–í–∫–ª—é—á–µ–Ω—ã' : '–í—ã–∫–ª—é—á–µ–Ω—ã'}</div>
                <div class="setting-actions">
                    <button class="setting-button" data-action="support-toggle" data-key="admin_ticket_notifications" data-value="${!settings.admin_ticket_notifications}">${settings.admin_ticket_notifications ? '–í—ã–∫–ª—é—á–∏—Ç—å' : '–í–∫–ª—é—á–∏—Ç—å'}</button>
                </div>
            </div>
            <div class="setting-item">
                <div>
                    <div class="setting-name">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</div>
                    <div class="setting-key">user_ticket_notifications</div>
                </div>
                <div class="setting-value">${settings.user_ticket_notifications ? '–í–∫–ª—é—á–µ–Ω—ã' : '–í—ã–∫–ª—é—á–µ–Ω—ã'}</div>
                <div class="setting-actions">
                    <button class="setting-button" data-action="support-toggle" data-key="user_ticket_notifications" data-value="${!settings.user_ticket_notifications}">${settings.user_ticket_notifications ? '–í—ã–∫–ª—é—á–∏—Ç—å' : '–í–∫–ª—é—á–∏—Ç—å'}</button>
                </div>
            </div>
            <div class="setting-item">
                <div>
                    <div class="setting-name">SLA</div>
                    <div class="setting-key">sla_minutes</div>
                </div>
                <div class="setting-value">${settings.sla_enabled ? `${settings.sla_minutes} –º–∏–Ω—É—Ç` : '–û—Ç–∫–ª—é—á–µ–Ω'}</div>
                <div class="setting-actions">
                    <button class="setting-button" data-action="support-toggle" data-key="sla_enabled" data-value="${!settings.sla_enabled}">${settings.sla_enabled ? '–í—ã–∫–ª—é—á–∏—Ç—å' : '–í–∫–ª—é—á–∏—Ç—å'}</button>
                    <button class="setting-button" data-action="support-set-sla" data-value="${settings.sla_minutes}">–ò–∑–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º—è</button>
                </div>
            </div>
        `;
    }

    function renderSupportModerators(moderators) {
        if (!els.supportModerators) return;
        if (!Array.isArray(moderators) || !moderators.length) {
            els.supportModerators.textContent = '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã';
            return;
        }
        els.supportModerators.innerHTML = moderators
            .map((id) => `<div class="setting-item"><div>Telegram ID: ${id}</div><div class="setting-actions"><button class="setting-button" data-action="support-remove-moderator" data-id="${id}">–£–¥–∞–ª–∏—Ç—å</button></div></div>`)
            .join('');
    }

    async function loadSupportSection(force = false) {
        if (!force && state.loadedSections.has('support')) {
            return;
        }
        els.supportSettingsContainer.innerHTML = '<div class="settings-empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
        try {
            const [settings, moderators] = await Promise.all([
                callApi('/api/support/settings'),
                callApi('/api/support/moderators'),
            ]);
            renderSupportSettings(settings);
            renderSupportModerators(moderators?.moderators || []);
            state.loadedSections.add('support');
        } catch (error) {
            els.supportSettingsContainer.innerHTML = `<div class="settings-empty">${error.message}</div>`;
        }
    }

    function renderUpdatesInfo(info) {
        if (!els.updatesInfo) return;
        if (!info) {
            els.updatesInfo.innerHTML = '<div class="settings-empty">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
            return;
        }
        els.updatesInfo.innerHTML = `
            <div class="settings-group">
                <h4>–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è</h4>
                <p>${info.current_version || '‚Äî'}</p>
                <p>–ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç–∞–±–∏–ª—å–Ω–∞—è: ${info.latest_stable_version || '‚Äî'}</p>
            </div>
        `;
    }

    function renderUpdatesReleases(releases) {
        if (!els.updatesReleases) return;
        if (!Array.isArray(releases) || !releases.length) {
            els.updatesReleases.textContent = '–ù–æ–≤—ã—Ö —Ä–µ–ª–∏–∑–æ–≤ –Ω–µ—Ç';
            return;
        }
        els.updatesReleases.innerHTML = releases
            .map((release) => `
                <div class="settings-group">
                    <div class="setting-name">${release.name || release.tag}</div>
                    <div class="setting-key">${release.tag}</div>
                    <div class="setting-value">${formatDateTime(release.published_at)}</div>
                    <p style="margin-top: 8px; color: var(--text-secondary);">${release.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                </div>
            `)
            .join('');
    }

    async function loadUpdatesSection(force = false) {
        if (!force && state.loadedSections.has('updates')) {
            return;
        }
        els.updatesInfo.innerHTML = '<div class="settings-empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
        els.updatesReleases.innerHTML = '<div class="settings-empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
        try {
            const info = await callApi('/api/updates/info');
            renderUpdatesInfo(info);
            renderUpdatesReleases(info?.releases || []);
            state.loadedSections.add('updates');
        } catch (error) {
            els.updatesInfo.innerHTML = `<div class="settings-empty">${error.message}</div>`;
            els.updatesReleases.innerHTML = '';
        }
    }

    async function loadSettingsSection(force = false) {
        if (!force && state.loadedSections.has('settings')) {
            return;
        }
        els.settingsContainer.innerHTML = '<div class="settings-empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
        try {
            const categories = await callApi('/api/settings/categories');
            renderSettingsCategories(categories);
            state.loadedSections.add('settings');
        } catch (error) {
            els.settingsContainer.innerHTML = `<div class="settings-empty">${error.message}</div>`;
        }
    }

    function renderSettingsCategories(categories) {
        els.settingsContainer.innerHTML = '';
        if (!Array.isArray(categories) || !categories.length) {
            els.settingsContainer.innerHTML = '<div class="settings-empty">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫</div>';
            return;
        }
        categories.forEach((category) => {
            const details = document.createElement('details');
            details.className = 'setting-category';
            details.dataset.category = category.key;
            const summary = document.createElement('summary');
            summary.innerHTML = `<span>${category.label}</span><span class="settings-count">${category.count}</span>`;
            const itemsContainer = document.createElement('div');
            itemsContainer.className = 'setting-items';
            itemsContainer.innerHTML = '<div class="settings-empty">–û—Ç–∫—Ä–æ–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏‚Ä¶</div>';
            details.appendChild(summary);
            details.appendChild(itemsContainer);
            details.addEventListener('toggle', async () => {
                if (details.open && !state.settingsCache.has(category.key)) {
                    await loadSettingsCategory(category.key, itemsContainer);
                }
            });
            els.settingsContainer.appendChild(details);
        });
    }

    async function loadSettingsCategory(key, container) {
        container.innerHTML = '<div class="settings-empty">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
        try {
            const items = await callApi(`/api/settings/category/${key}`);
            state.settingsCache.set(key, items);
            renderSettingItems(key, items, container);
        } catch (error) {
            container.innerHTML = `<div class="settings-empty">${error.message}</div>`;
        }
    }

    function renderSettingItems(categoryKey, items, container) {
        if (!items.length) {
            container.innerHTML = '<div class="settings-empty">–ù–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>';
            return;
        }
        const fragment = document.createDocumentFragment();
        items.forEach((item) => {
            const row = document.createElement('div');
            row.className = 'setting-item';
            row.dataset.key = item.key;
            row.innerHTML = `
                <div>
                    <div class="setting-name">${item.name}</div>
                    <div class="setting-key">${item.key}</div>
                </div>
                <div class="setting-value">
                    <span>${item.value_formatted}</span>
                    ${item.has_override ? '<span class="setting-override">–ò–∑–º–µ–Ω–µ–Ω–æ</span>' : ''}
                </div>
                <div class="setting-actions">
                    <button class="setting-button" data-action="edit-setting" data-key="${item.key}" data-category="${categoryKey}">–ò–∑–º–µ–Ω–∏—Ç—å</button>
                    <button class="setting-button" data-action="reset-setting" data-key="${item.key}" data-category="${categoryKey}" ${item.has_override ? '' : 'disabled'}>–°–±—Ä–æ—Å–∏—Ç—å</button>
                </div>
            `;
            fragment.appendChild(row);
        });
        container.innerHTML = '';
        container.appendChild(fragment);
    }

    async function editSetting(key, category) {
        const items = state.settingsCache.get(category) || [];
        const item = items.find((entry) => entry.key === key);
        if (!item) return;
        const choices = item.choices || [];
        const hint = choices.length
            ? `\n–í–æ–∑–º–æ–∂–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:\n${choices.map((choice) => `‚Ä¢ ${choice.label} (${choice.value})`).join('\n')}`
            : '';
        const currentValue = item.value ?? '';
        const input = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è ¬´${item.name}¬ª${hint}`, currentValue);
        if (input === null) {
            return;
        }
        try {
            const payload = { value: input };
            if (input.trim().toLowerCase() === 'null' || input.trim() === '') {
                payload.value = null;
            }
            const updated = await callApi(`/api/settings/${key}`, { method: 'PUT', body: payload });
            showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
            state.settingsCache.delete(category);
            const details = els.settingsContainer.querySelector(`details[data-category="${category}"]`);
            if (details) {
                const itemsContainer = details.querySelector('.setting-items');
                await loadSettingsCategory(category, itemsContainer);
            }
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    async function resetSetting(key, category) {
        if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∫ –∑–Ω–∞—á–µ–Ω–∏—é –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?')) {
            return;
        }
        try {
            await callApi(`/api/settings/${key}`, { method: 'DELETE' });
            showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–±—Ä–æ—à–µ–Ω–∞', 'success');
            state.settingsCache.delete(category);
            const details = els.settingsContainer.querySelector(`details[data-category="${category}"]`);
            if (details) {
                const itemsContainer = details.querySelector('.setting-items');
                await loadSettingsCategory(category, itemsContainer);
            }
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    async function viewUser(userId) {
        try {
            const details = await callApi(`/api/users/${userId}`);
            const user = details.user;
            const transactions = details.transactions || [];
            const lastTransaction = transactions[0];
            const info = [
                `–ò–º—è: ${user.full_name}`,
                `–ë–∞–ª–∞–Ω—Å: ${toLocaleCurrency(user.balance_rub)}`,
                lastTransaction ? `–ü–æ—Å–ª–µ–¥–Ω—è—è –æ–ø–µ—Ä–∞—Ü–∏—è: ${toLocaleCurrency(lastTransaction.amount_rub)} (${new Date(lastTransaction.created_at).toLocaleString('ru-RU')})` : '–ü–æ—Å–ª–µ–¥–Ω—è—è –æ–ø–µ—Ä–∞—Ü–∏—è: ‚Äî',
            ].join('\n');
            alert(info);
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    async function refreshHealth() {
        const data = await callApi('/api/health');
        renderHealth(data);
    }

    async function loadAllData() {
        const sectionsToReload = new Set(state.loadedSections);
        sectionsToReload.add('dashboard');
        if (state.activeSection) {
            sectionsToReload.add(state.activeSection);
        }
        state.loadedSections.clear();
        await Promise.all(
            Array.from(sectionsToReload).map((sectionKey) => {
                const loader = sectionLoaders[sectionKey];
                return typeof loader === 'function' ? loader(true) : Promise.resolve();
            }),
        );
    }

    async function handleTransactionsAction(action, element) {
        switch (action) {
            case 'transactions-refresh':
                await loadTransactionsSection(true);
                showToast('–°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                break;
            case 'transactions-reset':
                state.transactions.search = '';
                state.transactions.type = '';
                state.transactions.status = '';
                state.transactions.payment = '';
                state.transactions.offset = 0;
                state.transactions.total = 0;
                state.transactions.summary = null;
                if (transactionsSearchTimeout) {
                    clearTimeout(transactionsSearchTimeout);
                    transactionsSearchTimeout = null;
                }
                if (els.transactionsSearchInput) {
                    els.transactionsSearchInput.value = '';
                }
                if (els.transactionsTypeFilter) {
                    els.transactionsTypeFilter.value = '';
                }
                if (els.transactionsStatusFilter) {
                    els.transactionsStatusFilter.value = '';
                }
                if (els.transactionsPaymentFilter) {
                    els.transactionsPaymentFilter.value = '';
                }
                if (els.transactionsPagination) {
                    els.transactionsPagination.innerHTML = '';
                }
                await loadTransactionsSection(true);
                showToast('–§–∏–ª—å—Ç—Ä—ã —Å–±—Ä–æ—à–µ–Ω—ã', 'success');
                break;
            case 'transactions-page': {
                if (!element) {
                    break;
                }
                const page = Number(element.dataset.page);
                if (!Number.isFinite(page)) {
                    break;
                }
                const limit = state.transactions.limit || 20;
                const safePage = Math.max(1, page);
                state.transactions.offset = Math.max(0, (safePage - 1) * limit);
                await loadTransactionsSection(true);
                break;
            }
            default:
                break;
        }
    }

    async function handleUsersAction(action, element) {
        switch (action) {
            case 'users-refresh':
                state.users.offset = 0;
                await loadUsersSection(true);
                showToast('–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                break;
            case 'users-page': {
                if (!element) break;
                const page = Number(element.dataset.page);
                if (!Number.isFinite(page)) break;
                const limit = state.users.limit || 20;
                const normalizedPage = Math.max(1, Math.floor(page));
                state.users.offset = Math.max(0, (normalizedPage - 1) * limit);
                await loadUsersSection(true);
                break;
            }
            case 'view-user': {
                const userId = Number(element?.dataset.userId);
                if (!Number.isFinite(userId) || userId <= 0) {
                    showToast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', 'error');
                    return;
                }
                await viewUser(userId);
                break;
            }
            default:
                break;
        }
    }

    async function handleRemnawaveAction(action, element) {
        switch (action) {
            case 'rw-refresh-overview':
                await loadRemnawaveOverview(true);
                showToast('–î–∞–Ω–Ω—ã–µ Remnawave –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                break;
            case 'rw-refresh-nodes':
                await loadRemnawaveNodes(true);
                showToast('–°–ø–∏—Å–æ–∫ –Ω–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                break;
            case 'rw-refresh-squads':
                await loadRemnawaveSquads(true);
                showToast('–°–ø–∏—Å–æ–∫ —Å–∫–≤–∞–¥–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                break;
            case 'rw-refresh-sync':
                await loadRemnawaveSync(true);
                showToast('–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                break;
            case 'rw-restart-all-nodes':
                if (!confirm('–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –Ω–æ–¥—ã Remnawave?')) return;
                await callApi('/api/remnawave/nodes/actions/restart-all', { method: 'POST' });
                showToast('–ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞', 'success');
                await loadRemnawaveNodes(true);
                break;
            case 'rw-node-action': {
                const nodeUuid = element?.dataset.node;
                const command = element?.dataset.command;
                if (!nodeUuid || !command) return;
                if (command === 'restart' && !confirm('–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –Ω–æ–¥—É?')) return;
                if (command === 'disable' && !confirm('–û—Ç–∫–ª—é—á–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –Ω–æ–¥—É?')) return;
                await callApi(`/api/remnawave/nodes/${encodeURIComponent(nodeUuid)}/action`, {
                    method: 'POST',
                    body: { action: command },
                });
                showToast('–ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞', 'success');
                await loadRemnawaveNodes(true);
                break;
            }
            case 'rw-node-details': {
                const nodeUuid = element?.dataset.node;
                if (!nodeUuid) return;
                const details = await callApi(`/api/remnawave/nodes/${encodeURIComponent(nodeUuid)}`);
                const message = typeof details === 'object' && details
                    ? Object.entries(details)
                        .map(([key, value]) => `${key}: ${typeof value === 'object' ? JSON.stringify(value) : value}`)
                        .join('\n') || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'
                    : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                alert(message);
                break;
            }
            case 'rw-create-squad': {
                const nameInput = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫–≤–∞–¥–∞');
                if (nameInput === null) return;
                const cleanName = nameInput.trim();
                if (!cleanName) {
                    showToast('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', 'error');
                    return;
                }
                const availableInbounds = (state.remnawave.inbounds || [])
                    .map((item) => item?.tag || item?.remark || item?.uuid || item?.id)
                    .filter(Boolean);
                const hint = availableInbounds.length
                    ? `\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω–±–∞—É–Ω–¥—ã: ${availableInbounds.join(', ')}`
                    : '';
                const inboundsInput = prompt(`–£–∫–∞–∂–∏—Ç–µ –∏–Ω–±–∞—É–Ω–¥—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é${hint}`, '');
                const inbounds = inboundsInput
                    ? inboundsInput
                        .split(',')
                        .map((value) => value.trim())
                        .filter(Boolean)
                    : [];
                await callApi('/api/remnawave/squads', {
                    method: 'POST',
                    body: { name: cleanName, inbounds },
                });
                showToast('–°–∫–≤–∞–¥ —Å–æ–∑–¥–∞–Ω', 'success');
                await loadRemnawaveSquads(true);
                break;
            }
            case 'rw-squad-rename': {
                const squadUuid = element?.dataset.squad;
                if (!squadUuid) return;
                const currentName = element?.dataset.name || '';
                const newNameInput = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫–≤–∞–¥–∞', currentName);
                if (newNameInput === null) return;
                const newName = newNameInput.trim();
                if (!newName) {
                    showToast('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', 'error');
                    return;
                }
                await callApi(`/api/remnawave/squads/${encodeURIComponent(squadUuid)}`, {
                    method: 'PUT',
                    body: { name: newName },
                });
                showToast('–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–≤–∞–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ', 'success');
                await loadRemnawaveSquads(true);
                break;
            }
            case 'rw-squad-inbounds': {
                const squadUuid = element?.dataset.squad;
                if (!squadUuid) return;
                const details = await callApi(`/api/remnawave/squads/${encodeURIComponent(squadUuid)}`);
                const current = Array.isArray(details?.inbounds) ? details.inbounds : [];
                const availableInbounds = (state.remnawave.inbounds || [])
                    .map((item) => item?.tag || item?.remark || item?.uuid || item?.id)
                    .filter(Boolean);
                const hint = availableInbounds.length
                    ? `\n–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω–±–∞—É–Ω–¥—ã: ${availableInbounds.join(', ')}`
                    : '';
                const input = prompt(`–í–≤–µ–¥–∏—Ç–µ –∏–Ω–±–∞—É–Ω–¥—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é${hint}`, current.join(', '));
                if (input === null) return;
                const inbounds = input
                    .split(',')
                    .map((value) => value.trim())
                    .filter(Boolean);
                await callApi(`/api/remnawave/squads/${encodeURIComponent(squadUuid)}`, {
                    method: 'PUT',
                    body: { inbounds },
                });
                showToast('–ò–Ω–±–∞—É–Ω–¥—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                await loadRemnawaveSquads(true);
                break;
            }
            case 'rw-squad-add-users':
            case 'rw-squad-remove-users': {
                const squadUuid = element?.dataset.squad;
                if (!squadUuid) return;
                const isAdd = action === 'rw-squad-add-users';
                const message = isAdd
                    ? '–î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —ç—Ç–æ—Ç —Å–∫–≤–∞–¥?'
                    : '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Å–∫–≤–∞–¥–∞?';
                if (!confirm(message)) return;
                const payload = { action: isAdd ? 'add_all_users' : 'remove_all_users' };
                await callApi(`/api/remnawave/squads/${encodeURIComponent(squadUuid)}/actions`, {
                    method: 'POST',
                    body: payload,
                });
                showToast('–ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞', 'success');
                await loadRemnawaveSquads(true);
                break;
            }
            case 'rw-squad-delete': {
                const squadUuid = element?.dataset.squad;
                if (!squadUuid) return;
                if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–∫–≤–∞–¥ –Ω–∞–≤—Å–µ–≥–¥–∞?')) return;
                await callApi(`/api/remnawave/squads/${encodeURIComponent(squadUuid)}`, { method: 'DELETE' });
                showToast('–°–∫–≤–∞–¥ —É–¥–∞–ª–µ–Ω', 'success');
                await loadRemnawaveSquads(true);
                break;
            }
            case 'rw-sync-run': {
                const syncAction = element?.dataset.syncAction;
                if (!syncAction) return;
                appendSyncLog(`–ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ¬´${syncAction}¬ª`, 'info');
                try {
                    const result = await callApi('/api/remnawave/sync', {
                        method: 'POST',
                        body: { action: syncAction },
                    });
                    const summary = typeof result?.result === 'object'
                        ? JSON.stringify(result.result)
                        : String(result?.result ?? '–≥–æ—Ç–æ–≤–æ');
                    appendSyncLog(`–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ${syncAction}: ${summary}`, 'success');
                    showToast('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
                    await loadRemnawaveSync(true);
                } catch (error) {
                    appendSyncLog(`–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ${syncAction}: ${error.message}`, 'error');
                    throw error;
                }
                break;
            }
            default:
                break;
        }
    }

    async function handleServerAction(action, element) {
        const serverId = Number(element?.dataset.server);
        if (['server-toggle', 'server-edit', 'server-promo', 'server-delete'].includes(action)) {
            if (!Number.isFinite(serverId) || serverId <= 0) {
                showToast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å–µ—Ä–≤–µ—Ä', 'error');
                return;
            }
        }
        switch (action) {
            case 'server-toggle': {
                const current = parseBoolean(element?.dataset.available);
                await callApi(`/api/servers/${serverId}`, {
                    method: 'PUT',
                    body: { is_available: !current },
                });
                showToast(current ? '–°–µ—Ä–≤–µ—Ä –æ—Ç–∫–ª—é—á–µ–Ω' : '–°–µ—Ä–≤–µ—Ä –≤–∫–ª—é—á–µ–Ω', 'success');
                await loadServersSection(true);
                break;
            }
            case 'server-edit': {
                const server = await callApi(`/api/servers/${serverId}`);
                const nameInput = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞', server?.name || server?.original_name || '');
                if (nameInput === null) return;
                const cleanName = nameInput.trim();
                if (!cleanName) {
                    showToast('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', 'error');
                    return;
                }
                const countryInput = prompt('–ö–æ–¥ —Å—Ç—Ä–∞–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, RU)', server?.country_code || '');
                if (countryInput === null) return;
                const priceInput = prompt('–¶–µ–Ω–∞ (–≤ —Ä—É–±–ª—è—Ö)', server?.price_rub ?? 0);
                if (priceInput === null) return;
                const maxUsersInput = prompt('–ú–∞–∫—Å–∏–º—É–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç–æ –¥–ª—è –±–µ–∑–ª–∏–º–∏—Ç–∞)', server?.max_users ?? '');
                if (maxUsersInput === null) return;
                const descriptionInput = prompt('–û–ø–∏—Å–∞–Ω–∏–µ', server?.description || '');
                if (descriptionInput === null) return;
                const payload = {
                    display_name: cleanName,
                    country_code: countryInput.trim(),
                    price_rub: priceInput.trim(),
                    description: descriptionInput.trim(),
                };
                if (maxUsersInput.trim() !== '') {
                    payload.max_users = maxUsersInput.trim();
                }
                await callApi(`/api/servers/${serverId}`, { method: 'PUT', body: payload });
                showToast('–°–µ—Ä–≤–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                await loadServersSection(true);
                break;
            }
            case 'server-promo': {
                const groups = await callApi('/api/promo-groups');
                const list = Array.isArray(groups)
                    ? groups
                        .map((group) => `${group.id}: ${group.name} (—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${group.members_count})`)
                        .join('\n')
                    : '';
                const promptMessage = list
                    ? `–í–≤–µ–¥–∏—Ç–µ ID –ø—Ä–æ–º–æ–≥—Ä—É–ø–ø —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é.\n${list}`
                    : '–í–≤–µ–¥–∏—Ç–µ ID –ø—Ä–æ–º–æ–≥—Ä—É–ø–ø —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é';
                const input = prompt(promptMessage, '');
                if (input === null) return;
                const ids = input
                    .split(',')
                    .map((value) => Number(value.trim()))
                    .filter((value) => Number.isFinite(value) && value > 0);
                if (!ids.length) {
                    showToast('–£–∫–∞–∂–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø—Ä–æ–º–æ–≥—Ä—É–ø–ø—É', 'error');
                    return;
                }
                await callApi(`/api/servers/${serverId}/promo-groups`, {
                    method: 'POST',
                    body: { promo_group_ids: ids },
                });
                showToast('–ü—Ä–æ–º–æ–≥—Ä—É–ø–ø—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                await loadServersSection(true);
                break;
            }
            case 'server-delete':
                if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.')) return;
                await callApi(`/api/servers/${serverId}`, { method: 'DELETE' });
                showToast('–°–µ—Ä–≤–µ—Ä —É–¥–∞–ª–µ–Ω', 'success');
                await loadServersSection(true);
                break;
            default:
                break;
        }
    }

    async function handlePromocodeAction(action, element) {
        switch (action) {
            case 'promocode-create': {
                const codeInput = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞');
                if (codeInput === null) return;
                const code = codeInput.trim().toUpperCase();
                if (!code) {
                    showToast('–ö–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', 'error');
                    return;
                }
                const typeInput = prompt('–¢–∏–ø –ø—Ä–æ–º–æ–∫–æ–¥–∞ (balance, subscription, traffic)', 'balance');
                if (typeInput === null) return;
                const bonusInput = prompt('–ë–æ–Ω—É—Å –Ω–∞ –±–∞–ª–∞–Ω—Å (—Ä—É–±)', '0');
                if (bonusInput === null) return;
                const daysInput = prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–æ–Ω—É—Å–Ω—ã—Ö –¥–Ω–µ–π –ø–æ–¥–ø–∏—Å–∫–∏', '0');
                if (daysInput === null) return;
                const maxUsesInput = prompt('–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π', '1');
                if (maxUsesInput === null) return;
                const payload = {
                    code,
                    type: typeInput.trim().toLowerCase(),
                    balance_bonus_rub: parseFloat(bonusInput.replace(',', '.')) || 0,
                    subscription_days: Number.parseInt(daysInput, 10) || 0,
                    max_uses: Math.max(1, Number.parseInt(maxUsesInput, 10) || 1),
                };
                await callApi('/api/promocodes', { method: 'POST', body: payload });
                showToast('–ü—Ä–æ–º–æ–∫–æ–¥ —Å–æ–∑–¥–∞–Ω', 'success');
                state.promocodes.offset = 0;
                await loadPromocodesSection(true);
                break;
            }
            case 'promocodes-refresh':
                await loadPromocodesSection(true);
                showToast('–°–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                break;
            case 'promocodes-page': {
                if (!element) break;
                const page = Number(element.dataset.page);
                if (!Number.isFinite(page)) break;
                const limit = state.promocodes.limit || 20;
                const normalizedPage = Math.max(1, Math.floor(page));
                state.promocodes.offset = Math.max(0, (normalizedPage - 1) * limit);
                await loadPromocodesSection(true);
                break;
            }
            case 'promocode-toggle': {
                const id = Number(element?.dataset.id);
                if (!Number.isFinite(id) || id <= 0) {
                    showToast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥', 'error');
                    return;
                }
                await callApi(`/api/promocodes/${id}/toggle`, { method: 'POST' });
                showToast('–°—Ç–∞—Ç—É—Å –ø—Ä–æ–º–æ–∫–æ–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                await loadPromocodesSection(true);
                break;
            }
            case 'promocode-edit': {
                const id = Number(element?.dataset.id);
                if (!Number.isFinite(id) || id <= 0) {
                    showToast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥', 'error');
                    return;
                }
                const promo = await callApi(`/api/promocodes/${id}`);
                const codeInput = prompt('–ö–æ–¥ –ø—Ä–æ–º–æ–∫–æ–¥–∞', promo?.code ?? '');
                if (codeInput === null) return;
                const typeInput = prompt('–¢–∏–ø –ø—Ä–æ–º–æ–∫–æ–¥–∞ (balance, subscription, traffic)', promo?.type ?? 'balance');
                if (typeInput === null) return;
                const bonusInput = prompt('–ë–æ–Ω—É—Å –Ω–∞ –±–∞–ª–∞–Ω—Å (—Ä—É–±)', String(promo?.balance_bonus_rub ?? 0));
                if (bonusInput === null) return;
                const daysInput = prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–æ–Ω—É—Å–Ω—ã—Ö –¥–Ω–µ–π –ø–æ–¥–ø–∏—Å–∫–∏', String(promo?.subscription_days ?? 0));
                if (daysInput === null) return;
                const maxUsesInput = prompt('–õ–∏–º–∏—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π', String(promo?.max_uses ?? 1));
                if (maxUsesInput === null) return;
                const validUntilInput = prompt('–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è (ISO 8601) –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º', promo?.valid_until ?? '');
                if (validUntilInput === null) return;
                const statusInput = prompt('–°—Ç–∞—Ç—É—Å (on/off)', promo?.is_active ? 'on' : 'off');
                if (statusInput === null) return;
                const payload = {
                    code: codeInput.trim().toUpperCase(),
                    type: typeInput.trim().toLowerCase(),
                    balance_bonus_rub: parseFloat((bonusInput || '0').replace(',', '.')) || 0,
                    subscription_days: Number.parseInt(daysInput, 10) || 0,
                    max_uses: Math.max(1, Number.parseInt(maxUsesInput, 10) || 1),
                    valid_until: validUntilInput.trim() || null,
                    is_active: parseBoolean(statusInput),
                };
                await callApi(`/api/promocodes/${id}`, { method: 'PUT', body: payload });
                showToast('–ü—Ä–æ–º–æ–∫–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                await loadPromocodesSection(true);
                break;
            }
            case 'promocode-delete': {
                const id = Number(element?.dataset.id);
                if (!Number.isFinite(id) || id <= 0) {
                    showToast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥', 'error');
                    return;
                }
                if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥?')) return;
                await callApi(`/api/promocodes/${id}`, { method: 'DELETE' });
                showToast('–ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª–µ–Ω', 'success');
                await loadPromocodesSection(true);
                break;
            }
            default:
                break;
        }
    }

    async function handleSupportAction(action, element) {
        switch (action) {
            case 'support-refresh':
                await loadSupportSection(true);
                showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                break;
            case 'support-toggle': {
                const key = element?.dataset.key;
                if (!key) return;
                const value = parseBoolean(element?.dataset.value ?? 'false');
                await callApi('/api/support/settings', {
                    method: 'PUT',
                    body: { [key]: value },
                });
                showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
                await loadSupportSection(true);
                break;
            }
            case 'support-set-sla': {
                const current = Number(element?.dataset.value || 0) || 0;
                const input = prompt('–í–≤–µ–¥–∏—Ç–µ SLA –≤ –º–∏–Ω—É—Ç–∞—Ö', current ? String(current) : '60');
                if (input === null) return;
                const minutes = Number.parseInt(input, 10);
                if (!Number.isFinite(minutes) || minutes <= 0) {
                    showToast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ SLA', 'error');
                    return;
                }
                await callApi('/api/support/settings', {
                    method: 'PUT',
                    body: { sla_minutes: minutes },
                });
                showToast('SLA –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                await loadSupportSection(true);
                break;
            }
            case 'support-add-moderator': {
                const input = prompt('–í–≤–µ–¥–∏—Ç–µ Telegram ID –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞');
                if (input === null) return;
                const moderatorId = Number.parseInt(input.trim(), 10);
                if (!Number.isFinite(moderatorId) || moderatorId <= 0) {
                    showToast('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Telegram ID', 'error');
                    return;
                }
                await callApi('/api/support/moderators', {
                    method: 'POST',
                    body: { telegram_id: moderatorId },
                });
                showToast('–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                await loadSupportSection(true);
                break;
            }
            case 'support-remove-moderator': {
                const moderatorId = element?.dataset.id;
                if (!moderatorId) return;
                if (!confirm('–£–¥–∞–ª–∏—Ç—å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞?')) return;
                await callApi(`/api/support/moderators/${encodeURIComponent(moderatorId)}`, { method: 'DELETE' });
                showToast('–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä —É–¥–∞–ª–µ–Ω', 'success');
                await loadSupportSection(true);
                break;
            }
            default:
                break;
        }
    }

    async function handleUpdatesAction(action) {
        if (action === 'updates-refresh') {
            const info = await callApi('/api/updates/check?force=true');
            showToast(info?.has_updates ? '–ù–∞–π–¥–µ–Ω—ã –Ω–æ–≤—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è' : '–û–±–Ω–æ–≤–ª–µ–Ω–∏–π –Ω–µ—Ç', 'success');
            await loadUpdatesSection(true);
        }
    }

    async function handleAction(action, element = null) {
        try {
            switch (action) {
                case 'refresh':
                    await loadAllData();
                    showToast('–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                    return;
                case 'refresh-users':
                    renderRecentUsers(await callApi('/api/users/recent?limit=8'));
                    showToast('–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                    return;
                case 'reload-config':
                    await callApi('/api/bot/control', { method: 'POST', body: { action: 'reload_configuration' } });
                    showToast('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
                    return;
                case 'create-backup':
                    await callApi('/api/bot/control', { method: 'POST', body: { action: 'create_backup' } });
                    showToast('–ó–∞–¥–∞—á–∞ –Ω–∞ –±–µ–∫–∞–ø —Å–æ–∑–¥–∞–Ω–∞', 'success');
                    return;
                case 'send-report':
                    await callApi('/api/bot/control', { method: 'POST', body: { action: 'send_daily_report' } });
                    showToast('–û—Ç—á–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω', 'success');
                    return;
                case 'toggle-maintenance':
                    if (state.health?.bot?.maintenance) {
                        await callApi('/api/bot/control', { method: 'POST', body: { action: 'disable_maintenance' } });
                    } else {
                        await callApi('/api/bot/control', { method: 'POST', body: { action: 'enable_maintenance' } });
                    }
                    showToast('–°—Ç–∞—Ç—É—Å —Ç–µ—Ö—Ä–∞–±–æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
                    await refreshHealth();
                    return;
                default:
                    break;
            }

            if (action.startsWith('transactions')) {
                await handleTransactionsAction(action, element);
                return;
            }
            if (action.startsWith('users') || action === 'view-user') {
                await handleUsersAction(action, element);
                return;
            }
            if (action.startsWith('rw-')) {
                await handleRemnawaveAction(action, element);
                return;
            }
            if (action.startsWith('server-')) {
                await handleServerAction(action, element);
                return;
            }
            if (action.startsWith('promocode') || action.startsWith('promocodes')) {
                await handlePromocodeAction(action, element);
                return;
            }
            if (action.startsWith('support-')) {
                await handleSupportAction(action, element);
                return;
            }
            if (action.startsWith('updates-')) {
                await handleUpdatesAction(action);
            }
        } catch (error) {
            showToast(error.message, 'error');
        }
    }

    function bindEvents() {
        els.loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const token = els.loginToken.value.trim();
            if (!token) {
                els.loginError.textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω';
                return;
            }
            try {
                await callApi('/api/auth/login', { method: 'POST', body: { token }, skipAuth: true });
                state.token = token;
                localStorage.setItem('webadminToken', token);
                hideLogin();
                await loadAllData();
            } catch (error) {
                els.loginError.textContent = error.message;
            }
        });

        document.addEventListener('click', (event) => {
            if (!els.botDropdown.contains(event.target) && !els.botControlBtn.contains(event.target)) {
                els.botDropdown.classList.remove('open');
            }
        });

        els.botControlBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            els.botDropdown.classList.toggle('open');
        });

        els.botDropdown.addEventListener('click', async (event) => {
            const target = event.target.closest('[data-action]');
            if (!target) return;
            const action = target.dataset.action;
            if (!action) return;
            els.botDropdown.classList.remove('open');
            if (action === 'logout') {
                state.token = '';
                state.activeSection = 'dashboard';
                state.loadedSections.clear();
                state.settingsCache.clear();
                state.syncLog = [];
                state.users.search = '';
                state.users.offset = 0;
                state.users.total = 0;
                state.transactions.search = '';
                state.transactions.type = '';
                state.transactions.status = '';
                state.transactions.payment = '';
                state.transactions.offset = 0;
                state.transactions.total = 0;
                state.transactions.summary = null;
                state.promocodes.offset = 0;
                state.promocodes.total = 0;
                state.remnawave.inbounds = [];
                renderSyncLog();
                if (els.usersSearchInput) {
                    els.usersSearchInput.value = '';
                }
                if (transactionsSearchTimeout) {
                    clearTimeout(transactionsSearchTimeout);
                    transactionsSearchTimeout = null;
                }
                if (els.transactionsSearchInput) {
                    els.transactionsSearchInput.value = '';
                }
                if (els.transactionsTypeFilter) {
                    els.transactionsTypeFilter.value = '';
                }
                if (els.transactionsStatusFilter) {
                    els.transactionsStatusFilter.value = '';
                }
                if (els.transactionsPaymentFilter) {
                    els.transactionsPaymentFilter.value = '';
                }
                if (els.transactionsTableBody) {
                    els.transactionsTableBody.innerHTML = '<tr><td colspan="6" style="padding: 32px; text-align: center; color: var(--text-tertiary);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                }
                if (els.transactionsPagination) {
                    els.transactionsPagination.innerHTML = '';
                }
                renderTransactionsSummary(null);
                els.navItems.forEach((item) => {
                    item.classList.toggle('active', item.dataset.sectionTarget === 'dashboard');
                });
                els.sections.forEach((section) => {
                    section.classList.toggle('active', section.dataset.section === 'dashboard');
                });
                localStorage.removeItem('webadminToken');
                showToast('–í—ã –≤—ã—à–ª–∏ –∏–∑ –ø–∞–Ω–µ–ª–∏', 'success');
                showLogin();
                return;
            }
            await handleAction(action, target);
        });

        els.navItems.forEach((item) => {
            item.addEventListener('click', async (event) => {
                event.preventDefault();
                const targetSection = item.dataset.sectionTarget;
                if (!targetSection) return;
                try {
                    await activateSection(targetSection);
                } catch (error) {
                    showToast(error.message, 'error');
                }
            });
        });

        if (els.usersSearchInput) {
            els.usersSearchInput.addEventListener('input', () => {
                state.users.search = els.usersSearchInput.value.trim();
                state.users.offset = 0;
                if (usersSearchTimeout) {
                    clearTimeout(usersSearchTimeout);
                }
                usersSearchTimeout = setTimeout(() => {
                    usersSearchTimeout = null;
                    loadUsersSection(true);
                }, 400);
            });
            els.usersSearchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    if (usersSearchTimeout) {
                        clearTimeout(usersSearchTimeout);
                        usersSearchTimeout = null;
                    }
                    loadUsersSection(true);
                }
            });
        }

        if (els.transactionsSearchInput) {
            els.transactionsSearchInput.addEventListener('input', () => {
                state.transactions.search = els.transactionsSearchInput.value.trim();
                state.transactions.offset = 0;
                if (transactionsSearchTimeout) {
                    clearTimeout(transactionsSearchTimeout);
                }
                transactionsSearchTimeout = setTimeout(() => {
                    transactionsSearchTimeout = null;
                    loadTransactionsSection(true);
                }, 400);
            });
            els.transactionsSearchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    if (transactionsSearchTimeout) {
                        clearTimeout(transactionsSearchTimeout);
                        transactionsSearchTimeout = null;
                    }
                    loadTransactionsSection(true);
                }
            });
        }

        [
            [els.transactionsTypeFilter, 'type'],
            [els.transactionsStatusFilter, 'status'],
            [els.transactionsPaymentFilter, 'payment'],
        ].forEach(([element, key]) => {
            if (!element) {
                return;
            }
            element.addEventListener('change', () => {
                state.transactions[key] = element.value;
                state.transactions.offset = 0;
                loadTransactionsSection(true);
            });
        });

        document.body.addEventListener('click', async (event) => {
            const target = event.target.closest('[data-action]');
            if (!target || target.closest('#bot-dropdown')) {
                return;
            }
            const action = target.dataset.action;
            if (!action || ['edit-setting', 'reset-setting'].includes(action)) {
                return;
            }
            if (target.tagName === 'A') {
                event.preventDefault();
            }
            if (target.tagName === 'BUTTON' && target.disabled) {
                return;
            }
            if (target.hasAttribute('disabled')) {
                return;
            }
            await handleAction(action, target);
        });

        els.settingsContainer.addEventListener('click', async (event) => {
            const target = event.target.closest('[data-action]');
            if (!target) return;
            const { action, key, category } = target.dataset;
            if (!key || !category) return;
            if (action === 'edit-setting') {
                await editSetting(key, category);
            } else if (action === 'reset-setting') {
                await resetSetting(key, category);
            }
        });
    }

    async function init() {
        bindEvents();
        if (state.token) {
            try {
                await loadAllData();
            } catch (error) {
                showToast(error.message, 'error');
                showLogin('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ö–æ–¥ –∑–∞–Ω–æ–≤–æ');
            }
        } else {
            showLogin();
        }
    }

    document.addEventListener('DOMContentLoaded', init);
})();
</script>
</body>
</html>
